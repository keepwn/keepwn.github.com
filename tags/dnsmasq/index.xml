<?xml version="1.0" encoding="utf-8" standalone="yes"?><rss version="2.0" xmlns:atom="http://www.w3.org/2005/Atom"><channel><title>Dnsmasq on KeePwn's Notes</title><link>https://www.keepwn.com/tags/dnsmasq/</link><description>Recent content in Dnsmasq on KeePwn's Notes</description><generator>Hugo -- gohugo.io</generator><language>en-us</language><lastBuildDate>Thu, 17 Oct 2024 15:20:53 +0000</lastBuildDate><atom:link href="https://www.keepwn.com/tags/dnsmasq/index.xml" rel="self" type="application/rss+xml"/><item><title>Openwrt上实现透明代理</title><link>https://www.keepwn.com/posts/see-the-big-world-on-openwrt/</link><pubDate>Wed, 28 Dec 2016 00:00:00 +0000</pubDate><guid>https://www.keepwn.com/posts/see-the-big-world-on-openwrt/</guid><description>&lt;h2 id="背景">背景
&lt;/h2>&lt;p>前一段时间，在ESXI上部署了一台Plex服务器。解决了一些恼人的问题后，用得还算满意，但是TMDb搜刮器在匹配电影信息时，总会丢失一些Poster海报信息。&lt;/p>
&lt;p>最终发现，&lt;a class="link" href="https://www.themoviedb.org" target="_blank" rel="noopener"
>The Movie Database (TMDb)&lt;/a> 这个地址被&lt;code>和谐社会&lt;/code>了。&lt;/p>
&lt;p>由于Plex不支持设置代理，且手动设置&lt;code>HTTP_PROXY&lt;/code>后还是无效，所以决定把Plex这台服务器加入透明代理网络中。&lt;/p>
&lt;blockquote>
&lt;p>参考以前的文章&lt;a class="link" href="https://www.keepwn.com/howto/route-traffic-selectively-by-domain-on-openwrt/" >《Openwrt上使用dnsmasq和ipset实现域名分流》&lt;/a>，将网关、DNS设置为&lt;code>192.168.0.254&lt;/code>&lt;/p>
&lt;/blockquote>
&lt;p>因为之前重新部署了ESXI环境，所以Openwrt这台虚拟机不幸丢失，所以只能&lt;code>大侠请重新来过&lt;/code>。&lt;/p>
&lt;p>由于之前的方案在实际使用中还有一些不足，在综合了网络上现有的一些方案后，设计出一份改进版的方案。&lt;/p>
&lt;!-- more -->
&lt;h2 id="网络上原始的方案">网络上原始的方案
&lt;/h2>&lt;h3 id="安装软件">安装软件
&lt;/h3>&lt;ul>
&lt;li>shadowsocks-libev和luci-app-shadowsocks（提供ss-rules）
&lt;ul>
&lt;li>依赖iptables-mod-tproxy和ip&lt;/li>
&lt;/ul>
&lt;/li>
&lt;li>chinadns和luci-app-chinadns&lt;/li>
&lt;/ul>
&lt;h3 id="配置">配置
&lt;/h3>&lt;ul>
&lt;li>使用luci-app配置shadowsocks
&lt;ul>
&lt;li>开启&lt;code>端口转发&lt;/code>，设置&lt;code>本地端口&lt;/code>为5300，用于DNS查询&lt;/li>
&lt;li>&lt;code>被忽略IP列表&lt;/code>选择ChinaDNS路由表（&lt;code>/etc/chinadns_chnroute.txt&lt;/code>）&lt;/li>
&lt;/ul>
&lt;/li>
&lt;li>使用luci-app配置ChinaDNS
&lt;ul>
&lt;li>设置&lt;code>本地端口&lt;/code>为5353&lt;/li>
&lt;li>设置&lt;code>上游服务器&lt;/code>为&lt;code>114.114.114.114,127.0.0.1:5300&lt;/code>&lt;/li>
&lt;/ul>
&lt;/li>
&lt;li>使用luci-app配置DHCP/DNS
&lt;ul>
&lt;li>设置&lt;code>DNS转发&lt;/code>为&lt;code>127.0.0.1#5353&lt;/code>&lt;/li>
&lt;li>勾选&lt;code>忽略解析文件&lt;/code>&lt;/li>
&lt;/ul>
&lt;/li>
&lt;/ul>
&lt;p>这样一来，你拥有了:&lt;/p>
&lt;ul>
&lt;li>一个无污染的DNS服务器，端口为53
&lt;ul>
&lt;li>国内DNS解析出国内IP，国外DNS解析出国外IP&lt;/li>
&lt;/ul>
&lt;/li>
&lt;li>一个透明代理的网关
&lt;ul>
&lt;li>如果请求IP在ChinaDNS路由表中，则走正常流量&lt;/li>
&lt;li>如果请求IP不在ChinaDNS路由表中，则走代理流量&lt;/li>
&lt;/ul>
&lt;/li>
&lt;/ul>
&lt;h2 id="改进版方案">改进版方案
&lt;/h2>&lt;p>尽管上面的方案已经能够实现透明代理，但是还有以下问题(附上解决方案)：&lt;/p>
&lt;ul>
&lt;li>在某些ISP下使用&lt;code>ss-tunnel&lt;/code>（即端口转发）不稳定, 导致DNS查询时间过长或超时
&lt;ul>
&lt;li>解决方案:
&lt;ul>
&lt;li>使用dnscrypt-proxy提供的DNS查询服务&lt;/li>
&lt;/ul>
&lt;/li>
&lt;/ul>
&lt;/li>
&lt;li>ChinaDNS有时会出现误判，导致访问国内站点时走代理
&lt;ul>
&lt;li>解决方案:
&lt;ul>
&lt;li>在dnsmasq中配置chinalist，指定国内域名使用国内DNS进行解析&lt;/li>
&lt;li>不在列表中的站点交由ChinaDNS判断&lt;/li>
&lt;/ul>
&lt;/li>
&lt;/ul>
&lt;/li>
&lt;li>只能定义强制走代理的IP，而不能是域名，维护起来比较麻烦
&lt;ul>
&lt;li>解决方案:
&lt;ul>
&lt;li>归功于ss-rules的实现，ipset集合&lt;code>ss_spec_dst_fw&lt;/code>中存放强制走代理的IP&lt;/li>
&lt;li>在dnsmasq中配置my-list(自定义域名)列表，将my-list的查询结果保存到&lt;code>ss_spec_dst_fw&lt;/code>中&lt;/li>
&lt;/ul>
&lt;/li>
&lt;/ul>
&lt;/li>
&lt;/ul>
&lt;h3 id="额外安装以下软件">额外安装以下软件:
&lt;/h3>&lt;ul>
&lt;li>安装dnsmasq-full
&lt;ul>
&lt;li>需要先卸载自带的dnsmasq&lt;/li>
&lt;/ul>
&lt;/li>
&lt;li>安装dnscrypt-proxy
&lt;ul>
&lt;li>提供安全不受污染的DNS服务器&lt;/li>
&lt;/ul>
&lt;/li>
&lt;/ul>
&lt;h3 id="更新配置">更新配置
&lt;/h3>&lt;ul>
&lt;li>使用luci-app配置shadowsocks
&lt;ul>
&lt;li>关闭&lt;code>端口转发&lt;/code>&lt;/li>
&lt;/ul>
&lt;/li>
&lt;li>配置dnscrypt-proxy
&lt;ul>
&lt;li>修改监听端口为&lt;code>127.0.0.1:5300&lt;/code>&lt;/li>
&lt;/ul>
&lt;/li>
&lt;li>配置dnsmasq
修改&lt;code>/etc/dnsmasq.conf&lt;/code>，在文末加入&lt;code>conf-dir=/etc/dnsmasq.d&lt;/code>:
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-bash" data-lang="bash">&lt;span class="line">&lt;span class="cl">&lt;span class="nb">echo&lt;/span> &lt;span class="s1">&amp;#39;conf-dir=/etc/dnsmasq.d&amp;#39;&lt;/span> &amp;gt;&amp;gt; /etc/dnsmasq.conf
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;/li>
&lt;/ul>
&lt;h3 id="定期维护">定期维护
&lt;/h3>&lt;p>以下脚本实现更新china-route、china-dns和my-list的功能:&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt"> 1
&lt;/span>&lt;span class="lnt"> 2
&lt;/span>&lt;span class="lnt"> 3
&lt;/span>&lt;span class="lnt"> 4
&lt;/span>&lt;span class="lnt"> 5
&lt;/span>&lt;span class="lnt"> 6
&lt;/span>&lt;span class="lnt"> 7
&lt;/span>&lt;span class="lnt"> 8
&lt;/span>&lt;span class="lnt"> 9
&lt;/span>&lt;span class="lnt">10
&lt;/span>&lt;span class="lnt">11
&lt;/span>&lt;span class="lnt">12
&lt;/span>&lt;span class="lnt">13
&lt;/span>&lt;span class="lnt">14
&lt;/span>&lt;span class="lnt">15
&lt;/span>&lt;span class="lnt">16
&lt;/span>&lt;span class="lnt">17
&lt;/span>&lt;span class="lnt">18
&lt;/span>&lt;span class="lnt">19
&lt;/span>&lt;span class="lnt">20
&lt;/span>&lt;span class="lnt">21
&lt;/span>&lt;span class="lnt">22
&lt;/span>&lt;span class="lnt">23
&lt;/span>&lt;span class="lnt">24
&lt;/span>&lt;span class="lnt">25
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-bash" data-lang="bash">&lt;span class="line">&lt;span class="cl">&lt;span class="cp">#!/bin/sh
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="cp">&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nv">DNS&lt;/span>&lt;span class="o">=&lt;/span>127.0.0.1#5300
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nv">IPSET&lt;/span>&lt;span class="o">=&lt;/span>ss_spec_dst_fw
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1"># update china route&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">curl &lt;span class="s1">&amp;#39;http://ftp.apnic.net/apnic/stats/apnic/delegated-apnic-latest&amp;#39;&lt;/span> &lt;span class="p">|&lt;/span> grep ipv4 &lt;span class="p">|&lt;/span> grep CN &lt;span class="p">|&lt;/span> awk -F&lt;span class="se">\|&lt;/span> &lt;span class="s1">&amp;#39;{ printf(&amp;#34;%s/%d\n&amp;#34;, $4, 32-log($5)/log(2)) }&amp;#39;&lt;/span> &amp;gt; china-route.txt
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1"># update china dns&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">wget --no-check-certificate -O china-route.txt https://raw.githubusercontent.com/felixonmars/dnsmasq-china-list/master/accelerated-domains.china.conf
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1"># update my list&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">cat my-list.txt &lt;span class="p">|&lt;/span> awk &lt;span class="s1">&amp;#39;{ printf(&amp;#34;server=/&amp;#34;$1&amp;#34;/&amp;#39;&lt;/span>&lt;span class="nv">$DNS&lt;/span>&lt;span class="s1">&amp;#39;\nipset=/&amp;#34;$1&amp;#34;/&amp;#39;&lt;/span>&lt;span class="nv">$IPSET&lt;/span>&lt;span class="s1">&amp;#39;\n&amp;#34;) }&amp;#39;&lt;/span> &lt;span class="c1"># &amp;gt; my-list.conf&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1"># copy updated files&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">cp china-list.conf /etc/dnsmasq.d/china-list.conf
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">cp my-list.conf /etc/dnsmasq.d/my-list.conf
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">cp china-route.txt /etc/chinadns_chnroute.txt
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1"># restart service&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">/etc/init.d/dnsmasq restart
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">/etc/init.d/chinadns restart
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">/etc/init.d/shadowsocks rules
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nb">echo&lt;/span> &lt;span class="s1">&amp;#39;updated success&amp;#39;&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>其中，my-list.txt中保存需要强制走代理的域名列表&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-txt" data-lang="txt">&lt;span class="line">&lt;span class="cl">ipip.net
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">mydomain.com
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>你需要定期执行这个脚本来对相关列表进行更新。&lt;/p>
&lt;h2 id="总结">总结
&lt;/h2>&lt;blockquote>
&lt;p>使用该方案的前提：&lt;/p>
&lt;ul>
&lt;li>设置PC的网关为openwrt的ip（如:192.168.0.254）&lt;/li>
&lt;li>设置PC的DNS为openwrt的ip（如:192.168.0.254）&lt;/li>
&lt;/ul>
&lt;/blockquote>
&lt;ul>
&lt;li>当PC端访问国内网站时
&lt;ul>
&lt;li>dnsmasq解析该域名，发现该域名在dnsmasq的china-list中，使用国内DNS进行解析，返回国内IP&lt;/li>
&lt;li>iptables检测到该IP在&lt;code>ss_spec_dst_bp&lt;/code>（即china-route）中，则直连访问&lt;/li>
&lt;/ul>
&lt;/li>
&lt;li>访问google.com
&lt;ul>
&lt;li>dnsmasq解析该域名，发现该域名不在dnsmasq的列表中，则交给ChinaDNS查询&lt;/li>
&lt;li>ChinaDNS解析出IP后，发现该IP不匹配china-route列表，则返回国外IP&lt;/li>
&lt;li>iptables检测到该IP不在&lt;code>ss_spec_dst_bp&lt;/code>中，则代理访问&lt;/li>
&lt;/ul>
&lt;/li>
&lt;li>访问mydomain.com
&lt;ul>
&lt;li>dnsmasq解析该域名，发现该域名在dnsmasq的my-list中，使用dnscrypt进行解析，返回IP，并将该IP加至&lt;code>ss_spec_dst_fw&lt;/code>中&lt;/li>
&lt;li>iptables检测到该IP在&lt;code>ss_spec_dst_fw&lt;/code>中，则代理访问。&lt;/li>
&lt;/ul>
&lt;/li>
&lt;/ul>
&lt;p>完:)&lt;/p></description></item><item><title>Openwrt上使用dnsmasq和ipset实现域名分流</title><link>https://www.keepwn.com/posts/route-traffic-selectively-by-domain-on-openwrt/</link><pubDate>Wed, 01 Jun 2016 00:00:00 +0000</pubDate><guid>https://www.keepwn.com/posts/route-traffic-selectively-by-domain-on-openwrt/</guid><description>&lt;h2 id="目标">目标
&lt;/h2>&lt;p>部署一台自动代理路由器，实现根据域名来自动设定直连或者代理，而我要做的只是设置PC的默认网关为主路由器（192.168.0.1）还是自动代理路由器（192.168.0.254）。&lt;/p>
&lt;h2 id="创建openwrt虚拟机">创建Openwrt虚拟机
&lt;/h2>&lt;p>系统版本&lt;/p>
&lt;ul>
&lt;li>主路由器 (ip: &lt;code>192.168.0.1&lt;/code>)&lt;/li>
&lt;li>ESXI 6.0U2&lt;/li>
&lt;li>Openwrt 15.05.1 (ip: &lt;code>192.168.0.254&lt;/code>，gateway: &lt;code>192.168.0.1&lt;/code>)&lt;/li>
&lt;/ul>
&lt;!-- more -->
&lt;p>Openwrt虚拟机的配置教程有很多，这里只针对ESXI版Openwrt可能会遇到的问题说明下：&lt;/p>
&lt;ul>
&lt;li>
&lt;p>在ESXI6上，&lt;code>openwrt_x86&lt;/code>每次启动时会大概率的出现卡死现象，表现为&lt;code>Kernel panic - not syncing: Attempted to kill init&lt;/code>。&lt;/p>
&lt;ul>
&lt;li>&lt;strong>解决办法&lt;/strong>：改用&lt;code>openwrt_x64&lt;/code>后正常。原因未知。&lt;/li>
&lt;/ul>
&lt;/li>
&lt;li>
&lt;p>在ESXI6上，在&lt;code>openwrt&lt;/code>上执行某些命令时，会被强制关机，表现为&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-fallback" data-lang="fallback">&lt;span class="line">&lt;span class="cl">来自 promote 的消息: The operation on the file &amp;#34;/vmfs/devices/deltadisks/17ad1ab5-openwrt-15. 05.1-x86-64-combined-ext4-s001.vmdk&amp;#34; failed (Bad address). The file system where disk &amp;#34;/vmfs /devices/deltadisks/17ad1ab5-openwrt-15.05.1-- x86-64-combined-ext4-s001.vmdk&amp;#34; resides is full. Select _Retry to attempt the operation again. Select Cancel to end the session.
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;ul>
&lt;li>&lt;strong>解决办法&lt;/strong>：在&lt;code>Vmware Fusion&lt;/code>中新建openwrt虚拟机（&lt;em>other/other linux 64, 256MB，虚拟机版本为11&lt;/em>），第一次启动后，关机导出为&lt;code>ova&lt;/code>，然后再导入到ESXI6中。具体原因未知。&lt;/li>
&lt;/ul>
&lt;/li>
&lt;/ul>
&lt;h2 id="安装软件">安装软件
&lt;/h2>&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;span class="lnt">3
&lt;/span>&lt;span class="lnt">4
&lt;/span>&lt;span class="lnt">5
&lt;/span>&lt;span class="lnt">6
&lt;/span>&lt;span class="lnt">7
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-shell" data-lang="shell">&lt;span class="line">&lt;span class="cl">opkg update
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">opkg remove dnsmasq
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">opkg install dnsmasq-full
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">opkg install ipset iptables-mod-nat-extra
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">wget http://x.x.x.x/shadowsocks-libev_2.4.6-1_x86_64.ipk
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">opkg install shadowsocks-libev_2.4.6-1_x86_64.ipk
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>&lt;em>PS&lt;/em>
在这里，安装官方版的shadowsocks，而不是openwrt spec版, 下载地址在&lt;a class="link" href="https://sourceforge.net/projects/openwrt-dist/files/shadowsocks-libev/" target="_blank" rel="noopener"
>这里&lt;/a>。&lt;/p>
&lt;p>&lt;em>PPS&lt;/em>
在这里，如果安装的顺序不同，可能会导致lib的依赖错误(至少在15.05.1上是这样)。使用&lt;code>ldd&lt;/code>命令，检查一下shadowsocks的依赖包是否正常。&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-shell" data-lang="shell">&lt;span class="line">&lt;span class="cl">ldd /usr/bin/ss-redir
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;h2 id="配置">配置
&lt;/h2>&lt;h3 id="配置shadowsocks">配置shadowsocks
&lt;/h3>&lt;p>配置&lt;code>/etc/shadowsocks.json&lt;/code>，格式如下：&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;span class="lnt">3
&lt;/span>&lt;span class="lnt">4
&lt;/span>&lt;span class="lnt">5
&lt;/span>&lt;span class="lnt">6
&lt;/span>&lt;span class="lnt">7
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-json" data-lang="json">&lt;span class="line">&lt;span class="cl">&lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nt">&amp;#34;server&amp;#34;&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="s2">&amp;#34;X.X.X.X&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nt">&amp;#34;server_port&amp;#34;&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="s2">&amp;#34;443&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nt">&amp;#34;password&amp;#34;&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="s2">&amp;#34;password&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nt">&amp;#34;local_port&amp;#34;&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="s2">&amp;#34;1080&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nt">&amp;#34;method&amp;#34;&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="s2">&amp;#34;aes-256-cfb&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>修改&lt;code>/etc/init.d/shadowsocks&lt;/code>，设置shadowsocks以&lt;code>Proxy Mode&lt;/code>模式启动，同时开启&lt;code>转发DNS请求&lt;/code>功能，上游DNS为&lt;code>8.8.8.8&lt;/code>：&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt"> 1
&lt;/span>&lt;span class="lnt"> 2
&lt;/span>&lt;span class="lnt"> 3
&lt;/span>&lt;span class="lnt"> 4
&lt;/span>&lt;span class="lnt"> 5
&lt;/span>&lt;span class="lnt"> 6
&lt;/span>&lt;span class="lnt"> 7
&lt;/span>&lt;span class="lnt"> 8
&lt;/span>&lt;span class="lnt"> 9
&lt;/span>&lt;span class="lnt">10
&lt;/span>&lt;span class="lnt">11
&lt;/span>&lt;span class="lnt">12
&lt;/span>&lt;span class="lnt">13
&lt;/span>&lt;span class="lnt">14
&lt;/span>&lt;span class="lnt">15
&lt;/span>&lt;span class="lnt">16
&lt;/span>&lt;span class="lnt">17
&lt;/span>&lt;span class="lnt">18
&lt;/span>&lt;span class="lnt">19
&lt;/span>&lt;span class="lnt">20
&lt;/span>&lt;span class="lnt">21
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-bash" data-lang="bash">&lt;span class="line">&lt;span class="cl">&lt;span class="cp">#!/bin/sh /etc/rc.common
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="cp">&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nv">START&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="m">95&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nv">SERVICE_USE_PID&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="m">1&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nv">SERVICE_WRITE_PID&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="m">1&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nv">SERVICE_DAEMONIZE&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="m">1&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nv">CONFIG&lt;/span>&lt;span class="o">=&lt;/span>/etc/shadowsocks.json
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">start&lt;span class="o">()&lt;/span> &lt;span class="o">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1">#service_start /usr/bin/ss-local -c $CONFIG -b 0.0.0.0&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> service_start /usr/bin/ss-redir -c &lt;span class="nv">$CONFIG&lt;/span> -b 0.0.0.0
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> service_start /usr/bin/ss-tunnel -c &lt;span class="nv">$CONFIG&lt;/span> -b 0.0.0.0 -l &lt;span class="m">5353&lt;/span> -L 8.8.8.8:53 -u
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="o">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">stop&lt;span class="o">()&lt;/span> &lt;span class="o">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1">#service_stop /usr/bin/ss-local&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> service_stop /usr/bin/ss-redir
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> service_stop /usr/bin/ss-tunnel
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="o">}&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>设置shadowsocks开机启动，并手动运行：&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-shell" data-lang="shell">&lt;span class="line">&lt;span class="cl">/etc/init.d/shadowsocks &lt;span class="nb">enable&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">/etc/init.d/shadowsocks start
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>到目前为止，你已经有了一个监听在1080端口的socks代理，和监听在5353端口的不受污染的DNS服务器&lt;/p>
&lt;h3 id="配置ipset">配置ipset
&lt;/h3>&lt;p>进入Luci界面-网络-防火墙-自定义规则，加入以下规则（最后的&lt;code>1080&lt;/code>是shadowsocks的本地端口，请酌情修改）：&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;span class="lnt">3
&lt;/span>&lt;span class="lnt">4
&lt;/span>&lt;span class="lnt">5
&lt;/span>&lt;span class="lnt">6
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-shell" data-lang="shell">&lt;span class="line">&lt;span class="cl">&lt;span class="c1">#创建名为gfwlist，格式为iphash的集合&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">ipset -N gfwlist iphash
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">#匹配gfwlist中ip的nat流量均被转发到shadowsocks端口&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">iptables -t nat -A PREROUTING -p tcp -m &lt;span class="nb">set&lt;/span> --match-set gfwlist dst -j REDIRECT --to-port &lt;span class="m">1080&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">#匹配gfwlist中ip的本机流量均被转发到shadowsocks端口&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">iptables -t nat -A OUTPUT -p tcp -m &lt;span class="nb">set&lt;/span> --match-set gfwlist dst -j REDIRECT --to-port &lt;span class="m">1080&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;h3 id="配置dnsmasq-full">配置dnsmasq-full
&lt;/h3>&lt;p>修改&lt;code>/etc/dnsmasq.conf&lt;/code>，在文末加入&lt;code>conf-dir=/etc/dnsmasq.d&lt;/code>：&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-shell" data-lang="shell">&lt;span class="line">&lt;span class="cl">&lt;span class="nb">echo&lt;/span> &lt;span class="s1">&amp;#39;conf-dir=/etc/dnsmasq.d&amp;#39;&lt;/span> &amp;gt;&amp;gt; /etc/dnsmasq.conf
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>新建目录&lt;code>/etc/dnsmasq.d&lt;/code>，生成&lt;code>dnsmasq_list.conf&lt;/code> 到该目录：&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;span class="lnt">3
&lt;/span>&lt;span class="lnt">4
&lt;/span>&lt;span class="lnt">5
&lt;/span>&lt;span class="lnt">6
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-shell" data-lang="shell">&lt;span class="line">&lt;span class="cl">git clone https://github.com/cokebar/gfwlist2dnsmasq.git
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nb">cd&lt;/span> gfwlist2dnsmasq
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">python2 gfwlist2dnsmasq.py
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">mkdir /etc/dnsmasq.d
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">cp dnsmasq_list.conf /etc/dnsmasq.d
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>其中，&lt;code>dnsmasq_list.conf&lt;/code>的格式为：&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;span class="lnt">3
&lt;/span>&lt;span class="lnt">4
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-ini" data-lang="ini">&lt;span class="line">&lt;span class="cl">&lt;span class="c1">#使用不受污染的DNS解析该域名,可以将此IP改为自己使用的DNS服务器&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="na">server&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="s">/google.com/127.0.0.1#5353&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">#将解析出来的IP保存到名为gfwlist的ipset表中&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="na">ipset&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="s">/google.com/gfwlist&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>你可以手动修改这个文件，你也可以使用&lt;code>gfwlist2dnsmasq.py&lt;/code>自动生成dnsmasq_list版的gfwlist列表。&lt;/p>
&lt;p>重新运行&lt;code>dnsmasq&lt;/code>，它将监听在本机&lt;code>53&lt;/code>端口上。&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-shell" data-lang="shell">&lt;span class="line">&lt;span class="cl">/etc/init.d/dnsmasq restart
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;h2 id="测试">测试
&lt;/h2>&lt;p>场景一&lt;/p>
&lt;ul>
&lt;li>PC端的默认网关设置为&lt;code>192.168.0.1&lt;/code>, DNS设置为&lt;code>192.168.0.1&lt;/code>
&lt;ul>
&lt;li>国内网站访问正常&lt;/li>
&lt;li>Google无法访问&lt;/li>
&lt;/ul>
&lt;/li>
&lt;/ul>
&lt;p>场景二&lt;/p>
&lt;ul>
&lt;li>PC端的默认网关设置为&lt;code>192.168.0.254&lt;/code>, DNS设置为&lt;code>192.168.0.254&lt;/code>
&lt;ul>
&lt;li>访问国内网站
&lt;ul>
&lt;li>dnsmasq解析该域名，发现该域名不在dnsmasq_list中，使用默认DNS服务器进行解析，正常访问。&lt;/li>
&lt;/ul>
&lt;/li>
&lt;li>访问Google
&lt;ul>
&lt;li>dnsmasq解析该域名，发现该域名在dnsmasq_list中，使用设置的安全DNS服务器进行解析，并将该IP加至gfwlist集合中，iptables匹配到规则，将流量转发到shadowsocks监听的端口，进行代理访问。&lt;/li>
&lt;/ul>
&lt;/li>
&lt;/ul>
&lt;/li>
&lt;/ul>
&lt;h2 id="参考">参考
&lt;/h2>&lt;ul>
&lt;li>&lt;a class="link" href="https://blog.sorz.org/p/openwrt-outwall/" target="_blank" rel="noopener"
>https://blog.sorz.org/p/openwrt-outwall/&lt;/a>&lt;/li>
&lt;li>&lt;a class="link" href="http://aenes.com/post/740.html" target="_blank" rel="noopener"
>http://aenes.com/post/740.html&lt;/a>&lt;/li>
&lt;li>&lt;a class="link" href="https://php-rmcr7.rhcloud.com/openwrt-fq/" target="_blank" rel="noopener"
>https://php-rmcr7.rhcloud.com/openwrt-fq/&lt;/a>&lt;/li>
&lt;li>&lt;a class="link" href="https://cokebar.info/archives/962/comment-page-2/#comments" target="_blank" rel="noopener"
>https://cokebar.info/archives/962/comment-page-2/#comments&lt;/a>&lt;/li>
&lt;/ul></description></item></channel></rss>