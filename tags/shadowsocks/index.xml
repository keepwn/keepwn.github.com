<?xml version="1.0" encoding="utf-8" standalone="yes"?>
<rss version="2.0" xmlns:atom="http://www.w3.org/2005/Atom">
    <channel>
        <title>Shadowsocks on KeePwn&#39;s Notes</title>
        <link>/tags/shadowsocks/</link>
        <description>Recent content in Shadowsocks on KeePwn&#39;s Notes</description>
        <generator>Hugo -- gohugo.io</generator>
        <language>en-us</language>
        <lastBuildDate>Wed, 16 Oct 2024 15:24:10 +0000</lastBuildDate><atom:link href="/tags/shadowsocks/index.xml" rel="self" type="application/rss+xml" /><item>
        <title>Openwrt上实现透明代理</title>
        <link>/posts/see-the-big-world-on-openwrt/</link>
        <pubDate>Wed, 28 Dec 2016 00:00:00 +0000</pubDate>
        
        <guid>/posts/see-the-big-world-on-openwrt/</guid>
        <description>&lt;h2 id=&#34;背景&#34;&gt;背景
&lt;/h2&gt;&lt;p&gt;前一段时间，在ESXI上部署了一台Plex服务器。解决了一些恼人的问题后，用得还算满意，但是TMDb搜刮器在匹配电影信息时，总会丢失一些Poster海报信息。&lt;/p&gt;
&lt;p&gt;最终发现，&lt;a class=&#34;link&#34; href=&#34;https://www.themoviedb.org&#34;  target=&#34;_blank&#34; rel=&#34;noopener&#34;
    &gt;The Movie Database (TMDb)&lt;/a&gt; 这个地址被&lt;code&gt;和谐社会&lt;/code&gt;了。&lt;/p&gt;
&lt;p&gt;由于Plex不支持设置代理，且手动设置&lt;code&gt;HTTP_PROXY&lt;/code&gt;后还是无效，所以决定把Plex这台服务器加入透明代理网络中。&lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;参考以前的文章&lt;a class=&#34;link&#34; href=&#34;/howto/route-traffic-selectively-by-domain-on-openwrt/&#34; &gt;《Openwrt上使用dnsmasq和ipset实现域名分流》&lt;/a&gt;，将网关、DNS设置为&lt;code&gt;192.168.0.254&lt;/code&gt;&lt;/p&gt;
&lt;/blockquote&gt;
&lt;p&gt;因为之前重新部署了ESXI环境，所以Openwrt这台虚拟机不幸丢失，所以只能&lt;code&gt;大侠请重新来过&lt;/code&gt;。&lt;/p&gt;
&lt;p&gt;由于之前的方案在实际使用中还有一些不足，在综合了网络上现有的一些方案后，设计出一份改进版的方案。&lt;/p&gt;
&lt;!-- more --&gt;
&lt;h2 id=&#34;网络上原始的方案&#34;&gt;网络上原始的方案
&lt;/h2&gt;&lt;h3 id=&#34;安装软件&#34;&gt;安装软件
&lt;/h3&gt;&lt;ul&gt;
&lt;li&gt;shadowsocks-libev和luci-app-shadowsocks（提供ss-rules）
&lt;ul&gt;
&lt;li&gt;依赖iptables-mod-tproxy和ip&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;li&gt;chinadns和luci-app-chinadns&lt;/li&gt;
&lt;/ul&gt;
&lt;h3 id=&#34;配置&#34;&gt;配置
&lt;/h3&gt;&lt;ul&gt;
&lt;li&gt;使用luci-app配置shadowsocks
&lt;ul&gt;
&lt;li&gt;开启&lt;code&gt;端口转发&lt;/code&gt;，设置&lt;code&gt;本地端口&lt;/code&gt;为5300，用于DNS查询&lt;/li&gt;
&lt;li&gt;&lt;code&gt;被忽略IP列表&lt;/code&gt;选择ChinaDNS路由表（&lt;code&gt;/etc/chinadns_chnroute.txt&lt;/code&gt;）&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;li&gt;使用luci-app配置ChinaDNS
&lt;ul&gt;
&lt;li&gt;设置&lt;code&gt;本地端口&lt;/code&gt;为5353&lt;/li&gt;
&lt;li&gt;设置&lt;code&gt;上游服务器&lt;/code&gt;为&lt;code&gt;114.114.114.114,127.0.0.1:5300&lt;/code&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;li&gt;使用luci-app配置DHCP/DNS
&lt;ul&gt;
&lt;li&gt;设置&lt;code&gt;DNS转发&lt;/code&gt;为&lt;code&gt;127.0.0.1#5353&lt;/code&gt;&lt;/li&gt;
&lt;li&gt;勾选&lt;code&gt;忽略解析文件&lt;/code&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;这样一来，你拥有了:&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;一个无污染的DNS服务器，端口为53
&lt;ul&gt;
&lt;li&gt;国内DNS解析出国内IP，国外DNS解析出国外IP&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;li&gt;一个透明代理的网关
&lt;ul&gt;
&lt;li&gt;如果请求IP在ChinaDNS路由表中，则走正常流量&lt;/li&gt;
&lt;li&gt;如果请求IP不在ChinaDNS路由表中，则走代理流量&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;/ul&gt;
&lt;h2 id=&#34;改进版方案&#34;&gt;改进版方案
&lt;/h2&gt;&lt;p&gt;尽管上面的方案已经能够实现透明代理，但是还有以下问题(附上解决方案)：&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;在某些ISP下使用&lt;code&gt;ss-tunnel&lt;/code&gt;（即端口转发）不稳定, 导致DNS查询时间过长或超时
&lt;ul&gt;
&lt;li&gt;解决方案:
&lt;ul&gt;
&lt;li&gt;使用dnscrypt-proxy提供的DNS查询服务&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;li&gt;ChinaDNS有时会出现误判，导致访问国内站点时走代理
&lt;ul&gt;
&lt;li&gt;解决方案:
&lt;ul&gt;
&lt;li&gt;在dnsmasq中配置chinalist，指定国内域名使用国内DNS进行解析&lt;/li&gt;
&lt;li&gt;不在列表中的站点交由ChinaDNS判断&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;li&gt;只能定义强制走代理的IP，而不能是域名，维护起来比较麻烦
&lt;ul&gt;
&lt;li&gt;解决方案:
&lt;ul&gt;
&lt;li&gt;归功于ss-rules的实现，ipset集合&lt;code&gt;ss_spec_dst_fw&lt;/code&gt;中存放强制走代理的IP&lt;/li&gt;
&lt;li&gt;在dnsmasq中配置my-list(自定义域名)列表，将my-list的查询结果保存到&lt;code&gt;ss_spec_dst_fw&lt;/code&gt;中&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;/ul&gt;
&lt;h3 id=&#34;额外安装以下软件&#34;&gt;额外安装以下软件:
&lt;/h3&gt;&lt;ul&gt;
&lt;li&gt;安装dnsmasq-full
&lt;ul&gt;
&lt;li&gt;需要先卸载自带的dnsmasq&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;li&gt;安装dnscrypt-proxy
&lt;ul&gt;
&lt;li&gt;提供安全不受污染的DNS服务器&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;/ul&gt;
&lt;h3 id=&#34;更新配置&#34;&gt;更新配置
&lt;/h3&gt;&lt;ul&gt;
&lt;li&gt;使用luci-app配置shadowsocks
&lt;ul&gt;
&lt;li&gt;关闭&lt;code&gt;端口转发&lt;/code&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;li&gt;配置dnscrypt-proxy
&lt;ul&gt;
&lt;li&gt;修改监听端口为&lt;code&gt;127.0.0.1:5300&lt;/code&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;li&gt;配置dnsmasq
修改&lt;code&gt;/etc/dnsmasq.conf&lt;/code&gt;，在文末加入&lt;code&gt;conf-dir=/etc/dnsmasq.d&lt;/code&gt;:
&lt;div class=&#34;highlight&#34;&gt;&lt;div class=&#34;chroma&#34;&gt;
&lt;table class=&#34;lntable&#34;&gt;&lt;tr&gt;&lt;td class=&#34;lntd&#34;&gt;
&lt;pre tabindex=&#34;0&#34; class=&#34;chroma&#34;&gt;&lt;code&gt;&lt;span class=&#34;lnt&#34;&gt;1
&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/td&gt;
&lt;td class=&#34;lntd&#34;&gt;
&lt;pre tabindex=&#34;0&#34; class=&#34;chroma&#34;&gt;&lt;code class=&#34;language-bash&#34; data-lang=&#34;bash&#34;&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;nb&#34;&gt;echo&lt;/span&gt; &lt;span class=&#34;s1&#34;&gt;&amp;#39;conf-dir=/etc/dnsmasq.d&amp;#39;&lt;/span&gt; &amp;gt;&amp;gt; /etc/dnsmasq.conf
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;
&lt;/div&gt;
&lt;/div&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;h3 id=&#34;定期维护&#34;&gt;定期维护
&lt;/h3&gt;&lt;p&gt;以下脚本实现更新china-route、china-dns和my-list的功能:&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;div class=&#34;chroma&#34;&gt;
&lt;table class=&#34;lntable&#34;&gt;&lt;tr&gt;&lt;td class=&#34;lntd&#34;&gt;
&lt;pre tabindex=&#34;0&#34; class=&#34;chroma&#34;&gt;&lt;code&gt;&lt;span class=&#34;lnt&#34;&gt; 1
&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt; 2
&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt; 3
&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt; 4
&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt; 5
&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt; 6
&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt; 7
&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt; 8
&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt; 9
&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt;10
&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt;11
&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt;12
&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt;13
&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt;14
&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt;15
&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt;16
&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt;17
&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt;18
&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt;19
&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt;20
&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt;21
&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt;22
&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt;23
&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt;24
&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt;25
&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/td&gt;
&lt;td class=&#34;lntd&#34;&gt;
&lt;pre tabindex=&#34;0&#34; class=&#34;chroma&#34;&gt;&lt;code class=&#34;language-bash&#34; data-lang=&#34;bash&#34;&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;cp&#34;&gt;#!/bin/sh
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;cp&#34;&gt;&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;nv&#34;&gt;DNS&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;=&lt;/span&gt;127.0.0.1#5300
&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;nv&#34;&gt;IPSET&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;=&lt;/span&gt;ss_spec_dst_fw
&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;c1&#34;&gt;# update china route&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;curl &lt;span class=&#34;s1&#34;&gt;&amp;#39;http://ftp.apnic.net/apnic/stats/apnic/delegated-apnic-latest&amp;#39;&lt;/span&gt; &lt;span class=&#34;p&#34;&gt;|&lt;/span&gt; grep ipv4 &lt;span class=&#34;p&#34;&gt;|&lt;/span&gt; grep CN &lt;span class=&#34;p&#34;&gt;|&lt;/span&gt; awk -F&lt;span class=&#34;se&#34;&gt;\|&lt;/span&gt; &lt;span class=&#34;s1&#34;&gt;&amp;#39;{ printf(&amp;#34;%s/%d\n&amp;#34;, $4, 32-log($5)/log(2))  }&amp;#39;&lt;/span&gt; &amp;gt; china-route.txt
&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;c1&#34;&gt;# update china dns&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;wget --no-check-certificate -O china-route.txt https://raw.githubusercontent.com/felixonmars/dnsmasq-china-list/master/accelerated-domains.china.conf
&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;c1&#34;&gt;# update my list&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;cat my-list.txt &lt;span class=&#34;p&#34;&gt;|&lt;/span&gt; awk &lt;span class=&#34;s1&#34;&gt;&amp;#39;{ printf(&amp;#34;server=/&amp;#34;$1&amp;#34;/&amp;#39;&lt;/span&gt;&lt;span class=&#34;nv&#34;&gt;$DNS&lt;/span&gt;&lt;span class=&#34;s1&#34;&gt;&amp;#39;\nipset=/&amp;#34;$1&amp;#34;/&amp;#39;&lt;/span&gt;&lt;span class=&#34;nv&#34;&gt;$IPSET&lt;/span&gt;&lt;span class=&#34;s1&#34;&gt;&amp;#39;\n&amp;#34;)  }&amp;#39;&lt;/span&gt; &lt;span class=&#34;c1&#34;&gt;# &amp;gt; my-list.conf&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;c1&#34;&gt;# copy updated files&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;cp china-list.conf /etc/dnsmasq.d/china-list.conf
&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;cp my-list.conf /etc/dnsmasq.d/my-list.conf
&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;cp china-route.txt /etc/chinadns_chnroute.txt
&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;c1&#34;&gt;# restart service&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;/etc/init.d/dnsmasq restart
&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;/etc/init.d/chinadns restart
&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;/etc/init.d/shadowsocks rules
&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;nb&#34;&gt;echo&lt;/span&gt; &lt;span class=&#34;s1&#34;&gt;&amp;#39;updated success&amp;#39;&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;
&lt;/div&gt;
&lt;/div&gt;&lt;p&gt;其中，my-list.txt中保存需要强制走代理的域名列表&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;div class=&#34;chroma&#34;&gt;
&lt;table class=&#34;lntable&#34;&gt;&lt;tr&gt;&lt;td class=&#34;lntd&#34;&gt;
&lt;pre tabindex=&#34;0&#34; class=&#34;chroma&#34;&gt;&lt;code&gt;&lt;span class=&#34;lnt&#34;&gt;1
&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt;2
&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/td&gt;
&lt;td class=&#34;lntd&#34;&gt;
&lt;pre tabindex=&#34;0&#34; class=&#34;chroma&#34;&gt;&lt;code class=&#34;language-txt&#34; data-lang=&#34;txt&#34;&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;ipip.net
&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;mydomain.com
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;
&lt;/div&gt;
&lt;/div&gt;&lt;p&gt;你需要定期执行这个脚本来对相关列表进行更新。&lt;/p&gt;
&lt;h2 id=&#34;总结&#34;&gt;总结
&lt;/h2&gt;&lt;blockquote&gt;
&lt;p&gt;使用该方案的前提：&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;设置PC的网关为openwrt的ip（如:192.168.0.254）&lt;/li&gt;
&lt;li&gt;设置PC的DNS为openwrt的ip（如:192.168.0.254）&lt;/li&gt;
&lt;/ul&gt;
&lt;/blockquote&gt;
&lt;ul&gt;
&lt;li&gt;当PC端访问国内网站时
&lt;ul&gt;
&lt;li&gt;dnsmasq解析该域名，发现该域名在dnsmasq的china-list中，使用国内DNS进行解析，返回国内IP&lt;/li&gt;
&lt;li&gt;iptables检测到该IP在&lt;code&gt;ss_spec_dst_bp&lt;/code&gt;（即china-route）中，则直连访问&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;li&gt;访问google.com
&lt;ul&gt;
&lt;li&gt;dnsmasq解析该域名，发现该域名不在dnsmasq的列表中，则交给ChinaDNS查询&lt;/li&gt;
&lt;li&gt;ChinaDNS解析出IP后，发现该IP不匹配china-route列表，则返回国外IP&lt;/li&gt;
&lt;li&gt;iptables检测到该IP不在&lt;code&gt;ss_spec_dst_bp&lt;/code&gt;中，则代理访问&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;li&gt;访问mydomain.com
&lt;ul&gt;
&lt;li&gt;dnsmasq解析该域名，发现该域名在dnsmasq的my-list中，使用dnscrypt进行解析，返回IP，并将该IP加至&lt;code&gt;ss_spec_dst_fw&lt;/code&gt;中&lt;/li&gt;
&lt;li&gt;iptables检测到该IP在&lt;code&gt;ss_spec_dst_fw&lt;/code&gt;中，则代理访问。&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;完:)&lt;/p&gt;
</description>
        </item>
        
    </channel>
</rss>
