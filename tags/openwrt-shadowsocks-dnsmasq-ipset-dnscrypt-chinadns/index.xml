<?xml version="1.0" encoding="utf-8" standalone="yes"?><rss version="2.0" xmlns:atom="http://www.w3.org/2005/Atom"><channel><title>Openwrt Shadowsocks Dnsmasq Ipset Dnscrypt Chinadns on KeePwn's Notes</title><link>https://www.keepwn.com/tags/openwrt-shadowsocks-dnsmasq-ipset-dnscrypt-chinadns/</link><description>Recent content in Openwrt Shadowsocks Dnsmasq Ipset Dnscrypt Chinadns on KeePwn's Notes</description><generator>Hugo -- gohugo.io</generator><language>en-us</language><lastBuildDate>Wed, 16 Oct 2024 15:24:10 +0000</lastBuildDate><atom:link href="https://www.keepwn.com/tags/openwrt-shadowsocks-dnsmasq-ipset-dnscrypt-chinadns/index.xml" rel="self" type="application/rss+xml"/><item><title>Openwrt上实现透明代理</title><link>https://www.keepwn.com/posts/see-the-big-world-on-openwrt/</link><pubDate>Wed, 28 Dec 2016 00:00:00 +0000</pubDate><guid>https://www.keepwn.com/posts/see-the-big-world-on-openwrt/</guid><description>&lt;h2 id="背景">背景
&lt;/h2>&lt;p>前一段时间，在ESXI上部署了一台Plex服务器。解决了一些恼人的问题后，用得还算满意，但是TMDb搜刮器在匹配电影信息时，总会丢失一些Poster海报信息。&lt;/p>
&lt;p>最终发现，&lt;a class="link" href="https://www.themoviedb.org" target="_blank" rel="noopener"
>The Movie Database (TMDb)&lt;/a> 这个地址被&lt;code>和谐社会&lt;/code>了。&lt;/p>
&lt;p>由于Plex不支持设置代理，且手动设置&lt;code>HTTP_PROXY&lt;/code>后还是无效，所以决定把Plex这台服务器加入透明代理网络中。&lt;/p>
&lt;blockquote>
&lt;p>参考以前的文章&lt;a class="link" href="https://www.keepwn.com/howto/route-traffic-selectively-by-domain-on-openwrt/" >《Openwrt上使用dnsmasq和ipset实现域名分流》&lt;/a>，将网关、DNS设置为&lt;code>192.168.0.254&lt;/code>&lt;/p>
&lt;/blockquote>
&lt;p>因为之前重新部署了ESXI环境，所以Openwrt这台虚拟机不幸丢失，所以只能&lt;code>大侠请重新来过&lt;/code>。&lt;/p>
&lt;p>由于之前的方案在实际使用中还有一些不足，在综合了网络上现有的一些方案后，设计出一份改进版的方案。&lt;/p>
&lt;!-- more -->
&lt;h2 id="网络上原始的方案">网络上原始的方案
&lt;/h2>&lt;h3 id="安装软件">安装软件
&lt;/h3>&lt;ul>
&lt;li>shadowsocks-libev和luci-app-shadowsocks（提供ss-rules）
&lt;ul>
&lt;li>依赖iptables-mod-tproxy和ip&lt;/li>
&lt;/ul>
&lt;/li>
&lt;li>chinadns和luci-app-chinadns&lt;/li>
&lt;/ul>
&lt;h3 id="配置">配置
&lt;/h3>&lt;ul>
&lt;li>使用luci-app配置shadowsocks
&lt;ul>
&lt;li>开启&lt;code>端口转发&lt;/code>，设置&lt;code>本地端口&lt;/code>为5300，用于DNS查询&lt;/li>
&lt;li>&lt;code>被忽略IP列表&lt;/code>选择ChinaDNS路由表（&lt;code>/etc/chinadns_chnroute.txt&lt;/code>）&lt;/li>
&lt;/ul>
&lt;/li>
&lt;li>使用luci-app配置ChinaDNS
&lt;ul>
&lt;li>设置&lt;code>本地端口&lt;/code>为5353&lt;/li>
&lt;li>设置&lt;code>上游服务器&lt;/code>为&lt;code>114.114.114.114,127.0.0.1:5300&lt;/code>&lt;/li>
&lt;/ul>
&lt;/li>
&lt;li>使用luci-app配置DHCP/DNS
&lt;ul>
&lt;li>设置&lt;code>DNS转发&lt;/code>为&lt;code>127.0.0.1#5353&lt;/code>&lt;/li>
&lt;li>勾选&lt;code>忽略解析文件&lt;/code>&lt;/li>
&lt;/ul>
&lt;/li>
&lt;/ul>
&lt;p>这样一来，你拥有了:&lt;/p>
&lt;ul>
&lt;li>一个无污染的DNS服务器，端口为53
&lt;ul>
&lt;li>国内DNS解析出国内IP，国外DNS解析出国外IP&lt;/li>
&lt;/ul>
&lt;/li>
&lt;li>一个透明代理的网关
&lt;ul>
&lt;li>如果请求IP在ChinaDNS路由表中，则走正常流量&lt;/li>
&lt;li>如果请求IP不在ChinaDNS路由表中，则走代理流量&lt;/li>
&lt;/ul>
&lt;/li>
&lt;/ul>
&lt;h2 id="改进版方案">改进版方案
&lt;/h2>&lt;p>尽管上面的方案已经能够实现透明代理，但是还有以下问题(附上解决方案)：&lt;/p>
&lt;ul>
&lt;li>在某些ISP下使用&lt;code>ss-tunnel&lt;/code>（即端口转发）不稳定, 导致DNS查询时间过长或超时
&lt;ul>
&lt;li>解决方案:
&lt;ul>
&lt;li>使用dnscrypt-proxy提供的DNS查询服务&lt;/li>
&lt;/ul>
&lt;/li>
&lt;/ul>
&lt;/li>
&lt;li>ChinaDNS有时会出现误判，导致访问国内站点时走代理
&lt;ul>
&lt;li>解决方案:
&lt;ul>
&lt;li>在dnsmasq中配置chinalist，指定国内域名使用国内DNS进行解析&lt;/li>
&lt;li>不在列表中的站点交由ChinaDNS判断&lt;/li>
&lt;/ul>
&lt;/li>
&lt;/ul>
&lt;/li>
&lt;li>只能定义强制走代理的IP，而不能是域名，维护起来比较麻烦
&lt;ul>
&lt;li>解决方案:
&lt;ul>
&lt;li>归功于ss-rules的实现，ipset集合&lt;code>ss_spec_dst_fw&lt;/code>中存放强制走代理的IP&lt;/li>
&lt;li>在dnsmasq中配置my-list(自定义域名)列表，将my-list的查询结果保存到&lt;code>ss_spec_dst_fw&lt;/code>中&lt;/li>
&lt;/ul>
&lt;/li>
&lt;/ul>
&lt;/li>
&lt;/ul>
&lt;h3 id="额外安装以下软件">额外安装以下软件:
&lt;/h3>&lt;ul>
&lt;li>安装dnsmasq-full
&lt;ul>
&lt;li>需要先卸载自带的dnsmasq&lt;/li>
&lt;/ul>
&lt;/li>
&lt;li>安装dnscrypt-proxy
&lt;ul>
&lt;li>提供安全不受污染的DNS服务器&lt;/li>
&lt;/ul>
&lt;/li>
&lt;/ul>
&lt;h3 id="更新配置">更新配置
&lt;/h3>&lt;ul>
&lt;li>使用luci-app配置shadowsocks
&lt;ul>
&lt;li>关闭&lt;code>端口转发&lt;/code>&lt;/li>
&lt;/ul>
&lt;/li>
&lt;li>配置dnscrypt-proxy
&lt;ul>
&lt;li>修改监听端口为&lt;code>127.0.0.1:5300&lt;/code>&lt;/li>
&lt;/ul>
&lt;/li>
&lt;li>配置dnsmasq
修改&lt;code>/etc/dnsmasq.conf&lt;/code>，在文末加入&lt;code>conf-dir=/etc/dnsmasq.d&lt;/code>:
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-bash" data-lang="bash">&lt;span class="line">&lt;span class="cl">&lt;span class="nb">echo&lt;/span> &lt;span class="s1">&amp;#39;conf-dir=/etc/dnsmasq.d&amp;#39;&lt;/span> &amp;gt;&amp;gt; /etc/dnsmasq.conf
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;/li>
&lt;/ul>
&lt;h3 id="定期维护">定期维护
&lt;/h3>&lt;p>以下脚本实现更新china-route、china-dns和my-list的功能:&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt"> 1
&lt;/span>&lt;span class="lnt"> 2
&lt;/span>&lt;span class="lnt"> 3
&lt;/span>&lt;span class="lnt"> 4
&lt;/span>&lt;span class="lnt"> 5
&lt;/span>&lt;span class="lnt"> 6
&lt;/span>&lt;span class="lnt"> 7
&lt;/span>&lt;span class="lnt"> 8
&lt;/span>&lt;span class="lnt"> 9
&lt;/span>&lt;span class="lnt">10
&lt;/span>&lt;span class="lnt">11
&lt;/span>&lt;span class="lnt">12
&lt;/span>&lt;span class="lnt">13
&lt;/span>&lt;span class="lnt">14
&lt;/span>&lt;span class="lnt">15
&lt;/span>&lt;span class="lnt">16
&lt;/span>&lt;span class="lnt">17
&lt;/span>&lt;span class="lnt">18
&lt;/span>&lt;span class="lnt">19
&lt;/span>&lt;span class="lnt">20
&lt;/span>&lt;span class="lnt">21
&lt;/span>&lt;span class="lnt">22
&lt;/span>&lt;span class="lnt">23
&lt;/span>&lt;span class="lnt">24
&lt;/span>&lt;span class="lnt">25
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-bash" data-lang="bash">&lt;span class="line">&lt;span class="cl">&lt;span class="cp">#!/bin/sh
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="cp">&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nv">DNS&lt;/span>&lt;span class="o">=&lt;/span>127.0.0.1#5300
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nv">IPSET&lt;/span>&lt;span class="o">=&lt;/span>ss_spec_dst_fw
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1"># update china route&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">curl &lt;span class="s1">&amp;#39;http://ftp.apnic.net/apnic/stats/apnic/delegated-apnic-latest&amp;#39;&lt;/span> &lt;span class="p">|&lt;/span> grep ipv4 &lt;span class="p">|&lt;/span> grep CN &lt;span class="p">|&lt;/span> awk -F&lt;span class="se">\|&lt;/span> &lt;span class="s1">&amp;#39;{ printf(&amp;#34;%s/%d\n&amp;#34;, $4, 32-log($5)/log(2)) }&amp;#39;&lt;/span> &amp;gt; china-route.txt
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1"># update china dns&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">wget --no-check-certificate -O china-route.txt https://raw.githubusercontent.com/felixonmars/dnsmasq-china-list/master/accelerated-domains.china.conf
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1"># update my list&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">cat my-list.txt &lt;span class="p">|&lt;/span> awk &lt;span class="s1">&amp;#39;{ printf(&amp;#34;server=/&amp;#34;$1&amp;#34;/&amp;#39;&lt;/span>&lt;span class="nv">$DNS&lt;/span>&lt;span class="s1">&amp;#39;\nipset=/&amp;#34;$1&amp;#34;/&amp;#39;&lt;/span>&lt;span class="nv">$IPSET&lt;/span>&lt;span class="s1">&amp;#39;\n&amp;#34;) }&amp;#39;&lt;/span> &lt;span class="c1"># &amp;gt; my-list.conf&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1"># copy updated files&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">cp china-list.conf /etc/dnsmasq.d/china-list.conf
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">cp my-list.conf /etc/dnsmasq.d/my-list.conf
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">cp china-route.txt /etc/chinadns_chnroute.txt
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1"># restart service&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">/etc/init.d/dnsmasq restart
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">/etc/init.d/chinadns restart
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">/etc/init.d/shadowsocks rules
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nb">echo&lt;/span> &lt;span class="s1">&amp;#39;updated success&amp;#39;&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>其中，my-list.txt中保存需要强制走代理的域名列表&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-txt" data-lang="txt">&lt;span class="line">&lt;span class="cl">ipip.net
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">mydomain.com
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>你需要定期执行这个脚本来对相关列表进行更新。&lt;/p>
&lt;h2 id="总结">总结
&lt;/h2>&lt;blockquote>
&lt;p>使用该方案的前提：&lt;/p>
&lt;ul>
&lt;li>设置PC的网关为openwrt的ip（如:192.168.0.254）&lt;/li>
&lt;li>设置PC的DNS为openwrt的ip（如:192.168.0.254）&lt;/li>
&lt;/ul>
&lt;/blockquote>
&lt;ul>
&lt;li>当PC端访问国内网站时
&lt;ul>
&lt;li>dnsmasq解析该域名，发现该域名在dnsmasq的china-list中，使用国内DNS进行解析，返回国内IP&lt;/li>
&lt;li>iptables检测到该IP在&lt;code>ss_spec_dst_bp&lt;/code>（即china-route）中，则直连访问&lt;/li>
&lt;/ul>
&lt;/li>
&lt;li>访问google.com
&lt;ul>
&lt;li>dnsmasq解析该域名，发现该域名不在dnsmasq的列表中，则交给ChinaDNS查询&lt;/li>
&lt;li>ChinaDNS解析出IP后，发现该IP不匹配china-route列表，则返回国外IP&lt;/li>
&lt;li>iptables检测到该IP不在&lt;code>ss_spec_dst_bp&lt;/code>中，则代理访问&lt;/li>
&lt;/ul>
&lt;/li>
&lt;li>访问mydomain.com
&lt;ul>
&lt;li>dnsmasq解析该域名，发现该域名在dnsmasq的my-list中，使用dnscrypt进行解析，返回IP，并将该IP加至&lt;code>ss_spec_dst_fw&lt;/code>中&lt;/li>
&lt;li>iptables检测到该IP在&lt;code>ss_spec_dst_fw&lt;/code>中，则代理访问。&lt;/li>
&lt;/ul>
&lt;/li>
&lt;/ul>
&lt;p>完:)&lt;/p></description></item></channel></rss>