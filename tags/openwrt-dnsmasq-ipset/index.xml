<?xml version="1.0" encoding="utf-8" standalone="yes"?><rss version="2.0" xmlns:atom="http://www.w3.org/2005/Atom"><channel><title>Openwrt Dnsmasq Ipset on KeePwn's Notes</title><link>https://www.keepwn.com/tags/openwrt-dnsmasq-ipset/</link><description>Recent content in Openwrt Dnsmasq Ipset on KeePwn's Notes</description><generator>Hugo -- gohugo.io</generator><language>en-us</language><lastBuildDate>Thu, 17 Oct 2024 15:20:53 +0000</lastBuildDate><atom:link href="https://www.keepwn.com/tags/openwrt-dnsmasq-ipset/index.xml" rel="self" type="application/rss+xml"/><item><title>Openwrt上使用dnsmasq和ipset实现域名分流</title><link>https://www.keepwn.com/posts/route-traffic-selectively-by-domain-on-openwrt/</link><pubDate>Wed, 01 Jun 2016 00:00:00 +0000</pubDate><guid>https://www.keepwn.com/posts/route-traffic-selectively-by-domain-on-openwrt/</guid><description>&lt;h2 id="目标">目标
&lt;/h2>&lt;p>部署一台自动代理路由器，实现根据域名来自动设定直连或者代理，而我要做的只是设置PC的默认网关为主路由器（192.168.0.1）还是自动代理路由器（192.168.0.254）。&lt;/p>
&lt;h2 id="创建openwrt虚拟机">创建Openwrt虚拟机
&lt;/h2>&lt;p>系统版本&lt;/p>
&lt;ul>
&lt;li>主路由器 (ip: &lt;code>192.168.0.1&lt;/code>)&lt;/li>
&lt;li>ESXI 6.0U2&lt;/li>
&lt;li>Openwrt 15.05.1 (ip: &lt;code>192.168.0.254&lt;/code>，gateway: &lt;code>192.168.0.1&lt;/code>)&lt;/li>
&lt;/ul>
&lt;!-- more -->
&lt;p>Openwrt虚拟机的配置教程有很多，这里只针对ESXI版Openwrt可能会遇到的问题说明下：&lt;/p>
&lt;ul>
&lt;li>
&lt;p>在ESXI6上，&lt;code>openwrt_x86&lt;/code>每次启动时会大概率的出现卡死现象，表现为&lt;code>Kernel panic - not syncing: Attempted to kill init&lt;/code>。&lt;/p>
&lt;ul>
&lt;li>&lt;strong>解决办法&lt;/strong>：改用&lt;code>openwrt_x64&lt;/code>后正常。原因未知。&lt;/li>
&lt;/ul>
&lt;/li>
&lt;li>
&lt;p>在ESXI6上，在&lt;code>openwrt&lt;/code>上执行某些命令时，会被强制关机，表现为&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-fallback" data-lang="fallback">&lt;span class="line">&lt;span class="cl">来自 promote 的消息: The operation on the file &amp;#34;/vmfs/devices/deltadisks/17ad1ab5-openwrt-15. 05.1-x86-64-combined-ext4-s001.vmdk&amp;#34; failed (Bad address). The file system where disk &amp;#34;/vmfs /devices/deltadisks/17ad1ab5-openwrt-15.05.1-- x86-64-combined-ext4-s001.vmdk&amp;#34; resides is full. Select _Retry to attempt the operation again. Select Cancel to end the session.
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;ul>
&lt;li>&lt;strong>解决办法&lt;/strong>：在&lt;code>Vmware Fusion&lt;/code>中新建openwrt虚拟机（&lt;em>other/other linux 64, 256MB，虚拟机版本为11&lt;/em>），第一次启动后，关机导出为&lt;code>ova&lt;/code>，然后再导入到ESXI6中。具体原因未知。&lt;/li>
&lt;/ul>
&lt;/li>
&lt;/ul>
&lt;h2 id="安装软件">安装软件
&lt;/h2>&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;span class="lnt">3
&lt;/span>&lt;span class="lnt">4
&lt;/span>&lt;span class="lnt">5
&lt;/span>&lt;span class="lnt">6
&lt;/span>&lt;span class="lnt">7
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-shell" data-lang="shell">&lt;span class="line">&lt;span class="cl">opkg update
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">opkg remove dnsmasq
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">opkg install dnsmasq-full
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">opkg install ipset iptables-mod-nat-extra
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">wget http://x.x.x.x/shadowsocks-libev_2.4.6-1_x86_64.ipk
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">opkg install shadowsocks-libev_2.4.6-1_x86_64.ipk
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>&lt;em>PS&lt;/em>
在这里，安装官方版的shadowsocks，而不是openwrt spec版, 下载地址在&lt;a class="link" href="https://sourceforge.net/projects/openwrt-dist/files/shadowsocks-libev/" target="_blank" rel="noopener"
>这里&lt;/a>。&lt;/p>
&lt;p>&lt;em>PPS&lt;/em>
在这里，如果安装的顺序不同，可能会导致lib的依赖错误(至少在15.05.1上是这样)。使用&lt;code>ldd&lt;/code>命令，检查一下shadowsocks的依赖包是否正常。&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-shell" data-lang="shell">&lt;span class="line">&lt;span class="cl">ldd /usr/bin/ss-redir
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;h2 id="配置">配置
&lt;/h2>&lt;h3 id="配置shadowsocks">配置shadowsocks
&lt;/h3>&lt;p>配置&lt;code>/etc/shadowsocks.json&lt;/code>，格式如下：&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;span class="lnt">3
&lt;/span>&lt;span class="lnt">4
&lt;/span>&lt;span class="lnt">5
&lt;/span>&lt;span class="lnt">6
&lt;/span>&lt;span class="lnt">7
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-json" data-lang="json">&lt;span class="line">&lt;span class="cl">&lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nt">&amp;#34;server&amp;#34;&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="s2">&amp;#34;X.X.X.X&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nt">&amp;#34;server_port&amp;#34;&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="s2">&amp;#34;443&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nt">&amp;#34;password&amp;#34;&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="s2">&amp;#34;password&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nt">&amp;#34;local_port&amp;#34;&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="s2">&amp;#34;1080&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nt">&amp;#34;method&amp;#34;&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="s2">&amp;#34;aes-256-cfb&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>修改&lt;code>/etc/init.d/shadowsocks&lt;/code>，设置shadowsocks以&lt;code>Proxy Mode&lt;/code>模式启动，同时开启&lt;code>转发DNS请求&lt;/code>功能，上游DNS为&lt;code>8.8.8.8&lt;/code>：&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt"> 1
&lt;/span>&lt;span class="lnt"> 2
&lt;/span>&lt;span class="lnt"> 3
&lt;/span>&lt;span class="lnt"> 4
&lt;/span>&lt;span class="lnt"> 5
&lt;/span>&lt;span class="lnt"> 6
&lt;/span>&lt;span class="lnt"> 7
&lt;/span>&lt;span class="lnt"> 8
&lt;/span>&lt;span class="lnt"> 9
&lt;/span>&lt;span class="lnt">10
&lt;/span>&lt;span class="lnt">11
&lt;/span>&lt;span class="lnt">12
&lt;/span>&lt;span class="lnt">13
&lt;/span>&lt;span class="lnt">14
&lt;/span>&lt;span class="lnt">15
&lt;/span>&lt;span class="lnt">16
&lt;/span>&lt;span class="lnt">17
&lt;/span>&lt;span class="lnt">18
&lt;/span>&lt;span class="lnt">19
&lt;/span>&lt;span class="lnt">20
&lt;/span>&lt;span class="lnt">21
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-bash" data-lang="bash">&lt;span class="line">&lt;span class="cl">&lt;span class="cp">#!/bin/sh /etc/rc.common
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="cp">&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nv">START&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="m">95&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nv">SERVICE_USE_PID&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="m">1&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nv">SERVICE_WRITE_PID&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="m">1&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nv">SERVICE_DAEMONIZE&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="m">1&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nv">CONFIG&lt;/span>&lt;span class="o">=&lt;/span>/etc/shadowsocks.json
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">start&lt;span class="o">()&lt;/span> &lt;span class="o">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1">#service_start /usr/bin/ss-local -c $CONFIG -b 0.0.0.0&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> service_start /usr/bin/ss-redir -c &lt;span class="nv">$CONFIG&lt;/span> -b 0.0.0.0
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> service_start /usr/bin/ss-tunnel -c &lt;span class="nv">$CONFIG&lt;/span> -b 0.0.0.0 -l &lt;span class="m">5353&lt;/span> -L 8.8.8.8:53 -u
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="o">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">stop&lt;span class="o">()&lt;/span> &lt;span class="o">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1">#service_stop /usr/bin/ss-local&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> service_stop /usr/bin/ss-redir
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> service_stop /usr/bin/ss-tunnel
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="o">}&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>设置shadowsocks开机启动，并手动运行：&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-shell" data-lang="shell">&lt;span class="line">&lt;span class="cl">/etc/init.d/shadowsocks &lt;span class="nb">enable&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">/etc/init.d/shadowsocks start
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>到目前为止，你已经有了一个监听在1080端口的socks代理，和监听在5353端口的不受污染的DNS服务器&lt;/p>
&lt;h3 id="配置ipset">配置ipset
&lt;/h3>&lt;p>进入Luci界面-网络-防火墙-自定义规则，加入以下规则（最后的&lt;code>1080&lt;/code>是shadowsocks的本地端口，请酌情修改）：&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;span class="lnt">3
&lt;/span>&lt;span class="lnt">4
&lt;/span>&lt;span class="lnt">5
&lt;/span>&lt;span class="lnt">6
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-shell" data-lang="shell">&lt;span class="line">&lt;span class="cl">&lt;span class="c1">#创建名为gfwlist，格式为iphash的集合&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">ipset -N gfwlist iphash
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">#匹配gfwlist中ip的nat流量均被转发到shadowsocks端口&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">iptables -t nat -A PREROUTING -p tcp -m &lt;span class="nb">set&lt;/span> --match-set gfwlist dst -j REDIRECT --to-port &lt;span class="m">1080&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">#匹配gfwlist中ip的本机流量均被转发到shadowsocks端口&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">iptables -t nat -A OUTPUT -p tcp -m &lt;span class="nb">set&lt;/span> --match-set gfwlist dst -j REDIRECT --to-port &lt;span class="m">1080&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;h3 id="配置dnsmasq-full">配置dnsmasq-full
&lt;/h3>&lt;p>修改&lt;code>/etc/dnsmasq.conf&lt;/code>，在文末加入&lt;code>conf-dir=/etc/dnsmasq.d&lt;/code>：&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-shell" data-lang="shell">&lt;span class="line">&lt;span class="cl">&lt;span class="nb">echo&lt;/span> &lt;span class="s1">&amp;#39;conf-dir=/etc/dnsmasq.d&amp;#39;&lt;/span> &amp;gt;&amp;gt; /etc/dnsmasq.conf
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>新建目录&lt;code>/etc/dnsmasq.d&lt;/code>，生成&lt;code>dnsmasq_list.conf&lt;/code> 到该目录：&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;span class="lnt">3
&lt;/span>&lt;span class="lnt">4
&lt;/span>&lt;span class="lnt">5
&lt;/span>&lt;span class="lnt">6
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-shell" data-lang="shell">&lt;span class="line">&lt;span class="cl">git clone https://github.com/cokebar/gfwlist2dnsmasq.git
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nb">cd&lt;/span> gfwlist2dnsmasq
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">python2 gfwlist2dnsmasq.py
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">mkdir /etc/dnsmasq.d
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">cp dnsmasq_list.conf /etc/dnsmasq.d
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>其中，&lt;code>dnsmasq_list.conf&lt;/code>的格式为：&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;span class="lnt">3
&lt;/span>&lt;span class="lnt">4
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-ini" data-lang="ini">&lt;span class="line">&lt;span class="cl">&lt;span class="c1">#使用不受污染的DNS解析该域名,可以将此IP改为自己使用的DNS服务器&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="na">server&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="s">/google.com/127.0.0.1#5353&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">#将解析出来的IP保存到名为gfwlist的ipset表中&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="na">ipset&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="s">/google.com/gfwlist&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>你可以手动修改这个文件，你也可以使用&lt;code>gfwlist2dnsmasq.py&lt;/code>自动生成dnsmasq_list版的gfwlist列表。&lt;/p>
&lt;p>重新运行&lt;code>dnsmasq&lt;/code>，它将监听在本机&lt;code>53&lt;/code>端口上。&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-shell" data-lang="shell">&lt;span class="line">&lt;span class="cl">/etc/init.d/dnsmasq restart
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;h2 id="测试">测试
&lt;/h2>&lt;p>场景一&lt;/p>
&lt;ul>
&lt;li>PC端的默认网关设置为&lt;code>192.168.0.1&lt;/code>, DNS设置为&lt;code>192.168.0.1&lt;/code>
&lt;ul>
&lt;li>国内网站访问正常&lt;/li>
&lt;li>Google无法访问&lt;/li>
&lt;/ul>
&lt;/li>
&lt;/ul>
&lt;p>场景二&lt;/p>
&lt;ul>
&lt;li>PC端的默认网关设置为&lt;code>192.168.0.254&lt;/code>, DNS设置为&lt;code>192.168.0.254&lt;/code>
&lt;ul>
&lt;li>访问国内网站
&lt;ul>
&lt;li>dnsmasq解析该域名，发现该域名不在dnsmasq_list中，使用默认DNS服务器进行解析，正常访问。&lt;/li>
&lt;/ul>
&lt;/li>
&lt;li>访问Google
&lt;ul>
&lt;li>dnsmasq解析该域名，发现该域名在dnsmasq_list中，使用设置的安全DNS服务器进行解析，并将该IP加至gfwlist集合中，iptables匹配到规则，将流量转发到shadowsocks监听的端口，进行代理访问。&lt;/li>
&lt;/ul>
&lt;/li>
&lt;/ul>
&lt;/li>
&lt;/ul>
&lt;h2 id="参考">参考
&lt;/h2>&lt;ul>
&lt;li>&lt;a class="link" href="https://blog.sorz.org/p/openwrt-outwall/" target="_blank" rel="noopener"
>https://blog.sorz.org/p/openwrt-outwall/&lt;/a>&lt;/li>
&lt;li>&lt;a class="link" href="http://aenes.com/post/740.html" target="_blank" rel="noopener"
>http://aenes.com/post/740.html&lt;/a>&lt;/li>
&lt;li>&lt;a class="link" href="https://php-rmcr7.rhcloud.com/openwrt-fq/" target="_blank" rel="noopener"
>https://php-rmcr7.rhcloud.com/openwrt-fq/&lt;/a>&lt;/li>
&lt;li>&lt;a class="link" href="https://cokebar.info/archives/962/comment-page-2/#comments" target="_blank" rel="noopener"
>https://cokebar.info/archives/962/comment-page-2/#comments&lt;/a>&lt;/li>
&lt;/ul></description></item></channel></rss>