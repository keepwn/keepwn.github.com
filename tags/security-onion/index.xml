<?xml version="1.0" encoding="utf-8" standalone="yes"?><rss version="2.0" xmlns:atom="http://www.w3.org/2005/Atom"><channel><title>Security-Onion on KeePwn's Notes</title><link>https://www.keepwn.com/tags/security-onion/</link><description>Recent content in Security-Onion on KeePwn's Notes</description><generator>Hugo -- gohugo.io</generator><language>en-us</language><lastBuildDate>Thu, 17 Oct 2024 15:21:10 +0000</lastBuildDate><atom:link href="https://www.keepwn.com/tags/security-onion/index.xml" rel="self" type="application/rss+xml"/><item><title>Security-Onion-2分布式实践之安装篇</title><link>https://www.keepwn.com/posts/security-onion-2-distributed-practice-install/</link><pubDate>Sat, 20 Mar 2021 00:00:00 +0000</pubDate><guid>https://www.keepwn.com/posts/security-onion-2-distributed-practice-install/</guid><description>&lt;img src="https://www.keepwn.com/images/banner-security-onion-2-distributed-practice-install.png" alt="Featured image of post Security-Onion-2分布式实践之安装篇" />&lt;h2 id="前言">前言
&lt;/h2>&lt;blockquote>
&lt;p>Security Onion （以下称安全洋葱）是一款免费且开源的，用于威胁发现、企业安全监视和日志管理的 Linux 发行版本。
目前，安全洋葱已经迭代至 2.X，与 1.X 版本不同，2.X 版本基于容器开发，实现了将各个组件和服务容器化，更易于使用者部署和定制。&lt;/p>
&lt;/blockquote>
&lt;p>安全洋葱的安装较为简单，网络上也有诸多的 ALL IN ONE 的安装教程，但考虑到这些部署方式不太适合生产环境使用，所以本篇主要讲述如何在生产环境分布式部署安全洋葱系统。本篇并不涉及系统的调优，如果你此前已经安装并部署了安全洋葱，可以跳过此章节。&lt;/p>
&lt;p>&lt;strong>本文中使用的安全洋葱版本为 v2.3.30（截至本文编写时）。&lt;/strong>&lt;/p>
&lt;h2 id="准备工作">准备工作
&lt;/h2>&lt;p>官方文档建议采用&lt;code>标准的分布式部署方式&lt;/code>进行部署安全洋葱，至少以下三个节点：&lt;/p>
&lt;table>
&lt;thead>
&lt;tr>
&lt;th>节点类型&lt;/th>
&lt;th>说明&lt;/th>
&lt;/tr>
&lt;/thead>
&lt;tbody>
&lt;tr>
&lt;td>manager node&lt;/td>
&lt;td>主要节点，负责接收采集到的原始数据&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>forward node&lt;/td>
&lt;td>流量分析节点，也叫 sensor-node&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>search-node&lt;/td>
&lt;td>搜索节点，存储 ES 数据&lt;/td>
&lt;/tr>
&lt;/tbody>
&lt;/table>
&lt;p>我部署了 4 个节点，大家根据实际情况进行扩展：&lt;/p>
&lt;table>
&lt;thead>
&lt;tr>
&lt;th>节点&lt;/th>
&lt;th>IP&lt;/th>
&lt;th>配置&lt;/th>
&lt;/tr>
&lt;/thead>
&lt;tbody>
&lt;tr>
&lt;td>security-manager&lt;/td>
&lt;td>10.10.0.1&lt;/td>
&lt;td>8 cores, 16g memory, 200g disk&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>security-sensor&lt;/td>
&lt;td>10.10.0.100&lt;/td>
&lt;td>8 cores, 32g memory, 12t disk&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>security-search-1&lt;/td>
&lt;td>10.10.0.11&lt;/td>
&lt;td>8 cores, 16g memory, 2t disk&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>security-search-2&lt;/td>
&lt;td>10.10.0.12&lt;/td>
&lt;td>8 cores, 16g memory, 2t disk&lt;/td>
&lt;/tr>
&lt;/tbody>
&lt;/table>
&lt;p>架构大致如下：&lt;/p>
&lt;p>&lt;img src="https://www.keepwn.com/images/so-distributed.webp"
loading="lazy"
alt="so-distributed.webp"
>&lt;/p>
&lt;h2 id="开始安装">开始安装
&lt;/h2>&lt;h3 id="security-manager">Security-manager
&lt;/h3>&lt;p>1.从 ISO 引导启动，设置完用户名和密码，回车后开始安装系统，安装完成后重启系统。&lt;/p>
&lt;p>2.登录系统，输入用户名和密码，准备开始配置。&lt;/p>
&lt;p>&lt;img src="https://www.keepwn.com/images/so-manager-setup-1.webp"
loading="lazy"
alt="so-manager-setup-1.webp"
>&lt;/p>
&lt;p>3.选择安装类型为distributed&lt;/p>
&lt;p>&lt;img src="https://www.keepwn.com/images/so-manager-setup-2-choose-install-type.webp"
loading="lazy"
alt="so-manager-setup-2-choose-install-type.webp"
>&lt;/p>
&lt;p>4.选择节点类型为manager&lt;/p>
&lt;p>&lt;img src="https://www.keepwn.com/images/so-manager-setup-3-choose-node-type.webp"
loading="lazy"
alt="so-manager-setup-3-choose-node-type.webp"
>&lt;/p>
&lt;p>5.选择安装环境为standard，这里需要注意 security-manager 这台主机需要能够联网。&lt;/p>
&lt;p>&lt;img src="https://www.keepwn.com/images/so-manager-setup-4-choose-install-condition.webp"
loading="lazy"
alt="so-manager-setup-4-choose-install-condition.webp"
>&lt;/p>
&lt;p>6.设置主机名&lt;/p>
&lt;p>&lt;img src="https://www.keepwn.com/images/so-manager-setup-5-set-hostname.webp"
loading="lazy"
alt="so-manager-setup-5-set-hostname.webp"
>&lt;/p>
&lt;p>7.设置管理口，并配置静态地址（这里建议不要选择DHCP分配地址，会影响服务/节点之间的通信）&lt;/p>
&lt;p>&lt;img src="https://www.keepwn.com/images/so-manager-setup-6-choose-nic.webp"
loading="lazy"
alt="so-manager-setup-6-choose-nic.webp"
>&lt;/p>
&lt;p>&lt;img src="https://www.keepwn.com/images/so-manager-setup-7-set-static-address.webp"
loading="lazy"
alt="so-manager-setup-7-set-static-address.webp"
>&lt;/p>
&lt;p>8.选择系统补丁计划（默认），设置家庭网络（默认）&lt;/p>
&lt;p>&lt;img src="https://www.keepwn.com/images/so-manager-setup-8-choose-os-path-schedule.webp"
loading="lazy"
alt="so-manager-setup-8-choose-os-path-schedule.webp"
>&lt;/p>
&lt;p>&lt;img src="https://www.keepwn.com/images/so-manager-setup-9-set-home-network.webp"
loading="lazy"
alt="so-manager-setup-9-set-home-network.webp"
>&lt;/p>
&lt;p>9.选择安装类型为高级，进行功能定制化&lt;/p>
&lt;p>&lt;img src="https://www.keepwn.com/images/so-manager-setup-10-choose-manager-type.webp"
loading="lazy"
alt="so-manager-setup-10-choose-manager-type.webp"
>&lt;/p>
&lt;p>10.设置 ES 集群名称（默认）&lt;/p>
&lt;p>&lt;img src="https://www.keepwn.com/images/so-manager-setup-11-set-es-cluser-name.webp"
loading="lazy"
alt="so-manager-setup-11-set-es-cluser-name.webp"
>&lt;/p>
&lt;p>11.选择元信息分析引擎（zeek or suricata）。考虑到 zeek 可定制化更强些，所以我选择的是 zeek 处理 metadata，suricata 处理 nids-alerts。事实上，两种方式均可，官方这里有讨论//TODO。&lt;/p>
&lt;p>&lt;img src="https://www.keepwn.com/images/so-manager-setup-12-choose-gen-metadata.webp"
loading="lazy"
alt="so-manager-setup-12-choose-gen-metadata.webp"
>&lt;/p>
&lt;p>12.选择需要发送的日志类型。&lt;/p>
&lt;blockquote>
&lt;p>请注意，这指的是需要被发送到 manager 节点的日志类型，不是 zeek 要处理的协议（这需要额外进行配置）&lt;/p>
&lt;/blockquote>
&lt;p>建议按照实际监测需求和节点存储容量进行权衡。有选择恐惧症的可以先按默认的来，后面可以再修改的:)。&lt;/p>
&lt;p>&lt;img src="https://www.keepwn.com/images/so-manager-setup-13-choose-logs-to-send.webp"
loading="lazy"
alt="so-manager-setup-13-choose-logs-to-send.webp"
>&lt;/p>
&lt;p>13.选择 IDS 规则集（默认）。你也可以选择高级订阅版。&lt;/p>
&lt;p>&lt;img src="https://www.keepwn.com/images/so-manager-setup-14-choose-ids-ruleset.webp"
loading="lazy"
alt="so-manager-setup-14-choose-ids-ruleset.webp"
>&lt;/p>
&lt;p>14.选择安装的组件列表（默认）。按需选择。&lt;/p>
&lt;ul>
&lt;li>Grafana
&lt;ul>
&lt;li>主机的健康监控和报警&lt;/li>
&lt;/ul>
&lt;/li>
&lt;li>Fleet &amp;amp; osquery
&lt;ul>
&lt;li>HIDS，侧重于主机信息被动/主动采集&lt;/li>
&lt;/ul>
&lt;/li>
&lt;li>Wazuh
&lt;ul>
&lt;li>HIDS，侧重于威胁检测、完整性监控等&lt;/li>
&lt;/ul>
&lt;/li>
&lt;li>TheHive
&lt;ul>
&lt;li>安全事件响应平台&lt;/li>
&lt;/ul>
&lt;/li>
&lt;li>Playbook
&lt;ul>
&lt;li>检测 Playbook 的工具&lt;/li>
&lt;/ul>
&lt;/li>
&lt;li>Strelka
&lt;ul>
&lt;li>文件提取/分析，用于威胁搜索、威胁检测和事件响应&lt;/li>
&lt;/ul>
&lt;/li>
&lt;/ul>
&lt;p>&lt;img src="https://www.keepwn.com/images/so-manager-setup-15-choose-components.webp"
loading="lazy"
alt="so-manager-setup-15-choose-components.webp"
>&lt;/p>
&lt;p>15.为其他组件设置邮箱和密码&lt;/p>
&lt;p>16.选择 WEB 界面的访问方式。我选择的是IP，也可以改为域名方式。&lt;/p>
&lt;p>&lt;img src="https://www.keepwn.com/images/so-manager-setup-16-choose-web-access.webp"
loading="lazy"
alt="so-manager-setup-16-choose-web-access.webp"
>&lt;/p>
&lt;p>17.选择下载系统更新包的方式。建议选择&lt;code>通过 manager 节点下载&lt;/code>。&lt;/p>
&lt;p>&lt;img src="https://www.keepwn.com/images/so-manager-setup-17-choose-update-os-by-manager-proxy.webp"
loading="lazy"
alt="so-manager-setup-17-choose-update-os-by-manager-proxy.webp"
>&lt;/p>
&lt;p>18.设置 soremote 密码，后面用于添加其他节点。&lt;/p>
&lt;p>&lt;img src="https://www.keepwn.com/images/so-manager-setup-18-set-soremote-passwd.webp"
loading="lazy"
alt="so-manager-setup-18-set-soremote-passwd.webp"
>&lt;/p>
&lt;p>19.设置允许访问WEB界面的网段。建议只添加安全运维段的主机IP, 不在该网段的主机将无法访问WEB界面。&lt;/p>
&lt;p>&lt;img src="https://www.keepwn.com/images/so-manager-setup-19-set-so-allow.webp"
loading="lazy"
alt="so-manager-setup-19-set-so-allow.webp"
>&lt;/p>
&lt;p>20.确定应用配置，等待完成安装。&lt;/p>
&lt;p>&lt;img src="https://www.keepwn.com/images/so-manager-setup-20.webp"
loading="lazy"
alt="so-manager-setup-20.webp"
>&lt;/p>
&lt;p>&lt;img src="https://www.keepwn.com/images/so-manager-setup-21.webp"
loading="lazy"
alt="so-manager-setup-21.webp"
>&lt;/p>
&lt;p>21.配置防火墙规则，允许其他节点访问管理节点的 Salt 服务 （&lt;strong>重要&lt;/strong>）&lt;/p>
&lt;blockquote>
&lt;p>很多人在部署非管理节点的时候总是提示安装失败，就是因为缺少这个步骤导致的。
sosetup.log中的报错日志类似：&lt;code>[ERROR ] 'mine.send': False&lt;/code>&lt;/p>
&lt;/blockquote>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-bash" data-lang="bash">&lt;span class="line">&lt;span class="cl">firewall-cmd --permanent --zone&lt;span class="o">=&lt;/span> --add-port&lt;span class="o">=&lt;/span>4505-4506/tcp
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">firewall-cmd --reload
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;h3 id="security-sensor">Security-sensor
&lt;/h3>&lt;p>1.完成基础的系统安装后，我们开始配置流量分析节点。&lt;/p>
&lt;p>2.选择安装类型为 distributed&lt;/p>
&lt;p>3.选择节点类型为 sensor&lt;/p>
&lt;p>&lt;img src="https://www.keepwn.com/images/so-sensor-setup-1-choose-install-type.webp"
loading="lazy"
alt="so-sensor-setup-1-choose-install-type.webp"
>&lt;/p>
&lt;p>4.设置主机名&lt;/p>
&lt;p>&lt;img src="https://www.keepwn.com/images/so-sensor-setup-2-set-hostname.webp"
loading="lazy"
alt="so-sensor-setup-2-set-hostname.webp"
>&lt;/p>
&lt;p>5.选择管理口，并配置静态地址&lt;/p>
&lt;p>&lt;img src="https://www.keepwn.com/images/so-sensor-setup-3-choose-nic.webp"
loading="lazy"
alt="so-sensor-setup-3-choose-nic.webp"
>&lt;/p>
&lt;p>6.设置 manager 节点，并输入 soremote 密码，与 manager 节点完成连接。&lt;/p>
&lt;p>&lt;img src="https://www.keepwn.com/images/so-sensor-setup-4-set-manager-hostname.webp"
loading="lazy"
alt="so-sensor-setup-4-set-manager-hostname.webp"
>&lt;/p>
&lt;p>&lt;img src="https://www.keepwn.com/images/so-sensor-setup-5-set-manager-ip.webp"
loading="lazy"
alt="so-sensor-setup-5-set-manager-ip.webp"
>&lt;/p>
&lt;p>&lt;img src="https://www.keepwn.com/images/so-sensor-setup-6-connect-to-manager.webp"
loading="lazy"
alt="so-sensor-setup-6-connect-to-manager.webp"
>&lt;/p>
&lt;p>7.选择镜像口&lt;/p>
&lt;p>&lt;img src="https://www.keepwn.com/images/so-sensor-setup-7-choose-monitor-nic.webp"
loading="lazy"
alt="so-sensor-setup-7-choose-monitor-nic.webp"
>&lt;/p>
&lt;p>&lt;img src="https://www.keepwn.com/images/so-sensor-setup-8.webp"
loading="lazy"
alt="so-sensor-setup-8.webp"
>&lt;/p>
&lt;p>8.选择系统补丁计划（默认），选择下载系统更新包的方式为 manager。&lt;/p>
&lt;p>9.选择安装类型为高级，进行功能定制化。&lt;/p>
&lt;p>10.进行 CPU 绑定（Zeek、Suricata）&lt;/p>
&lt;p>&lt;img src="https://www.keepwn.com/images/so-sensor-setup-9-bind-cpu-zeek.webp"
loading="lazy"
alt="so-sensor-setup-9-bind-cpu-zeek.webp"
>&lt;/p>
&lt;p>&lt;img src="https://www.keepwn.com/images/so-sensor-setup-10-bind-cpu-surucata.webp"
loading="lazy"
alt="so-sensor-setup-10-bind-cpu-surucata.webp"
>&lt;/p>
&lt;p>11.配置镜像口MTU（默认）&lt;/p>
&lt;p>&lt;img src="https://www.keepwn.com/images/so-sensor-setup-11-mtu.webp"
loading="lazy"
alt="so-sensor-setup-11-mtu.webp"
>&lt;/p>
&lt;p>12.等待安装完成。&lt;/p>
&lt;h3 id="security-search">Security-search
&lt;/h3>&lt;p>1.完成基础的系统安装后，我们开始配置流量分析节点。&lt;/p>
&lt;p>2.选择安装类型为 distributed&lt;/p>
&lt;p>3.选择节点类型为 searchnode&lt;/p>
&lt;p>4.设置主机名&lt;/p>
&lt;p>5.选择管理口，并配置静态地址&lt;/p>
&lt;p>6.设置 manager 节点（输入 soremote 密码）&lt;/p>
&lt;p>7.选择系统补丁计划（默认），选择下载系统更新包的方式为 manager。&lt;/p>
&lt;p>8.选择安装类型为高级，进行功能定制化。&lt;/p>
&lt;p>9.配置 ES 堆大小（默认）&lt;/p>
&lt;p>&lt;img src="https://www.keepwn.com/images/so-search-setup-1-set-es-heap-size.webp"
loading="lazy"
alt="so-search-setup-1-set-es-heap-size.webp"
>&lt;/p>
&lt;p>10.配置 Logstash 堆大小（默认）&lt;/p>
&lt;p>&lt;img src="https://www.keepwn.com/images/so-search-setup-2-set-logstash-heap-size.webp"
loading="lazy"
alt="so-search-setup-2-set-logstash-heap-size.webp"
>&lt;/p>
&lt;p>11.配置 Logstash pipeline 线程（默认）&lt;/p>
&lt;p>&lt;img src="https://www.keepwn.com/images/so-search-setup-3-set-logstash-pipeline-workers.webp"
loading="lazy"
alt="so-search-setup-3-set-logstash-pipeline-workers.webp"
>&lt;/p>
&lt;p>12.配置 logstash pipeline 批处理大小（默认）&lt;/p>
&lt;p>&lt;img src="https://www.keepwn.com/images/so-search-setup-4-set-logstash-pipeline-batch-size.webp"
loading="lazy"
alt="so-search-setup-4-set-logstash-pipeline-batch-size.webp"
>&lt;/p>
&lt;p>13.配置 logstash input 线程数（默认），如果发现存在消息积压（redis），可以适当调整以上几个参数。&lt;/p>
&lt;p>&lt;img src="https://www.keepwn.com/images/so-search-setup-5-set-logstash-input-num.webp"
loading="lazy"
alt="so-search-setup-5-set-logstash-input-num.webp"
>&lt;/p>
&lt;p>14.配置 ES 索引关闭时间（默认为 30 天）。关闭索引不会删除数据，如果需要查询历史数据可以再单独开启。如果内存足够的话，可以设置为 90 天。&lt;/p>
&lt;p>&lt;img src="https://www.keepwn.com/images/so-search-setup-6-set-days-of-indices-open.webp"
loading="lazy"
alt="so-search-setup-6-set-days-of-indices-open.webp"
>&lt;/p>
&lt;p>15.配置 ES 存储大小，我配置的是 1948（2T-100G），可以择优调整。&lt;/p>
&lt;p>&lt;img src="https://www.keepwn.com/images/so-search-setup-7-set-es-size.webp"
loading="lazy"
alt="so-search-setup-7-set-es-size.webp"
>&lt;/p>
&lt;p>16.等待安装完成。&lt;/p>
&lt;h2 id="功能验证">功能验证
&lt;/h2>&lt;p>1.打开 https://10.10.0.1 安全洋葱控制台并登陆&lt;/p>
&lt;p>2.点击 Grid 标签，查看网格状态，检查节点是否已经全部上线。&lt;/p>
&lt;p>&lt;img src="https://www.keepwn.com/images/soc-web-grid.webp"
loading="lazy"
alt="soc-web-grid.webp"
>&lt;/p>
&lt;p>在这里，大家可以看到节点列表中还出现了一个陌生的节点类型 securityonion-fleet，这个是其实是独立部署的 Fleet 服务，由于需要管理的 osquery 客户端较多，容易影响性能，所以就把它从管理节点拆分出来了。&lt;/p>
&lt;p>3.点击 Alerts 标签，检查是否可以正常。&lt;/p>
&lt;p>&lt;img src="https://www.keepwn.com/images/soc-web-alert.webp"
loading="lazy"
alt="soc-web-alert.webp"
>&lt;/p>
&lt;p>4.点击 Hunt 标签，检查是否正常。&lt;/p>
&lt;p>&lt;img src="https://www.keepwn.com/images/soc-web-hunt.webp"
loading="lazy"
alt="soc-web-hunt.webp"
>&lt;/p>
&lt;p>5.点击 Grafana 标签，检查各个主机节点是否正常。&lt;/p>
&lt;p>&lt;img src="https://www.keepwn.com/images/soc-grafana.webp"
loading="lazy"
alt="soc-grafana.webp"
>&lt;/p>
&lt;p>6.点击 Kiabana 标签，检查 ES 服务是否正常。&lt;/p>
&lt;p>&lt;img src="https://www.keepwn.com/images/soc-kibana.webp"
loading="lazy"
alt="soc-kibana.webp"
>&lt;/p>
&lt;p>好了，如果服务一切正常的话，你可以开始打工人生活了:)&lt;/p>
&lt;h2 id="参考链接">参考链接
&lt;/h2>&lt;ul>
&lt;li>&lt;a class="link" href="https://docs.securityonion.net/en/2.3/about.html" target="_blank" rel="noopener"
>https://docs.securityonion.net/en/2.3/about.html&lt;/a>&lt;/li>
&lt;/ul></description></item></channel></rss>