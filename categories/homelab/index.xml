<?xml version="1.0" encoding="utf-8" standalone="yes"?><rss version="2.0" xmlns:atom="http://www.w3.org/2005/Atom"><channel><title>HomeLab on KeePwn's Notes</title><link>https://www.keepwn.com/categories/homelab/</link><description>Recent content in HomeLab on KeePwn's Notes</description><generator>Hugo -- gohugo.io</generator><language>en-us</language><lastBuildDate>Thu, 17 Oct 2024 15:21:05 +0000</lastBuildDate><atom:link href="https://www.keepwn.com/categories/homelab/index.xml" rel="self" type="application/rss+xml"/><item><title>构建适合程序员的私有云</title><link>https://www.keepwn.com/posts/build-home-cloud-center-for-it/</link><pubDate>Sun, 09 Apr 2017 00:00:00 +0000</pubDate><guid>https://www.keepwn.com/posts/build-home-cloud-center-for-it/</guid><description>&lt;img src="https://www.keepwn.com/images/banner-build-home-cloud-center-for-IT.png" alt="Featured image of post 构建适合程序员的私有云" />&lt;h2 id="前言">前言
&lt;/h2>&lt;p>如今网络上有很多关于如何自建NAS、搭建家庭私有云的教程，但基本都止步于文件共享和多媒体服务。&lt;/p>
&lt;p>作为一个半吊子的码农，这显然不能满足我的需求。&lt;/p>
&lt;p>所以，结合着自己需求搞了一套自己的私有云方案，在各种大坑小坑中坚持了近大半年后，发现该方案极大的提高了自己的工作效率。&lt;/p>
&lt;blockquote>
&lt;p>以下的方案不一定完全适合你，你可能需要根据自己的实际需求进行适当更改。&lt;/p>
&lt;/blockquote>
&lt;h2 id="核心内容">核心内容
&lt;/h2>&lt;ul>
&lt;li>数据中心，提供数据存储服务&lt;/li>
&lt;li>家庭服务中心，提供常见的NAS服务&lt;/li>
&lt;li>工作服务中心，提供工作上所需服务&lt;/li>
&lt;/ul>
&lt;h2 id="准备工作">准备工作
&lt;/h2>&lt;ul>
&lt;li>准备一台家用服务器（我个人用的是Gen8 1230v2 16G）
&lt;ul>
&lt;li>CPU需要支持VT-D和VT-X&lt;/li>
&lt;/ul>
&lt;/li>
&lt;li>准备1块SSD和至少2块以上的机械硬盘&lt;/li>
&lt;li>准备一张HBA卡（IT模式的D2607-A11阵列卡）&lt;/li>
&lt;li>安装ESXI6系统
&lt;ul>
&lt;li>系统建议单独安装在U盘/SD卡上&lt;/li>
&lt;li>SSD连接在主板SATA接口上，机械硬盘连接在HBA卡上&lt;/li>
&lt;li>将HBA卡配置为直通模式&lt;/li>
&lt;li>将SSD挂载到ESXI中，新建存储为&lt;code>SSD_DataStore&lt;/code>&lt;/li>
&lt;/ul>
&lt;/li>
&lt;/ul>
&lt;div class="admonition question">
&lt;div class="details-summary admonition-title">
&lt;i class='icon fas fa-question-circle fa-fw'>&lt;/i>
Question
&lt;/div>
&lt;div class="details-content">
&lt;div class="admonition-content">
&lt;p>Q: 为什么选用ESXI而不是Hyper-V?
A: 如果只是用来搭建NAS服务，两者区别不大。但目前的这套方案，使用ESXI更为合适。&lt;/p>
&lt;/div>
&lt;/div>
&lt;/div>
&lt;h2 id="数据中心">数据中心
&lt;/h2>&lt;p>数据中心，主要提供数据存储服务，这里有两个数据中心：&lt;/p>
&lt;ul>
&lt;li>被ESXI管理的SSD
&lt;ul>
&lt;li>用于存储&lt;code>提供基础服务的虚拟机的文件&lt;/code>和&lt;code>交换文件&lt;/code>&lt;/li>
&lt;/ul>
&lt;/li>
&lt;li>被FreeNAS管理的机械硬盘
&lt;ul>
&lt;li>主要提供NFS、CIFS、AFP这3种形式的数据服务&lt;/li>
&lt;li>为ESXI提供部分存储空间，用于存储&lt;code>使用频率较低的虚拟机的文件&lt;/code>&lt;/li>
&lt;/ul>
&lt;/li>
&lt;/ul>
&lt;h3 id="freenas安装与配置">FreeNAS安装与配置
&lt;/h3>&lt;ul>
&lt;li>创建FreeNAS虚拟机
&lt;ul>
&lt;li>&lt;strong>[存储位置为SSD_DataStore]&lt;/strong>&lt;/li>
&lt;/ul>
&lt;/li>
&lt;li>创建ZFS卷
&lt;ul>
&lt;li>2个以上的机械硬盘&lt;/li>
&lt;li>存储池类型为Mirror或RAIDZ&lt;/li>
&lt;/ul>
&lt;/li>
&lt;li>创建多个数据集
&lt;ul>
&lt;li>&lt;code>/vms&lt;/code>，提供给ESXI，开启NFS&lt;/li>
&lt;li>&lt;code>/media&lt;/code>，用于家庭影音，开启NFS、CIFS共享&lt;/li>
&lt;li>&lt;code>/share&lt;/code>，用于文件共享，开启NFS、CIFS共享&lt;/li>
&lt;li>&lt;code>/tm&lt;/code>，用于TimeMachine，开启AFP共享&lt;/li>
&lt;li>等&lt;/li>
&lt;/ul>
&lt;/li>
&lt;li>将vms挂载到ESXI中，新建存储为&lt;code>VMS_DataStore&lt;/code>&lt;/li>
&lt;/ul>
&lt;blockquote>
&lt;p>FreeNAS的数据，一定要做好手动备份，毕竟号称有五重备份的GitLab也吃了大亏的:)&lt;/p>
&lt;/blockquote>
&lt;h2 id="服务集群中心">服务集群中心
&lt;/h2>&lt;p>服务集群中心，包括ESXI提供的虚拟机资源和Rancher提供的容器资源。&lt;/p>
&lt;h3 id="rancher集群安装与配置">Rancher集群安装与配置
&lt;/h3>&lt;ul>
&lt;li>创建3台虚拟机（RancherOS、CoreOS、Ubuntu等系统任选）
&lt;ul>
&lt;li>&lt;strong>[存储位置为SSD_DataStore]&lt;/strong>&lt;/li>
&lt;li>分别命名为master、node1和node2&lt;/li>
&lt;li>分别安装docker&lt;/li>
&lt;/ul>
&lt;/li>
&lt;li>部署Rancher集群
&lt;ul>
&lt;li>在master主机上部署Rancher-Server&lt;/li>
&lt;li>在master主机上部署Rancher-Agent，将master添加到server&lt;/li>
&lt;li>在node1、node2主机上部署Rancher-Agent，将node1和node2添加到server&lt;/li>
&lt;li>合理分配3个主机上的容器的部署&lt;/li>
&lt;/ul>
&lt;/li>
&lt;li>配置Rancher数据源
&lt;ul>
&lt;li>在数据中心创建&lt;code>/rancher&lt;/code>数据集&lt;/li>
&lt;li>部署Rancher-NFS&lt;/li>
&lt;li>使用Rancher-NFS服务，容器可实现数据持久化&lt;/li>
&lt;/ul>
&lt;/li>
&lt;/ul>
&lt;h3 id="基础建设服务">基础建设服务
&lt;/h3>&lt;ul>
&lt;li>智能家庭服务
&lt;ul>
&lt;li>Home-Assistant和Homebridge&lt;/li>
&lt;li>容器方式部署&lt;/li>
&lt;li>实现用网页端和IOS端对家里的服务或设备进行管理&lt;/li>
&lt;/ul>
&lt;/li>
&lt;li>透明代理服务
&lt;ul>
&lt;li>openwrt虚拟机，&lt;strong>[存储位置为SSD_DataStore]&lt;/strong>&lt;/li>
&lt;li>具体部署方法在本站中搜索&lt;/li>
&lt;li>设置主机的网关为openwrt地址，即可实现透明代理&lt;/li>
&lt;/ul>
&lt;/li>
&lt;li>公网映射服务
&lt;ul>
&lt;li>容器方式部署，ngrok、n2n和frp任选&lt;/li>
&lt;li>需要一台公网主机&lt;/li>
&lt;li>实现将内网服务映射到公网，方便远程访问&lt;/li>
&lt;/ul>
&lt;/li>
&lt;li>证书签发服务
&lt;ul>
&lt;li>容器方式部署&lt;/li>
&lt;li>内网使用自签发证书&lt;/li>
&lt;li>公网使用Let&amp;rsquo;s Encrypt服务签发证书&lt;/li>
&lt;/ul>
&lt;/li>
&lt;/ul>
&lt;blockquote>
&lt;p>对于使用ngrok和n2n，个人有一些心得，有时间另开篇介绍&lt;/p>
&lt;/blockquote>
&lt;h3 id="家庭类服务">家庭类服务
&lt;/h3>&lt;p>一般包括同步、影音、网盘等服务，需要用到以下系统：&lt;/p>
&lt;ul>
&lt;li>Plex Media Server / Emby Server
&lt;ul>
&lt;li>容器&lt;/li>
&lt;li>管理影音文件&lt;/li>
&lt;li>多设备同时看电影、追美剧&lt;/li>
&lt;/ul>
&lt;/li>
&lt;li>Resilio Sync
&lt;ul>
&lt;li>容器&lt;/li>
&lt;li>多个平台之间文件同步&lt;/li>
&lt;/ul>
&lt;/li>
&lt;li>Xware
&lt;ul>
&lt;li>容器&lt;/li>
&lt;li>迅雷官方远程下载服务&lt;/li>
&lt;/ul>
&lt;/li>
&lt;li>DSM6（群晖）
&lt;ul>
&lt;li>虚拟机，&lt;strong>[存储位置为SSD_DataStore]&lt;/strong>&lt;/li>
&lt;li>和FreeNAS功能类似&lt;/li>
&lt;/ul>
&lt;/li>
&lt;/ul>
&lt;blockquote>
&lt;p>本方案中，因为已经搭建了FreeNAS，DSM6的功能已经被大大地弱化了，可以不装&lt;/p>
&lt;/blockquote>
&lt;blockquote>
&lt;p>Plex和Emby两个都是比较出名的家庭流媒应用，目前个人用Plex比较多&lt;/p>
&lt;/blockquote>
&lt;h3 id="工作类服务">工作类服务
&lt;/h3>&lt;p>一般包括代码版本控制、记事本、测试环境等服务：&lt;/p>
&lt;ul>
&lt;li>Leanote Server
&lt;ul>
&lt;li>容器&lt;/li>
&lt;li>开源的多平台云笔记&lt;/li>
&lt;/ul>
&lt;/li>
&lt;li>Gogs Server
&lt;ul>
&lt;li>容器&lt;/li>
&lt;li>代码版本控制系统，和github类似&lt;/li>
&lt;/ul>
&lt;/li>
&lt;li>Drone
&lt;ul>
&lt;li>容器&lt;/li>
&lt;li>持续构建系统，方便测试代码或部署环境&lt;/li>
&lt;/ul>
&lt;/li>
&lt;li>各类数据库
&lt;ul>
&lt;li>优先容器（MongoDB不宜搭建在容器中，会发生错误，暂未解决）&lt;/li>
&lt;li>多种数据库统一存储，统一管理&lt;/li>
&lt;/ul>
&lt;/li>
&lt;/ul>
&lt;h2 id="进阶">进阶
&lt;/h2>&lt;p>由于各个服务之间联系不大，系统平台也比较多，管理起来实在不便。如果有开发能力的话，还是建议自己开发个系统来统一协调各个服务。比如使用微信端入口，对服务进行定期检查，消息通知，甚至是远程控制，未来还是很美好的:)&lt;/p>
&lt;h2 id="最后">最后
&lt;/h2>&lt;p>最后，这个方案其实还有很多的内容，本文只是列了一些提纲，具体在实际操作中必然会有很多问题，就拿Rancher来说，Rancher中容器如何配置、存储如何挂载就需要好好斟酌，当然这会有一个很长的试错过程。当然和去年相比，Rancher上的坑已经少了太多了，想当初把Rancher从v1.1一步步升到现在的1.5.x，中间经历了什么，想想都要哭了&lt;/p></description></item><item><title>Openwrt上实现透明代理</title><link>https://www.keepwn.com/posts/see-the-big-world-on-openwrt/</link><pubDate>Wed, 28 Dec 2016 00:00:00 +0000</pubDate><guid>https://www.keepwn.com/posts/see-the-big-world-on-openwrt/</guid><description>&lt;h2 id="背景">背景
&lt;/h2>&lt;p>前一段时间，在ESXI上部署了一台Plex服务器。解决了一些恼人的问题后，用得还算满意，但是TMDb搜刮器在匹配电影信息时，总会丢失一些Poster海报信息。&lt;/p>
&lt;p>最终发现，&lt;a class="link" href="https://www.themoviedb.org" target="_blank" rel="noopener"
>The Movie Database (TMDb)&lt;/a> 这个地址被&lt;code>和谐社会&lt;/code>了。&lt;/p>
&lt;p>由于Plex不支持设置代理，且手动设置&lt;code>HTTP_PROXY&lt;/code>后还是无效，所以决定把Plex这台服务器加入透明代理网络中。&lt;/p>
&lt;blockquote>
&lt;p>参考以前的文章&lt;a class="link" href="https://www.keepwn.com/howto/route-traffic-selectively-by-domain-on-openwrt/" >《Openwrt上使用dnsmasq和ipset实现域名分流》&lt;/a>，将网关、DNS设置为&lt;code>192.168.0.254&lt;/code>&lt;/p>
&lt;/blockquote>
&lt;p>因为之前重新部署了ESXI环境，所以Openwrt这台虚拟机不幸丢失，所以只能&lt;code>大侠请重新来过&lt;/code>。&lt;/p>
&lt;p>由于之前的方案在实际使用中还有一些不足，在综合了网络上现有的一些方案后，设计出一份改进版的方案。&lt;/p>
&lt;!-- more -->
&lt;h2 id="网络上原始的方案">网络上原始的方案
&lt;/h2>&lt;h3 id="安装软件">安装软件
&lt;/h3>&lt;ul>
&lt;li>shadowsocks-libev和luci-app-shadowsocks（提供ss-rules）
&lt;ul>
&lt;li>依赖iptables-mod-tproxy和ip&lt;/li>
&lt;/ul>
&lt;/li>
&lt;li>chinadns和luci-app-chinadns&lt;/li>
&lt;/ul>
&lt;h3 id="配置">配置
&lt;/h3>&lt;ul>
&lt;li>使用luci-app配置shadowsocks
&lt;ul>
&lt;li>开启&lt;code>端口转发&lt;/code>，设置&lt;code>本地端口&lt;/code>为5300，用于DNS查询&lt;/li>
&lt;li>&lt;code>被忽略IP列表&lt;/code>选择ChinaDNS路由表（&lt;code>/etc/chinadns_chnroute.txt&lt;/code>）&lt;/li>
&lt;/ul>
&lt;/li>
&lt;li>使用luci-app配置ChinaDNS
&lt;ul>
&lt;li>设置&lt;code>本地端口&lt;/code>为5353&lt;/li>
&lt;li>设置&lt;code>上游服务器&lt;/code>为&lt;code>114.114.114.114,127.0.0.1:5300&lt;/code>&lt;/li>
&lt;/ul>
&lt;/li>
&lt;li>使用luci-app配置DHCP/DNS
&lt;ul>
&lt;li>设置&lt;code>DNS转发&lt;/code>为&lt;code>127.0.0.1#5353&lt;/code>&lt;/li>
&lt;li>勾选&lt;code>忽略解析文件&lt;/code>&lt;/li>
&lt;/ul>
&lt;/li>
&lt;/ul>
&lt;p>这样一来，你拥有了:&lt;/p>
&lt;ul>
&lt;li>一个无污染的DNS服务器，端口为53
&lt;ul>
&lt;li>国内DNS解析出国内IP，国外DNS解析出国外IP&lt;/li>
&lt;/ul>
&lt;/li>
&lt;li>一个透明代理的网关
&lt;ul>
&lt;li>如果请求IP在ChinaDNS路由表中，则走正常流量&lt;/li>
&lt;li>如果请求IP不在ChinaDNS路由表中，则走代理流量&lt;/li>
&lt;/ul>
&lt;/li>
&lt;/ul>
&lt;h2 id="改进版方案">改进版方案
&lt;/h2>&lt;p>尽管上面的方案已经能够实现透明代理，但是还有以下问题(附上解决方案)：&lt;/p>
&lt;ul>
&lt;li>在某些ISP下使用&lt;code>ss-tunnel&lt;/code>（即端口转发）不稳定, 导致DNS查询时间过长或超时
&lt;ul>
&lt;li>解决方案:
&lt;ul>
&lt;li>使用dnscrypt-proxy提供的DNS查询服务&lt;/li>
&lt;/ul>
&lt;/li>
&lt;/ul>
&lt;/li>
&lt;li>ChinaDNS有时会出现误判，导致访问国内站点时走代理
&lt;ul>
&lt;li>解决方案:
&lt;ul>
&lt;li>在dnsmasq中配置chinalist，指定国内域名使用国内DNS进行解析&lt;/li>
&lt;li>不在列表中的站点交由ChinaDNS判断&lt;/li>
&lt;/ul>
&lt;/li>
&lt;/ul>
&lt;/li>
&lt;li>只能定义强制走代理的IP，而不能是域名，维护起来比较麻烦
&lt;ul>
&lt;li>解决方案:
&lt;ul>
&lt;li>归功于ss-rules的实现，ipset集合&lt;code>ss_spec_dst_fw&lt;/code>中存放强制走代理的IP&lt;/li>
&lt;li>在dnsmasq中配置my-list(自定义域名)列表，将my-list的查询结果保存到&lt;code>ss_spec_dst_fw&lt;/code>中&lt;/li>
&lt;/ul>
&lt;/li>
&lt;/ul>
&lt;/li>
&lt;/ul>
&lt;h3 id="额外安装以下软件">额外安装以下软件:
&lt;/h3>&lt;ul>
&lt;li>安装dnsmasq-full
&lt;ul>
&lt;li>需要先卸载自带的dnsmasq&lt;/li>
&lt;/ul>
&lt;/li>
&lt;li>安装dnscrypt-proxy
&lt;ul>
&lt;li>提供安全不受污染的DNS服务器&lt;/li>
&lt;/ul>
&lt;/li>
&lt;/ul>
&lt;h3 id="更新配置">更新配置
&lt;/h3>&lt;ul>
&lt;li>使用luci-app配置shadowsocks
&lt;ul>
&lt;li>关闭&lt;code>端口转发&lt;/code>&lt;/li>
&lt;/ul>
&lt;/li>
&lt;li>配置dnscrypt-proxy
&lt;ul>
&lt;li>修改监听端口为&lt;code>127.0.0.1:5300&lt;/code>&lt;/li>
&lt;/ul>
&lt;/li>
&lt;li>配置dnsmasq
修改&lt;code>/etc/dnsmasq.conf&lt;/code>，在文末加入&lt;code>conf-dir=/etc/dnsmasq.d&lt;/code>:
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-bash" data-lang="bash">&lt;span class="line">&lt;span class="cl">&lt;span class="nb">echo&lt;/span> &lt;span class="s1">&amp;#39;conf-dir=/etc/dnsmasq.d&amp;#39;&lt;/span> &amp;gt;&amp;gt; /etc/dnsmasq.conf
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;/li>
&lt;/ul>
&lt;h3 id="定期维护">定期维护
&lt;/h3>&lt;p>以下脚本实现更新china-route、china-dns和my-list的功能:&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt"> 1
&lt;/span>&lt;span class="lnt"> 2
&lt;/span>&lt;span class="lnt"> 3
&lt;/span>&lt;span class="lnt"> 4
&lt;/span>&lt;span class="lnt"> 5
&lt;/span>&lt;span class="lnt"> 6
&lt;/span>&lt;span class="lnt"> 7
&lt;/span>&lt;span class="lnt"> 8
&lt;/span>&lt;span class="lnt"> 9
&lt;/span>&lt;span class="lnt">10
&lt;/span>&lt;span class="lnt">11
&lt;/span>&lt;span class="lnt">12
&lt;/span>&lt;span class="lnt">13
&lt;/span>&lt;span class="lnt">14
&lt;/span>&lt;span class="lnt">15
&lt;/span>&lt;span class="lnt">16
&lt;/span>&lt;span class="lnt">17
&lt;/span>&lt;span class="lnt">18
&lt;/span>&lt;span class="lnt">19
&lt;/span>&lt;span class="lnt">20
&lt;/span>&lt;span class="lnt">21
&lt;/span>&lt;span class="lnt">22
&lt;/span>&lt;span class="lnt">23
&lt;/span>&lt;span class="lnt">24
&lt;/span>&lt;span class="lnt">25
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-bash" data-lang="bash">&lt;span class="line">&lt;span class="cl">&lt;span class="cp">#!/bin/sh
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="cp">&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nv">DNS&lt;/span>&lt;span class="o">=&lt;/span>127.0.0.1#5300
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nv">IPSET&lt;/span>&lt;span class="o">=&lt;/span>ss_spec_dst_fw
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1"># update china route&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">curl &lt;span class="s1">&amp;#39;http://ftp.apnic.net/apnic/stats/apnic/delegated-apnic-latest&amp;#39;&lt;/span> &lt;span class="p">|&lt;/span> grep ipv4 &lt;span class="p">|&lt;/span> grep CN &lt;span class="p">|&lt;/span> awk -F&lt;span class="se">\|&lt;/span> &lt;span class="s1">&amp;#39;{ printf(&amp;#34;%s/%d\n&amp;#34;, $4, 32-log($5)/log(2)) }&amp;#39;&lt;/span> &amp;gt; china-route.txt
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1"># update china dns&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">wget --no-check-certificate -O china-route.txt https://raw.githubusercontent.com/felixonmars/dnsmasq-china-list/master/accelerated-domains.china.conf
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1"># update my list&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">cat my-list.txt &lt;span class="p">|&lt;/span> awk &lt;span class="s1">&amp;#39;{ printf(&amp;#34;server=/&amp;#34;$1&amp;#34;/&amp;#39;&lt;/span>&lt;span class="nv">$DNS&lt;/span>&lt;span class="s1">&amp;#39;\nipset=/&amp;#34;$1&amp;#34;/&amp;#39;&lt;/span>&lt;span class="nv">$IPSET&lt;/span>&lt;span class="s1">&amp;#39;\n&amp;#34;) }&amp;#39;&lt;/span> &lt;span class="c1"># &amp;gt; my-list.conf&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1"># copy updated files&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">cp china-list.conf /etc/dnsmasq.d/china-list.conf
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">cp my-list.conf /etc/dnsmasq.d/my-list.conf
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">cp china-route.txt /etc/chinadns_chnroute.txt
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1"># restart service&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">/etc/init.d/dnsmasq restart
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">/etc/init.d/chinadns restart
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">/etc/init.d/shadowsocks rules
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nb">echo&lt;/span> &lt;span class="s1">&amp;#39;updated success&amp;#39;&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>其中，my-list.txt中保存需要强制走代理的域名列表&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-txt" data-lang="txt">&lt;span class="line">&lt;span class="cl">ipip.net
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">mydomain.com
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>你需要定期执行这个脚本来对相关列表进行更新。&lt;/p>
&lt;h2 id="总结">总结
&lt;/h2>&lt;blockquote>
&lt;p>使用该方案的前提：&lt;/p>
&lt;ul>
&lt;li>设置PC的网关为openwrt的ip（如:192.168.0.254）&lt;/li>
&lt;li>设置PC的DNS为openwrt的ip（如:192.168.0.254）&lt;/li>
&lt;/ul>
&lt;/blockquote>
&lt;ul>
&lt;li>当PC端访问国内网站时
&lt;ul>
&lt;li>dnsmasq解析该域名，发现该域名在dnsmasq的china-list中，使用国内DNS进行解析，返回国内IP&lt;/li>
&lt;li>iptables检测到该IP在&lt;code>ss_spec_dst_bp&lt;/code>（即china-route）中，则直连访问&lt;/li>
&lt;/ul>
&lt;/li>
&lt;li>访问google.com
&lt;ul>
&lt;li>dnsmasq解析该域名，发现该域名不在dnsmasq的列表中，则交给ChinaDNS查询&lt;/li>
&lt;li>ChinaDNS解析出IP后，发现该IP不匹配china-route列表，则返回国外IP&lt;/li>
&lt;li>iptables检测到该IP不在&lt;code>ss_spec_dst_bp&lt;/code>中，则代理访问&lt;/li>
&lt;/ul>
&lt;/li>
&lt;li>访问mydomain.com
&lt;ul>
&lt;li>dnsmasq解析该域名，发现该域名在dnsmasq的my-list中，使用dnscrypt进行解析，返回IP，并将该IP加至&lt;code>ss_spec_dst_fw&lt;/code>中&lt;/li>
&lt;li>iptables检测到该IP在&lt;code>ss_spec_dst_fw&lt;/code>中，则代理访问。&lt;/li>
&lt;/ul>
&lt;/li>
&lt;/ul>
&lt;p>完:)&lt;/p></description></item><item><title>富士通D2607-A11刷IT模式</title><link>https://www.keepwn.com/posts/crossflashing-the-fujitsu-d2607/</link><pubDate>Fri, 02 Dec 2016 00:00:00 +0000</pubDate><guid>https://www.keepwn.com/posts/crossflashing-the-fujitsu-d2607/</guid><description>&lt;h2 id="准备工具">准备工具
&lt;/h2>&lt;ul>
&lt;li>一张富士通D2607-A11阵列卡&lt;/li>
&lt;li>一个U盘&lt;/li>
&lt;li>一台PC机（支持UEFI启动）&lt;/li>
&lt;/ul>
&lt;h2 id="准备工作">准备工作
&lt;/h2>&lt;ol>
&lt;li>制作DOS启动盘&lt;/li>
&lt;/ol>
&lt;ul>
&lt;li>将U盘格式化成FAT32，刷入dos系统&lt;/li>
&lt;/ul>
&lt;ol>
&lt;li>下载刷机工具包&lt;a class="link" href="https://www.keepwn.com/downloads/LSI-9211-8i-IT-MODE-TOOLS.zip" >&lt;strong>点击下载&lt;/strong>&lt;/a>&lt;/li>
&lt;li>拷贝刷机所需工具&lt;/li>
&lt;/ol>
&lt;ul>
&lt;li>megarec软件&lt;/li>
&lt;li>sas2flash软件&lt;/li>
&lt;li>9211-8i固件&lt;/li>
&lt;/ul>
&lt;ol>
&lt;li>拷贝efi shell支持文件&lt;/li>
&lt;/ol>
&lt;ul>
&lt;li>在U盘根目录下，创建&lt;code>\efi\boot&lt;/code>目录&lt;/li>
&lt;li>复制shell_v1.efi到&lt;code>\efi\boot&lt;/code>目录，重命名为&lt;code>bootx64.efi&lt;/code>&lt;/li>
&lt;/ul>
&lt;!-- more -->
&lt;h2 id="开始刷固件">开始刷固件
&lt;/h2>&lt;ol>
&lt;li>插上D2607-A11阵列卡&lt;/li>
&lt;li>启动PC，选择U盘引导，进入DOS命令行&lt;/li>
&lt;/ol>
&lt;ul>
&lt;li>
&lt;p>备份阵列卡信息&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-fallback" data-lang="fallback">&lt;span class="line">&lt;span class="cl">&amp;gt;dir
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&amp;gt;megarec -readsbr 0 sbrbak.bin
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;blockquote>
&lt;ul>
&lt;li>使用&lt;code>xdd&lt;/code>查看sbrbak.bin的数据，在&lt;code>000000d0&lt;/code>行&lt;code>500X XXXX XXXX XXXX&lt;/code>为阵列卡的地址&lt;/li>
&lt;li>强烈建议进行这个操作，尽管我当时忘了&lt;/li>
&lt;/ul>
&lt;/blockquote>
&lt;/li>
&lt;/ul>
&lt;ol>
&lt;li>刷入sbr&lt;/li>
&lt;/ol>
&lt;ul>
&lt;li>刷入fj版sbr
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-fallback" data-lang="fallback">&lt;span class="line">&lt;span class="cl">&amp;gt;megarec -writesbr 0 sbrfj.bin
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;/li>
&lt;li>清空flash
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-fallback" data-lang="fallback">&lt;span class="line">&lt;span class="cl">&amp;gt;megarec -cleanflash 0
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;/li>
&lt;/ul>
&lt;ol>
&lt;li>重启PC，选择UEFI版U盘引导，进入efi shell&lt;/li>
&lt;li>刷固件&lt;/li>
&lt;/ol>
&lt;ul>
&lt;li>
&lt;p>刷入9211 8i固件&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;span class="lnt">3
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-fallback" data-lang="fallback">&lt;span class="line">&lt;span class="cl">&amp;gt;cd fs0 # 或fs1
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&amp;gt;sas2hax.efi -o -f 2118it.bin
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&amp;gt;sas2hax.efi -o -b mptsas2.rom
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;blockquote>
&lt;ul>
&lt;li>这里使用的shell.efi版本为v1，如果遇到以下报错:&lt;code>InitShellApp: Application not started from Shell&lt;/code>，你可能需要更换shell.efi版本&lt;/li>
&lt;li>这里使用修改后的sas2hax.efi，而不是原版程序sas2flash.efi（D2607-A11无法验证通过）&lt;/li>
&lt;li>在刷入固件的时候，可能会失败，重启系统后尝试重新刷入固件&lt;/li>
&lt;/ul>
&lt;/blockquote>
&lt;/li>
&lt;li>
&lt;p>更新SAS Address&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-fallback" data-lang="fallback">&lt;span class="line">&lt;span class="cl">sas2flash -o -sasadd 500* **** **** ****
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;blockquote>
&lt;ul>
&lt;li>SAS Address以500开头&lt;/li>
&lt;li>如果不慎丢失SAS Address，以&lt;code>5000 1122 3344&lt;/code>代替&lt;/li>
&lt;/ul>
&lt;/blockquote>
&lt;/li>
&lt;/ul>
&lt;ol>
&lt;li>重启电脑，进入DOS命令行，重新刷入sbr&lt;/li>
&lt;/ol>
&lt;ul>
&lt;li>刷入fj版sbr
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-fallback" data-lang="fallback">&lt;span class="line">&lt;span class="cl">&amp;gt;megarec -writesbr 0 sbrfj.bin
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;blockquote>
&lt;p>必须重刷一次sbr，否则只能用阵列卡的一个端口了&lt;/p>
&lt;/blockquote>
&lt;/li>
&lt;/ul>
&lt;ol>
&lt;li>重启电脑就能在启动信息中看到新的设备信息&lt;/li>
&lt;/ol>
&lt;h2 id="额外的">额外的
&lt;/h2>&lt;ul>
&lt;li>一开始装在GEN8上来刷LSI固件，尝试了多种方式都刷不成功，所以在刷之前最好准备一台支持UEFI的主机。&lt;/li>
&lt;li>看了错误的教程，导致SAS Address丢失，只能随便填了串地址。就目前来看，似乎不会影响到阵列卡的使用&lt;/li>
&lt;li>二手的D2607-A11，成色不咋地，有个接口有点变形，现在觉得有点后悔。配的挡板太高，想装在GEN8上只能把它拆了。&lt;/li>
&lt;li>原接在GEN8主板SAS接口上的线缆连接到D2607-A11的接口上，这样就可以实现sata5的SSD+直通4硬盘的方案了。&lt;/li>
&lt;/ul>
&lt;h2 id="参考">参考
&lt;/h2>&lt;ul>
&lt;li>&lt;a class="link" href="https://marcan.st/2016/05/crossflashing-the-fujitsu-d2607/" target="_blank" rel="noopener"
>https://marcan.st/2016/05/crossflashing-the-fujitsu-d2607/&lt;/a>&lt;/li>
&lt;li>&lt;a class="link" href="https://www.broadcom.com/products/storage/host-bus-adapters/sas-9211-8i#downloads" target="_blank" rel="noopener"
>https://www.broadcom.com/products/storage/host-bus-adapters/sas-9211-8i#downloads&lt;/a>&lt;/li>
&lt;li>&lt;a class="link" href="https://www.chiphell.com/thread-1629960-1-1.html" target="_blank" rel="noopener"
>https://www.chiphell.com/thread-1629960-1-1.html&lt;/a>&lt;/li>
&lt;li>&lt;a class="link" href="http://koolshare.cn/thread-64959-1-1.html" target="_blank" rel="noopener"
>http://koolshare.cn/thread-64959-1-1.html&lt;/a>&lt;/li>
&lt;li>&lt;a class="link" href="https://github.com/tianocore/edk2" target="_blank" rel="noopener"
>https://github.com/tianocore/edk2&lt;/a>&lt;/li>
&lt;/ul></description></item><item><title>从Hyper-V迁移到ESXI的血泪史</title><link>https://www.keepwn.com/posts/moving-hyperv-to-esxi/</link><pubDate>Fri, 03 Jun 2016 00:00:00 +0000</pubDate><guid>https://www.keepwn.com/posts/moving-hyperv-to-esxi/</guid><description>&lt;h2 id="背景">背景
&lt;/h2>&lt;p>怎么说呢，在买Gen8之前就已经仔细比较过Hyper-V和ESXI的优劣，最终选择了Hyper-V的方案。&lt;/p>
&lt;p>当时决定选择Hyper-V平台有以下几个理由：&lt;/p>
&lt;ul>
&lt;li>Hyper-V提供的存储池使用方便，用起来简单&lt;/li>
&lt;li>Hyper-V相对于ESXI而言比较轻量，没有ESXI那么多臃肿的功能&lt;/li>
&lt;li>Hyper-V下可以实现硬盘休眠&lt;/li>
&lt;li>其实最主要的原因是，觉得自己的需求不大，哪个简单用哪个&lt;/li>
&lt;/ul>
&lt;p>现在想来真是too young啊，我的需求怎么可能不大呢，Hyper-V自身的限制成了严重的短板。总之，在权衡未来需求和迁移成本之后，决定使用ESXI平台了。&lt;/p>
&lt;p>于是，我从一条不归路&lt;strong>Server2012 With Hyper-V&lt;/strong>走向了另一条不归路&lt;strong>ESXI6.0&lt;/strong>。&lt;/p>
&lt;!-- more -->
&lt;h2 id="第一坑安装esxi之不识别ssd">第一坑：安装ESXI之不识别SSD
&lt;/h2>&lt;p>之前使用Hyper-V平台时，没有采用Gen8提供的硬件RAID功能，使用的Server2012提供的存储池功能，所以切换到ESXI平台时，重新对本地硬盘进行了硬件RAID设置。&lt;/p>
&lt;p>安装ESXI到SD卡的过程略过，按正常操作来，没什么问题。在对ESXI进行配置的时候遇到了问题，系统只能识别到设置了RAID的硬盘，无法识别到SSD。&lt;/p>
&lt;p>网上查了些资料，&lt;strong>RAID模式下识别不到普通硬盘&lt;/strong>，要想识别到SSD，必须对SSD设置RAID，只有一块SSD怎么办？&lt;strong>设置为RAID0&lt;/strong>。&lt;/p>
&lt;h2 id="第二坑安装虚拟机之freenas">第二坑：安装虚拟机之freenas
&lt;/h2>&lt;p>在我的规划中，所有的资料（非虚拟机文件）由freenas进行统一管理，freenas开放smb、nfs服务给其他虚拟机，一方面解决了资料分散，不易管理的问题，另一方面只要保证freenas的可用性，就算其他虚拟机崩溃甚至损坏，都不会对资料有任何影响。&lt;/p>
&lt;p>创建freenas的时候，直接分配全部的磁盘空间（&amp;gt;2T）给freenas的一块虚拟磁盘，然而启动freenas时，一直卡在启动界面，显示磁盘分配错误。&lt;/p>
&lt;p>虽然猜测是分配磁盘过大导致了这个问题，然而在网上并没有查阅到明确的说法。&lt;/p>
&lt;p>在本地做了几个测试后发现，一旦分配磁盘大于2T，freenas就会卡死在启动界面。（真的只是个例？具体原因有待进一步分析）&lt;/p>
&lt;p>当然，临时解决办法也很简单，&lt;strong>把磁盘分拆为多个1T大小的虚拟磁盘&lt;/strong>，挂载给freenas。&lt;/p>
&lt;h2 id="第三坑安装虚拟机之openwrt">第三坑：安装虚拟机之openwrt
&lt;/h2>&lt;p>正常方式安装openwrt，启动openwrt时，会大概率的出现卡死现象。（在《Openwrt上使用dnsmasq和ipset实现域名分流》中已经详细说明具体的原因，这里不再重复）&lt;/p>
&lt;h2 id="第四坑安装虚拟机之dsm">第四坑：安装虚拟机之dsm
&lt;/h2>&lt;p>首先，DSM的版本是XPEnology DSM5.2。&lt;/p>
&lt;p>在Hyper-V上安装dsm非常简单，然而在ESXI上安装完成以后无法进入系统。&lt;/p>
&lt;p>在正常的安装流程中，虚拟机都是由XPEnologyBoot.iso进行引导启动。简单判断以后，觉得可能由于虚拟机重启以后，未能从cd启动导致的。&lt;/p>
&lt;p>进入虚拟机bios修改第一启动项为cd，保存，重新启动，WTF，怎么还是引导不了。&lt;/p>
&lt;p>重新进入bios查看启动项信息，发现上次的修改并没有被保存。（在win10的vmware workstation中进行了相同操作，对vmware的修改是生效的。）&lt;/p>
&lt;p>看来只能放大招了么，&lt;strong>手动修改vmx！&lt;/strong>&lt;/p>
&lt;p>修改虚拟机的&lt;code>.vmx&lt;/code>文件，强制第一启动项为&lt;code>cdrom&lt;/code>：&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-fallback" data-lang="fallback">&lt;span class="line">&lt;span class="cl">bios.bootOrder = &amp;#34;cdrom,hdd,floppy&amp;#34;
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>搞定。&lt;/p>
&lt;h2 id="后记">后记
&lt;/h2>&lt;p>虽然说从Hyper-V切换到ESXI的过程中，遇到了很多不可描述性的问题，但好在都解决了。问我现在用着ESXI的感觉么？感觉还不错:)&lt;/p></description></item><item><title>Openwrt上使用dnsmasq和ipset实现域名分流</title><link>https://www.keepwn.com/posts/route-traffic-selectively-by-domain-on-openwrt/</link><pubDate>Wed, 01 Jun 2016 00:00:00 +0000</pubDate><guid>https://www.keepwn.com/posts/route-traffic-selectively-by-domain-on-openwrt/</guid><description>&lt;h2 id="目标">目标
&lt;/h2>&lt;p>部署一台自动代理路由器，实现根据域名来自动设定直连或者代理，而我要做的只是设置PC的默认网关为主路由器（192.168.0.1）还是自动代理路由器（192.168.0.254）。&lt;/p>
&lt;h2 id="创建openwrt虚拟机">创建Openwrt虚拟机
&lt;/h2>&lt;p>系统版本&lt;/p>
&lt;ul>
&lt;li>主路由器 (ip: &lt;code>192.168.0.1&lt;/code>)&lt;/li>
&lt;li>ESXI 6.0U2&lt;/li>
&lt;li>Openwrt 15.05.1 (ip: &lt;code>192.168.0.254&lt;/code>，gateway: &lt;code>192.168.0.1&lt;/code>)&lt;/li>
&lt;/ul>
&lt;!-- more -->
&lt;p>Openwrt虚拟机的配置教程有很多，这里只针对ESXI版Openwrt可能会遇到的问题说明下：&lt;/p>
&lt;ul>
&lt;li>
&lt;p>在ESXI6上，&lt;code>openwrt_x86&lt;/code>每次启动时会大概率的出现卡死现象，表现为&lt;code>Kernel panic - not syncing: Attempted to kill init&lt;/code>。&lt;/p>
&lt;ul>
&lt;li>&lt;strong>解决办法&lt;/strong>：改用&lt;code>openwrt_x64&lt;/code>后正常。原因未知。&lt;/li>
&lt;/ul>
&lt;/li>
&lt;li>
&lt;p>在ESXI6上，在&lt;code>openwrt&lt;/code>上执行某些命令时，会被强制关机，表现为&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-fallback" data-lang="fallback">&lt;span class="line">&lt;span class="cl">来自 promote 的消息: The operation on the file &amp;#34;/vmfs/devices/deltadisks/17ad1ab5-openwrt-15. 05.1-x86-64-combined-ext4-s001.vmdk&amp;#34; failed (Bad address). The file system where disk &amp;#34;/vmfs /devices/deltadisks/17ad1ab5-openwrt-15.05.1-- x86-64-combined-ext4-s001.vmdk&amp;#34; resides is full. Select _Retry to attempt the operation again. Select Cancel to end the session.
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;ul>
&lt;li>&lt;strong>解决办法&lt;/strong>：在&lt;code>Vmware Fusion&lt;/code>中新建openwrt虚拟机（&lt;em>other/other linux 64, 256MB，虚拟机版本为11&lt;/em>），第一次启动后，关机导出为&lt;code>ova&lt;/code>，然后再导入到ESXI6中。具体原因未知。&lt;/li>
&lt;/ul>
&lt;/li>
&lt;/ul>
&lt;h2 id="安装软件">安装软件
&lt;/h2>&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;span class="lnt">3
&lt;/span>&lt;span class="lnt">4
&lt;/span>&lt;span class="lnt">5
&lt;/span>&lt;span class="lnt">6
&lt;/span>&lt;span class="lnt">7
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-shell" data-lang="shell">&lt;span class="line">&lt;span class="cl">opkg update
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">opkg remove dnsmasq
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">opkg install dnsmasq-full
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">opkg install ipset iptables-mod-nat-extra
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">wget http://x.x.x.x/shadowsocks-libev_2.4.6-1_x86_64.ipk
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">opkg install shadowsocks-libev_2.4.6-1_x86_64.ipk
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>&lt;em>PS&lt;/em>
在这里，安装官方版的shadowsocks，而不是openwrt spec版, 下载地址在&lt;a class="link" href="https://sourceforge.net/projects/openwrt-dist/files/shadowsocks-libev/" target="_blank" rel="noopener"
>这里&lt;/a>。&lt;/p>
&lt;p>&lt;em>PPS&lt;/em>
在这里，如果安装的顺序不同，可能会导致lib的依赖错误(至少在15.05.1上是这样)。使用&lt;code>ldd&lt;/code>命令，检查一下shadowsocks的依赖包是否正常。&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-shell" data-lang="shell">&lt;span class="line">&lt;span class="cl">ldd /usr/bin/ss-redir
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;h2 id="配置">配置
&lt;/h2>&lt;h3 id="配置shadowsocks">配置shadowsocks
&lt;/h3>&lt;p>配置&lt;code>/etc/shadowsocks.json&lt;/code>，格式如下：&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;span class="lnt">3
&lt;/span>&lt;span class="lnt">4
&lt;/span>&lt;span class="lnt">5
&lt;/span>&lt;span class="lnt">6
&lt;/span>&lt;span class="lnt">7
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-json" data-lang="json">&lt;span class="line">&lt;span class="cl">&lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nt">&amp;#34;server&amp;#34;&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="s2">&amp;#34;X.X.X.X&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nt">&amp;#34;server_port&amp;#34;&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="s2">&amp;#34;443&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nt">&amp;#34;password&amp;#34;&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="s2">&amp;#34;password&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nt">&amp;#34;local_port&amp;#34;&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="s2">&amp;#34;1080&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nt">&amp;#34;method&amp;#34;&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="s2">&amp;#34;aes-256-cfb&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>修改&lt;code>/etc/init.d/shadowsocks&lt;/code>，设置shadowsocks以&lt;code>Proxy Mode&lt;/code>模式启动，同时开启&lt;code>转发DNS请求&lt;/code>功能，上游DNS为&lt;code>8.8.8.8&lt;/code>：&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt"> 1
&lt;/span>&lt;span class="lnt"> 2
&lt;/span>&lt;span class="lnt"> 3
&lt;/span>&lt;span class="lnt"> 4
&lt;/span>&lt;span class="lnt"> 5
&lt;/span>&lt;span class="lnt"> 6
&lt;/span>&lt;span class="lnt"> 7
&lt;/span>&lt;span class="lnt"> 8
&lt;/span>&lt;span class="lnt"> 9
&lt;/span>&lt;span class="lnt">10
&lt;/span>&lt;span class="lnt">11
&lt;/span>&lt;span class="lnt">12
&lt;/span>&lt;span class="lnt">13
&lt;/span>&lt;span class="lnt">14
&lt;/span>&lt;span class="lnt">15
&lt;/span>&lt;span class="lnt">16
&lt;/span>&lt;span class="lnt">17
&lt;/span>&lt;span class="lnt">18
&lt;/span>&lt;span class="lnt">19
&lt;/span>&lt;span class="lnt">20
&lt;/span>&lt;span class="lnt">21
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-bash" data-lang="bash">&lt;span class="line">&lt;span class="cl">&lt;span class="cp">#!/bin/sh /etc/rc.common
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="cp">&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nv">START&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="m">95&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nv">SERVICE_USE_PID&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="m">1&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nv">SERVICE_WRITE_PID&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="m">1&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nv">SERVICE_DAEMONIZE&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="m">1&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nv">CONFIG&lt;/span>&lt;span class="o">=&lt;/span>/etc/shadowsocks.json
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">start&lt;span class="o">()&lt;/span> &lt;span class="o">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1">#service_start /usr/bin/ss-local -c $CONFIG -b 0.0.0.0&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> service_start /usr/bin/ss-redir -c &lt;span class="nv">$CONFIG&lt;/span> -b 0.0.0.0
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> service_start /usr/bin/ss-tunnel -c &lt;span class="nv">$CONFIG&lt;/span> -b 0.0.0.0 -l &lt;span class="m">5353&lt;/span> -L 8.8.8.8:53 -u
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="o">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">stop&lt;span class="o">()&lt;/span> &lt;span class="o">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1">#service_stop /usr/bin/ss-local&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> service_stop /usr/bin/ss-redir
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> service_stop /usr/bin/ss-tunnel
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="o">}&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>设置shadowsocks开机启动，并手动运行：&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-shell" data-lang="shell">&lt;span class="line">&lt;span class="cl">/etc/init.d/shadowsocks &lt;span class="nb">enable&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">/etc/init.d/shadowsocks start
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>到目前为止，你已经有了一个监听在1080端口的socks代理，和监听在5353端口的不受污染的DNS服务器&lt;/p>
&lt;h3 id="配置ipset">配置ipset
&lt;/h3>&lt;p>进入Luci界面-网络-防火墙-自定义规则，加入以下规则（最后的&lt;code>1080&lt;/code>是shadowsocks的本地端口，请酌情修改）：&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;span class="lnt">3
&lt;/span>&lt;span class="lnt">4
&lt;/span>&lt;span class="lnt">5
&lt;/span>&lt;span class="lnt">6
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-shell" data-lang="shell">&lt;span class="line">&lt;span class="cl">&lt;span class="c1">#创建名为gfwlist，格式为iphash的集合&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">ipset -N gfwlist iphash
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">#匹配gfwlist中ip的nat流量均被转发到shadowsocks端口&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">iptables -t nat -A PREROUTING -p tcp -m &lt;span class="nb">set&lt;/span> --match-set gfwlist dst -j REDIRECT --to-port &lt;span class="m">1080&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">#匹配gfwlist中ip的本机流量均被转发到shadowsocks端口&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">iptables -t nat -A OUTPUT -p tcp -m &lt;span class="nb">set&lt;/span> --match-set gfwlist dst -j REDIRECT --to-port &lt;span class="m">1080&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;h3 id="配置dnsmasq-full">配置dnsmasq-full
&lt;/h3>&lt;p>修改&lt;code>/etc/dnsmasq.conf&lt;/code>，在文末加入&lt;code>conf-dir=/etc/dnsmasq.d&lt;/code>：&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-shell" data-lang="shell">&lt;span class="line">&lt;span class="cl">&lt;span class="nb">echo&lt;/span> &lt;span class="s1">&amp;#39;conf-dir=/etc/dnsmasq.d&amp;#39;&lt;/span> &amp;gt;&amp;gt; /etc/dnsmasq.conf
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>新建目录&lt;code>/etc/dnsmasq.d&lt;/code>，生成&lt;code>dnsmasq_list.conf&lt;/code> 到该目录：&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;span class="lnt">3
&lt;/span>&lt;span class="lnt">4
&lt;/span>&lt;span class="lnt">5
&lt;/span>&lt;span class="lnt">6
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-shell" data-lang="shell">&lt;span class="line">&lt;span class="cl">git clone https://github.com/cokebar/gfwlist2dnsmasq.git
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nb">cd&lt;/span> gfwlist2dnsmasq
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">python2 gfwlist2dnsmasq.py
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">mkdir /etc/dnsmasq.d
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">cp dnsmasq_list.conf /etc/dnsmasq.d
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>其中，&lt;code>dnsmasq_list.conf&lt;/code>的格式为：&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;span class="lnt">3
&lt;/span>&lt;span class="lnt">4
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-ini" data-lang="ini">&lt;span class="line">&lt;span class="cl">&lt;span class="c1">#使用不受污染的DNS解析该域名,可以将此IP改为自己使用的DNS服务器&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="na">server&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="s">/google.com/127.0.0.1#5353&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">#将解析出来的IP保存到名为gfwlist的ipset表中&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="na">ipset&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="s">/google.com/gfwlist&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>你可以手动修改这个文件，你也可以使用&lt;code>gfwlist2dnsmasq.py&lt;/code>自动生成dnsmasq_list版的gfwlist列表。&lt;/p>
&lt;p>重新运行&lt;code>dnsmasq&lt;/code>，它将监听在本机&lt;code>53&lt;/code>端口上。&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-shell" data-lang="shell">&lt;span class="line">&lt;span class="cl">/etc/init.d/dnsmasq restart
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;h2 id="测试">测试
&lt;/h2>&lt;p>场景一&lt;/p>
&lt;ul>
&lt;li>PC端的默认网关设置为&lt;code>192.168.0.1&lt;/code>, DNS设置为&lt;code>192.168.0.1&lt;/code>
&lt;ul>
&lt;li>国内网站访问正常&lt;/li>
&lt;li>Google无法访问&lt;/li>
&lt;/ul>
&lt;/li>
&lt;/ul>
&lt;p>场景二&lt;/p>
&lt;ul>
&lt;li>PC端的默认网关设置为&lt;code>192.168.0.254&lt;/code>, DNS设置为&lt;code>192.168.0.254&lt;/code>
&lt;ul>
&lt;li>访问国内网站
&lt;ul>
&lt;li>dnsmasq解析该域名，发现该域名不在dnsmasq_list中，使用默认DNS服务器进行解析，正常访问。&lt;/li>
&lt;/ul>
&lt;/li>
&lt;li>访问Google
&lt;ul>
&lt;li>dnsmasq解析该域名，发现该域名在dnsmasq_list中，使用设置的安全DNS服务器进行解析，并将该IP加至gfwlist集合中，iptables匹配到规则，将流量转发到shadowsocks监听的端口，进行代理访问。&lt;/li>
&lt;/ul>
&lt;/li>
&lt;/ul>
&lt;/li>
&lt;/ul>
&lt;h2 id="参考">参考
&lt;/h2>&lt;ul>
&lt;li>&lt;a class="link" href="https://blog.sorz.org/p/openwrt-outwall/" target="_blank" rel="noopener"
>https://blog.sorz.org/p/openwrt-outwall/&lt;/a>&lt;/li>
&lt;li>&lt;a class="link" href="http://aenes.com/post/740.html" target="_blank" rel="noopener"
>http://aenes.com/post/740.html&lt;/a>&lt;/li>
&lt;li>&lt;a class="link" href="https://php-rmcr7.rhcloud.com/openwrt-fq/" target="_blank" rel="noopener"
>https://php-rmcr7.rhcloud.com/openwrt-fq/&lt;/a>&lt;/li>
&lt;li>&lt;a class="link" href="https://cokebar.info/archives/962/comment-page-2/#comments" target="_blank" rel="noopener"
>https://cokebar.info/archives/962/comment-page-2/#comments&lt;/a>&lt;/li>
&lt;/ul></description></item><item><title>Pi2版OMV的Monit连接错误的问题</title><link>https://www.keepwn.com/posts/error-connecting-to-the-monit-daemon-in-omv-for-pi2/</link><pubDate>Thu, 17 Dec 2015 00:00:00 +0000</pubDate><guid>https://www.keepwn.com/posts/error-connecting-to-the-monit-daemon-in-omv-for-pi2/</guid><description>&lt;h2 id="背景">背景
&lt;/h2>&lt;p>之前买了个树莓派2，闲置了很久，最近正好有NAS需求，就打算拿它装个&lt;code>OpenMediaVault&lt;/code>玩玩。&lt;/p>
&lt;p>安装过程不表。&lt;/p>
&lt;p>事实上是在使用过程中，遇到的某个问题比较奇葩，就拿来分享了。&lt;/p>
&lt;h2 id="林尽水源">林尽水源
&lt;/h2>&lt;p>在网页端对OMV进行配置时，经常会遇到一个弹窗&lt;code>monit: Cannot connect to the monit daemon. Did you start it with http support?&lt;/code>。&lt;/p>
&lt;p>详细错误代码如下：&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt"> 1
&lt;/span>&lt;span class="lnt"> 2
&lt;/span>&lt;span class="lnt"> 3
&lt;/span>&lt;span class="lnt"> 4
&lt;/span>&lt;span class="lnt"> 5
&lt;/span>&lt;span class="lnt"> 6
&lt;/span>&lt;span class="lnt"> 7
&lt;/span>&lt;span class="lnt"> 8
&lt;/span>&lt;span class="lnt"> 9
&lt;/span>&lt;span class="lnt">10
&lt;/span>&lt;span class="lnt">11
&lt;/span>&lt;span class="lnt">12
&lt;/span>&lt;span class="lnt">13
&lt;/span>&lt;span class="lnt">14
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-gdscript3" data-lang="gdscript3">&lt;span class="line">&lt;span class="cl">&lt;span class="n">exception&lt;/span> &lt;span class="s1">&amp;#39;OMVException&amp;#39;&lt;/span> &lt;span class="n">with&lt;/span> &lt;span class="n">message&lt;/span> &lt;span class="s1">&amp;#39;Failed to execute command &amp;#39;&lt;/span>&lt;span class="k">export&lt;/span> &lt;span class="n">LANG&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="n">C&lt;/span>&lt;span class="p">;&lt;/span> &lt;span class="n">monit&lt;/span> &lt;span class="n">restart&lt;/span> &lt;span class="n">collectd&lt;/span> &lt;span class="mi">2&lt;/span>&lt;span class="o">&amp;gt;&amp;amp;&lt;/span>&lt;span class="mi">1&lt;/span>&lt;span class="s1">&amp;#39;: monit: Cannot connect to the monit daemon. Did you start it with http support?&amp;#39;&lt;/span> &lt;span class="ow">in&lt;/span> &lt;span class="o">/&lt;/span>&lt;span class="n">usr&lt;/span>&lt;span class="o">/&lt;/span>&lt;span class="n">share&lt;/span>&lt;span class="o">/&lt;/span>&lt;span class="n">php&lt;/span>&lt;span class="o">/&lt;/span>&lt;span class="n">openmediavault&lt;/span>&lt;span class="o">/&lt;/span>&lt;span class="n">monit&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">inc&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="mi">113&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="n">Stack&lt;/span> &lt;span class="n">trace&lt;/span>&lt;span class="p">:&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">#0 /usr/share/php/openmediavault/monit.inc(70): OMVMonit-&amp;gt;action(&amp;#39;restart&amp;#39;, &amp;#39;collectd&amp;#39;, false)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">#1 /usr/share/openmediavault/engined/module/collectd.inc(53): OMVMonit-&amp;gt;restart(&amp;#39;collectd&amp;#39;)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">#2 /usr/share/openmediavault/engined/rpc/config.inc(206): OMVModuleCollectd-&amp;gt;startService()&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">#3 [internal function]: OMVRpcServiceConfig-&amp;gt;applyChanges(Array, Array)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">#4 /usr/share/php/openmediavault/rpcservice.inc(125): call_user_func_array(Array, Array)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">#5 /usr/share/php/openmediavault/rpcservice.inc(158): OMVRpcServiceAbstract-&amp;gt;callMethod(&amp;#39;applyChanges&amp;#39;, Array, Array)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">#6 /usr/share/openmediavault/engined/rpc/config.inc(224): OMVRpcServiceAbstract-&amp;gt;callMethodBg(&amp;#39;applyChanges&amp;#39;, Array, Array)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">#7 [internal function]: OMVRpcServiceConfig-&amp;gt;applyChangesBg(Array, Array)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">#8 /usr/share/php/openmediavault/rpcservice.inc(125): call_user_func_array(Array, Array)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">#9 /usr/share/php/openmediavault/rpc.inc(79): OMVRpcServiceAbstract-&amp;gt;callMethod(&amp;#39;applyChangesBg&amp;#39;, Array, Array)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">#10 /usr/sbin/omv-engined(500): OMVRpc::exec(&amp;#39;Config&amp;#39;, &amp;#39;applyChangesBg&amp;#39;, Array, Array, 1)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">#11 {main}&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>ssh到&lt;code>OMV&lt;/code>终端，输入命令：&lt;code>monit status&lt;/code>，似乎错误信息也一样：&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-fallback" data-lang="fallback">&lt;span class="line">&lt;span class="cl">monit: error connecting to the monit daemon
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>在这种情况下，&lt;code>OMV&lt;/code>就无法应用配置，必须解决这问题。&lt;/p>
&lt;!-- more -->
&lt;h2 id="初仿佛若有光">初仿佛若有光
&lt;/h2>&lt;p>于是去google上找啊，找啊，终于找到一篇帖子，遇到了&lt;a class="link" href="http://forums.openmediavault.org/index.php/Thread/8973-Failed-to-execute-command-export-LANG-C-monit-restart-collectd-2-1-monit/" title="Failed to execute command &amp;#39;export LANG=C; monit restart collectd 2&amp;gt;&amp;amp;1&amp;#39;: monit"
target="_blank" rel="noopener"
>相似的问题&lt;/a>（竟然不是StackOverflow，差评！)&lt;/p>
&lt;div class="admonition quote">
&lt;div class="details-summary admonition-title">
&lt;i class='icon fas fa-quote-right fa-fw'>&lt;/i>
Quote
&lt;/div>
&lt;div class="details-content">
&lt;div class="admonition-content">
&lt;p>Because ntpdate is installed in the image. Both ntp server and ntpdate cannot be installed at the same time. Also, the config for the ntp server does not work&amp;hellip;.&lt;/p>
&lt;p>apt-get &amp;ndash;purge remove ntpdate&lt;/p>
&lt;p>Then in the OMV web gui set your timezone because after these changes you cannot set it again.&lt;/p>
&lt;p>then edit /etc/ntp.conf:&lt;/p>
&lt;p>remove these lines:
server 127.127.1.0 # Local clock
fudge 127.127.1.0 stratum 12
server pool.ntp.org iburst&lt;/p>
&lt;p>And replace with these:
server 0.no.pool.ntp.org iburst
server 1.no.pool.ntp.org iburst
server 2.no.pool.ntp.org iburst
server 3.no.pool.ntp.org iburst&lt;/p>
&lt;p>Then you can:
service ntp restart&lt;/p>
&lt;p>Do not disable/enable in the OMV web gui again. The mkconf file for the ntp service will overwrite thesechanges. There need to be some updates so it works properly with the rpi 2.&lt;/p>
&lt;p>Your logs files and dates at boot will be all messed up with wrong dates until you install a RTC module. After boot it takes some minutes before the ntp server will update the time/date. With a RTC module everything is perfect at boot.&lt;/p>
&lt;/div>
&lt;/div>
&lt;/div>
&lt;p>总结几点就是：&lt;/p>
&lt;ul>
&lt;li>&lt;code>Monit&lt;/code>的错误和系统时间有关
&lt;ul>
&lt;li>（检查了一下，确实系统当前时间错误）&lt;/li>
&lt;/ul>
&lt;/li>
&lt;li>&lt;code>ntpdate&lt;/code>与&lt;code>ntp server&lt;/code>有冲突，不能同时安装
&lt;ul>
&lt;li>（检查了一下，ntp服务启动失败）&lt;/li>
&lt;/ul>
&lt;/li>
&lt;li>&lt;code>OMV&lt;/code>自带的ntp配置&lt;code>/etc/ntp.conf&lt;/code>有错误&lt;/li>
&lt;li>你应该安装&lt;code>RTC&lt;/code>模块&lt;/li>
&lt;/ul>
&lt;h2 id="复行数十步">复行数十步
&lt;/h2>&lt;p>按照前面这位贤者的建议，我分别进行了一下几个测试：&lt;/p>
&lt;ul>
&lt;li>测试一: 手动修改当前时间，卸载&lt;code>ntpdate&lt;/code>，关闭&lt;code>ntp&lt;/code>服务
&lt;ul>
&lt;li>重启以后，时间丢失&lt;/li>
&lt;/ul>
&lt;/li>
&lt;li>测试二: 卸载&lt;code>ntpdate&lt;/code>，不修改&lt;code>ntp&lt;/code>配置文件
&lt;ul>
&lt;li>&lt;code>ntp&lt;/code>服务正常启动，时间同步正确&lt;/li>
&lt;li>重启以后，&lt;code>ntp&lt;/code>服务正常启动，时间无法同步&lt;/li>
&lt;/ul>
&lt;/li>
&lt;li>测试三: 卸载&lt;code>ntpdate&lt;/code>，修改&lt;code>ntp&lt;/code>配置文件
&lt;ul>
&lt;li>&lt;code>ntp&lt;/code>服务正常启动，时间同步正确&lt;/li>
&lt;li>重启以后，&lt;code>ntp&lt;/code>服务正常启动，时间无法同步&lt;/li>
&lt;/ul>
&lt;/li>
&lt;li>测试四: 运行&lt;code>ntpdate&lt;/code>，强制同步
&lt;ul>
&lt;li>时间同步正确&lt;/li>
&lt;li>重启以后，&lt;code>ntp&lt;/code>服务不能正常启动，时间无法同步&lt;/li>
&lt;/ul>
&lt;/li>
&lt;/ul>
&lt;p>测试后发现，因为树莓派本身的硬件限制，系统重启后会丢失当前时间。&lt;/p>
&lt;p>尽管开启了&lt;code>ntp&lt;/code>服务，但是如果系统当前时间与真实时间跨度太大，则不会进行同步。&lt;/p>
&lt;p>所以只能放弃&lt;code>ntp server&lt;/code>，转而使用&lt;code>ntpdate&lt;/code>来强制同步时间，并设置开机启动。&lt;/p>
&lt;p>代码如下：&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;span class="lnt">3
&lt;/span>&lt;span class="lnt">4
&lt;/span>&lt;span class="lnt">5
&lt;/span>&lt;span class="lnt">6
&lt;/span>&lt;span class="lnt">7
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-fallback" data-lang="fallback">&lt;span class="line">&lt;span class="cl"># 设置开机同步时间，注意: 添加的代码必须在`exit 0`之前
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">echo &amp;#39;/usr/sbin/ntpdate 0.cn.pool.ntp.org&amp;#39; &amp;gt;&amp;gt; /etc/rc.local
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"># 设置同步任务，每隔5分钟同步一次时间
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"># 编辑crontab，并保存
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">crontab -e
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">*/5 * * * * /usr/sbin/ntpdate 0.cn.pool.ntp.org
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>重启系统，系统时间已经正确了。&lt;/p>
&lt;p>在网页端对&lt;code>OMV&lt;/code>重新进行配置。WTF，怎么还是&lt;code>monit&lt;/code>这个问题！&lt;/p>
&lt;h2 id="豁然开朗">豁然开朗
&lt;/h2>&lt;p>登入终端，重新进行检查：&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;span class="lnt">3
&lt;/span>&lt;span class="lnt">4
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-shell" data-lang="shell">&lt;span class="line">&lt;span class="cl">root@raspberrypi:~# date
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">Dec &lt;span class="m">16&lt;/span> 11:12:04 CST &lt;span class="m">2015&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">root@raspberrypi:~# monit status
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">monit: error connecting to the monit daemon
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>到这里时，我当时确实很疑惑，明明系统时间已经正确了，为什么&lt;code>monit&lt;/code>还是报错呢。&lt;/p>
&lt;p>突然灵光乍现，重新启动&lt;code>monit&lt;/code>服务，然后十几秒过后：&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt"> 1
&lt;/span>&lt;span class="lnt"> 2
&lt;/span>&lt;span class="lnt"> 3
&lt;/span>&lt;span class="lnt"> 4
&lt;/span>&lt;span class="lnt"> 5
&lt;/span>&lt;span class="lnt"> 6
&lt;/span>&lt;span class="lnt"> 7
&lt;/span>&lt;span class="lnt"> 8
&lt;/span>&lt;span class="lnt"> 9
&lt;/span>&lt;span class="lnt">10
&lt;/span>&lt;span class="lnt">11
&lt;/span>&lt;span class="lnt">12
&lt;/span>&lt;span class="lnt">13
&lt;/span>&lt;span class="lnt">14
&lt;/span>&lt;span class="lnt">15
&lt;/span>&lt;span class="lnt">16
&lt;/span>&lt;span class="lnt">17
&lt;/span>&lt;span class="lnt">18
&lt;/span>&lt;span class="lnt">19
&lt;/span>&lt;span class="lnt">20
&lt;/span>&lt;span class="lnt">21
&lt;/span>&lt;span class="lnt">22
&lt;/span>&lt;span class="lnt">23
&lt;/span>&lt;span class="lnt">24
&lt;/span>&lt;span class="lnt">25
&lt;/span>&lt;span class="lnt">26
&lt;/span>&lt;span class="lnt">27
&lt;/span>&lt;span class="lnt">28
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-shell" data-lang="shell">&lt;span class="line">&lt;span class="cl">root@raspberrypi:~# monit status
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">The Monit daemon 5.4 uptime: 18m
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">System &lt;span class="s1">&amp;#39;localhost&amp;#39;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> status Running
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> monitoring status Monitored
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> load average &lt;span class="o">[&lt;/span>0.00&lt;span class="o">]&lt;/span> &lt;span class="o">[&lt;/span>0.01&lt;span class="o">]&lt;/span> &lt;span class="o">[&lt;/span>0.05&lt;span class="o">]&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> cpu 0.0%us 0.1%sy 0.0%wa
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> memory usage &lt;span class="m">55424&lt;/span> kB &lt;span class="o">[&lt;/span>5.5%&lt;span class="o">]&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> swap usage &lt;span class="m">0&lt;/span> kB &lt;span class="o">[&lt;/span>0.0%&lt;span class="o">]&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> data collected &lt;span class="m">16&lt;/span> Dec &lt;span class="m">2015&lt;/span> 11:12:17
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">...
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">Process &lt;span class="s1">&amp;#39;collectd&amp;#39;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> status Running
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> monitoring status Monitored
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> pid &lt;span class="m">2535&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> parent pid &lt;span class="m">1&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> uptime 18m
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> children &lt;span class="m">0&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> memory kilobytes &lt;span class="m">4224&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> memory kilobytes total &lt;span class="m">4224&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> memory percent 0.4%
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> memory percent total 0.4%
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> cpu percent 0.0%
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> cpu percent total 0.0%
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> data collected &lt;span class="m">16&lt;/span> Dec &lt;span class="m">2015&lt;/span> 11:12:17
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>在此个人分析，在&lt;code>monit&lt;/code>服务启动时，系统时间还未同步，所以&lt;code>monit&lt;/code>初始化失败。只要保证在时间同步后，再重启&lt;code>monit&lt;/code>服务应该就可以了。&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-fallback" data-lang="fallback">&lt;span class="line">&lt;span class="cl"># 在强制同步时间后，再重启monit服务
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">echo &amp;#39;/etc/init.d/monit restart&amp;#39; &amp;gt;&amp;gt; /etc/rc.local
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>重启系统，一切正常。END！&lt;/p>
&lt;h2 id="参考">参考
&lt;/h2>&lt;ul>
&lt;li>&lt;a class="link" href="http://forums.openmediavault.org/index.php/Thread/8973-Failed-to-execute-command-export-LANG-C-monit-restart-collectd-2-1-monit/" target="_blank" rel="noopener"
>http://forums.openmediavault.org/index.php/Thread/8973-Failed-to-execute-command-export-LANG-C-monit-restart-collectd-2-1-monit/&lt;/a>&lt;/li>
&lt;li>&lt;a class="link" href="http://forums.openmediavault.org/index.php/Thread/8770-RPi-2-RTC-module-from-unruly-Stepchild-to-Wunderkind/" target="_blank" rel="noopener"
>http://forums.openmediavault.org/index.php/Thread/8770-RPi-2-RTC-module-from-unruly-Stepchild-to-Wunderkind/&lt;/a>&lt;/li>
&lt;li>&lt;a class="link" href="https://www.raspberrypi.org/forums/viewtopic.php?f=91&amp;amp;t=83344" target="_blank" rel="noopener"
>https://www.raspberrypi.org/forums/viewtopic.php?f=91&amp;t=83344&lt;/a>&lt;/li>
&lt;/ul></description></item></channel></rss>