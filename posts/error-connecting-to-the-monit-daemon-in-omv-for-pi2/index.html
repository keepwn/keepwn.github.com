<!doctype html><html lang=zh dir=auto><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=robots content="index, follow"><title>Pi2版OMV的Monit连接错误的问题 | KeePwn's Notes</title><meta name=keywords content="raspberrypi,omv,monit,ntp"><meta name=description content="背景 之前买了个树莓派2，闲置了很久，最近正好有NAS需求，就打算拿它装个OpenMediaVault玩玩。
安装过程不表。
事实上是在使用过程中，遇到的某个问题比较奇葩，就拿来分享了。
林尽水源 在网页端对OMV进行配置时，经常会遇到一个弹窗monit: Cannot connect to the monit daemon. Did you start it with http support?。
详细错误代码如下：
exception 'OMVException' with message 'Failed to execute command 'export LANG=C; monit restart collectd 2>&1': monit: Cannot connect to the monit daemon. Did you start it with http support?' in /usr/share/php/openmediavault/monit.inc:113 Stack trace: #0 /usr/share/php/openmediavault/monit.inc(70): OMVMonit->action('restart', 'collectd', false) #1 /usr/share/openmediavault/engined/module/collectd.inc(53): OMVMonit->restart('collectd') #2 /usr/share/openmediavault/engined/rpc/config.inc(206): OMVModuleCollectd->startService() #3 [internal function]: OMVRpcServiceConfig->applyChanges(Array, Array) #4 /usr/share/php/openmediavault/rpcservice.inc(125): call_user_func_array(Array, Array) #5 /usr/share/php/openmediavault/rpcservice."><meta name=author content="keepwn"><link rel=canonical href=https://www.keepwn.com/posts/error-connecting-to-the-monit-daemon-in-omv-for-pi2/><meta name=google-site-verification content="xMak_7WE4_KOO1YEi_bgkoTs5tahDUulVkZUAG831RA"><link href=//cdn.bootcdn.net/ajax/libs/font-awesome/4.6.2/css/font-awesome.min.css rel=stylesheet type=text/css><link href=/assets/css/stylesheet.min.b18d2192b46ee057ab44baca1a2f3dcd088499657810f879e44342f68066ec97.css integrity="sha256-sY0hkrRu4FerRLrKGi89zQiEmWV4EPh55ENC9oBm7Jc=" rel="preload stylesheet" as=style><link rel=icon href=https://www.keepwn.com/favicon.ico><link rel=icon type=image/png sizes=16x16 href=https://www.keepwn.com/favicon-16x16.png><link rel=icon type=image/png sizes=32x32 href=https://www.keepwn.com/favicon-32x32.png><link rel=apple-touch-icon href=https://www.keepwn.com/apple-touch-icon.png><link rel=mask-icon href=https://www.keepwn.com/safari-pinned-tab.svg><meta name=theme-color content="#2e2e33"><meta name=msapplication-TileColor content="#2e2e33"><meta name=generator content="Hugo 0.82.0"><script type=application/javascript>var doNotTrack=!1;doNotTrack||(window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)},ga.l=+new Date,ga('create','UA-52738842-1','auto'),ga('send','pageview'))</script><script async src=https://www.google-analytics.com/analytics.js></script><meta property="og:title" content="Pi2版OMV的Monit连接错误的问题"><meta property="og:description" content="背景 之前买了个树莓派2，闲置了很久，最近正好有NAS需求，就打算拿它装个OpenMediaVault玩玩。
安装过程不表。
事实上是在使用过程中，遇到的某个问题比较奇葩，就拿来分享了。
林尽水源 在网页端对OMV进行配置时，经常会遇到一个弹窗monit: Cannot connect to the monit daemon. Did you start it with http support?。
详细错误代码如下：
exception 'OMVException' with message 'Failed to execute command 'export LANG=C; monit restart collectd 2>&1': monit: Cannot connect to the monit daemon. Did you start it with http support?' in /usr/share/php/openmediavault/monit.inc:113 Stack trace: #0 /usr/share/php/openmediavault/monit.inc(70): OMVMonit->action('restart', 'collectd', false) #1 /usr/share/openmediavault/engined/module/collectd.inc(53): OMVMonit->restart('collectd') #2 /usr/share/openmediavault/engined/rpc/config.inc(206): OMVModuleCollectd->startService() #3 [internal function]: OMVRpcServiceConfig->applyChanges(Array, Array) #4 /usr/share/php/openmediavault/rpcservice.inc(125): call_user_func_array(Array, Array) #5 /usr/share/php/openmediavault/rpcservice."><meta property="og:type" content="article"><meta property="og:url" content="https://www.keepwn.com/posts/error-connecting-to-the-monit-daemon-in-omv-for-pi2/"><meta property="article:section" content="posts"><meta property="article:published_time" content="2015-12-17T00:00:00+00:00"><meta name=twitter:card content="summary"><meta name=twitter:title content="Pi2版OMV的Monit连接错误的问题"><meta name=twitter:description content="背景 之前买了个树莓派2，闲置了很久，最近正好有NAS需求，就打算拿它装个OpenMediaVault玩玩。
安装过程不表。
事实上是在使用过程中，遇到的某个问题比较奇葩，就拿来分享了。
林尽水源 在网页端对OMV进行配置时，经常会遇到一个弹窗monit: Cannot connect to the monit daemon. Did you start it with http support?。
详细错误代码如下：
exception 'OMVException' with message 'Failed to execute command 'export LANG=C; monit restart collectd 2>&1': monit: Cannot connect to the monit daemon. Did you start it with http support?' in /usr/share/php/openmediavault/monit.inc:113 Stack trace: #0 /usr/share/php/openmediavault/monit.inc(70): OMVMonit->action('restart', 'collectd', false) #1 /usr/share/openmediavault/engined/module/collectd.inc(53): OMVMonit->restart('collectd') #2 /usr/share/openmediavault/engined/rpc/config.inc(206): OMVModuleCollectd->startService() #3 [internal function]: OMVRpcServiceConfig->applyChanges(Array, Array) #4 /usr/share/php/openmediavault/rpcservice.inc(125): call_user_func_array(Array, Array) #5 /usr/share/php/openmediavault/rpcservice."><script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":2,"name":"Posts","item":"https://www.keepwn.com/posts/"},{"@type":"ListItem","position":3,"name":"Pi2版OMV的Monit连接错误的问题","item":"https://www.keepwn.com/posts/error-connecting-to-the-monit-daemon-in-omv-for-pi2/"}]}</script><script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","headline":"Pi2版OMV的Monit连接错误的问题","name":"Pi2版OMV的Monit连接错误的问题","description":"背景 之前买了个树莓派2，闲置了很久，最近正好有NAS需求，就打算拿它装个OpenMediaVault玩玩。\n安装过程不表。\n事实上是在使用过程中，遇到的某个问题比较奇葩，就拿来分享了。\n林尽水源 在网页端对OMV进行配置时，经常会遇到一个弹窗monit: Cannot connect to the monit daemon. Did you start it with http support?。\n详细错误代码如下：\nexception 'OMVException' with message 'Failed to execute command 'export LANG=C; monit restart collectd 2\u0026gt;\u0026amp;1': monit: Cannot connect to the monit daemon. Did you start it with http support?' in /usr/share/php/openmediavault/monit.inc:113 Stack trace: #0 /usr/share/php/openmediavault/monit.inc(70): OMVMonit-\u0026gt;action('restart', 'collectd', false) #1 /usr/share/openmediavault/engined/module/collectd.inc(53): OMVMonit-\u0026gt;restart('collectd') #2 /usr/share/openmediavault/engined/rpc/config.inc(206): OMVModuleCollectd-\u0026gt;startService() #3 [internal function]: OMVRpcServiceConfig-\u0026gt;applyChanges(Array, Array) #4 /usr/share/php/openmediavault/rpcservice.inc(125): call_user_func_array(Array, Array) #5 /usr/share/php/openmediavault/rpcservice.","keywords":["raspberrypi","omv","monit","ntp"],"articleBody":"背景 之前买了个树莓派2，闲置了很久，最近正好有NAS需求，就打算拿它装个OpenMediaVault玩玩。\n安装过程不表。\n事实上是在使用过程中，遇到的某个问题比较奇葩，就拿来分享了。\n林尽水源 在网页端对OMV进行配置时，经常会遇到一个弹窗monit: Cannot connect to the monit daemon. Did you start it with http support?。\n详细错误代码如下：\nexception 'OMVException' with message 'Failed to execute command 'export LANG=C; monit restart collectd 2\u00261': monit: Cannot connect to the monit daemon. Did you start it with http support?' in /usr/share/php/openmediavault/monit.inc:113 Stack trace: #0 /usr/share/php/openmediavault/monit.inc(70): OMVMonit-action('restart', 'collectd', false) #1 /usr/share/openmediavault/engined/module/collectd.inc(53): OMVMonit-restart('collectd') #2 /usr/share/openmediavault/engined/rpc/config.inc(206): OMVModuleCollectd-startService() #3 [internal function]: OMVRpcServiceConfig-applyChanges(Array, Array) #4 /usr/share/php/openmediavault/rpcservice.inc(125): call_user_func_array(Array, Array) #5 /usr/share/php/openmediavault/rpcservice.inc(158): OMVRpcServiceAbstract-callMethod('applyChanges', Array, Array) #6 /usr/share/openmediavault/engined/rpc/config.inc(224): OMVRpcServiceAbstract-callMethodBg('applyChanges', Array, Array) #7 [internal function]: OMVRpcServiceConfig-applyChangesBg(Array, Array) #8 /usr/share/php/openmediavault/rpcservice.inc(125): call_user_func_array(Array, Array) #9 /usr/share/php/openmediavault/rpc.inc(79): OMVRpcServiceAbstract-callMethod('applyChangesBg', Array, Array) #10 /usr/sbin/omv-engined(500): OMVRpc::exec('Config', 'applyChangesBg', Array, Array, 1) #11 {main} ssh到OMV终端，输入命令：monit status，似乎错误信息也一样：\nmonit: error connecting to the monit daemon 在这种情况下，OMV就无法应用配置，必须解决这问题。\n初仿佛若有光 于是去google上找啊，找啊，终于找到一篇帖子，遇到了\u00261': monit\"相似的问题（竟然不是StackOverflow，差评！)\nBecause ntpdate is installed in the image. Both ntp server and ntpdate cannot be installed at the same time. Also, the config for the ntp server does not work….\napt-get –purge remove ntpdate\nThen in the OMV web gui set your timezone because after these changes you cannot set it again.\nthen edit /etc/ntp.conf:\nremove these lines:\nserver 127.127.1.0 # Local clock\nfudge 127.127.1.0 stratum 12\nserver pool.ntp.org iburst\nAnd replace with these:\nserver 0.no.pool.ntp.org iburst\nserver 1.no.pool.ntp.org iburst\nserver 2.no.pool.ntp.org iburst\nserver 3.no.pool.ntp.org iburst\nThen you can:\nservice ntp restart\nDo not disable/enable in the OMV web gui again. The mkconf file for the ntp service will overwrite thesechanges. There need to be some updates so it works properly with the rpi 2.\nYour logs files and dates at boot will be all messed up with wrong dates until you install a RTC module. After boot it takes some minutes before the ntp server will update the time/date. With a RTC module everything is perfect at boot.\n  总结几点就是：\n Monit的错误和系统时间有关  （检查了一下，确实系统当前时间错误）   ntpdate与ntp server有冲突，不能同时安装  （检查了一下，ntp服务启动失败）   OMV自带的ntp配置/etc/ntp.conf有错误 你应该安装RTC模块  复行数十步 按照前面这位贤者的建议，我分别进行了一下几个测试：\n 测试一: 手动修改当前时间，卸载ntpdate，关闭ntp服务  重启以后，时间丢失   测试二: 卸载ntpdate，不修改ntp配置文件  ntp服务正常启动，时间同步正确 重启以后，ntp服务正常启动，时间无法同步   测试三: 卸载ntpdate，修改ntp配置文件  ntp服务正常启动，时间同步正确 重启以后，ntp服务正常启动，时间无法同步   测试四: 运行ntpdate，强制同步  时间同步正确 重启以后，ntp服务不能正常启动，时间无法同步    测试后发现，因为树莓派本身的硬件限制，系统重启后会丢失当前时间。\n尽管开启了ntp服务，但是如果系统当前时间与真实时间跨度太大，则不会进行同步。\n所以只能放弃ntp server，转而使用ntpdate来强制同步时间，并设置开机启动。\n代码如下：\n# 设置开机同步时间，注意: 添加的代码必须在`exit 0`之前 echo '/usr/sbin/ntpdate 0.cn.pool.ntp.org'  /etc/rc.local # 设置同步任务，每隔5分钟同步一次时间 # 编辑crontab，并保存 crontab -e */5 * * * * /usr/sbin/ntpdate 0.cn.pool.ntp.org 重启系统，系统时间已经正确了。\n在网页端对OMV重新进行配置。WTF，怎么还是monit这个问题！\n豁然开朗 登入终端，重新进行检查：\nroot@raspberrypi:~# date Dec 16 11:12:04 CST 2015 root@raspberrypi:~# monit status monit: error connecting to the monit daemon 到这里时，我当时确实很疑惑，明明系统时间已经正确了，为什么monit还是报错呢。\n突然灵光乍现，重新启动monit服务，然后十几秒过后：\nroot@raspberrypi:~# monit status The Monit daemon 5.4 uptime: 18m System 'localhost' status Running monitoring status Monitored load average [0.00] [0.01] [0.05] cpu 0.0%us 0.1%sy 0.0%wa memory usage 55424 kB [5.5%] swap usage 0 kB [0.0%] data collected 16 Dec 2015 11:12:17 ... Process 'collectd' status Running monitoring status Monitored pid 2535 parent pid 1 uptime 18m children 0 memory kilobytes 4224 memory kilobytes total 4224 memory percent 0.4% memory percent total 0.4% cpu percent 0.0% cpu percent total 0.0% data collected 16 Dec 2015 11:12:17 在此个人分析，在monit服务启动时，系统时间还未同步，所以monit初始化失败。只要保证在时间同步后，再重启monit服务应该就可以了。\n# 在强制同步时间后，再重启monit服务 echo '/etc/init.d/monit restart'  /etc/rc.local 重启系统，一切正常。END！\n参考  http://forums.openmediavault.org/index.php/Thread/8973-Failed-to-execute-command-export-LANG-C-monit-restart-collectd-2-1-monit/ http://forums.openmediavault.org/index.php/Thread/8770-RPi-2-RTC-module-from-unruly-Stepchild-to-Wunderkind/ https://www.raspberrypi.org/forums/viewtopic.php?f=91\u0026t=83344  ","wordCount":"458","inLanguage":"zh","datePublished":"2015-12-17T00:00:00Z","dateModified":"0001-01-01T00:00:00Z","author":{"@type":"Person","name":"keepwn"},"mainEntityOfPage":{"@type":"WebPage","@id":"https://www.keepwn.com/posts/error-connecting-to-the-monit-daemon-in-omv-for-pi2/"},"publisher":{"@type":"Organization","name":"KeePwn's Notes","logo":{"@type":"ImageObject","url":"https://www.keepwn.com/favicon.ico"}}}</script></head><body id=top><script>localStorage.getItem("pref-theme")==="dark"?document.body.classList.add('dark'):localStorage.getItem("pref-theme")==="light"?document.body.classList.remove('dark'):window.matchMedia('(prefers-color-scheme: dark)').matches&&document.body.classList.add('dark')</script><noscript><style type=text/css>#theme-toggle,.top-link{display:none}@media(prefers-color-scheme:dark){:root{--theme:#1d1e20;--entry:#2e2e33;--primary:rgba(255, 255, 255, 0.84);--secondary:rgba(255, 255, 255, 0.56);--tertiary:rgba(255, 255, 255, 0.16);--content:rgba(255, 255, 255, 0.74);--hljs-bg:#2e2e33;--code-bg:#37383e;--border:#333}.list{background:var(--theme)}.list:not(.dark)::-webkit-scrollbar-track{background:0 0}.list:not(.dark)::-webkit-scrollbar-thumb{border-color:var(--theme)}}</style></noscript><header class=header><nav class=nav><div class=logo><a href=https://www.keepwn.com accesskey=h title="KeePwn's Notes (Alt + H)">KeePwn's Notes</a>
<span class=logo-switches><button id=theme-toggle accesskey=t title="(Alt + T)"><svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg><svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg></button></span></div><ul id=menu onscroll=menu_on_scroll()><li><a href=https://www.keepwn.com/search title=搜索><span>搜索</span></a></li><li><a href=https://www.keepwn.com/archives title=归档><span>归档</span></a></li><li><a href=https://www.keepwn.com/categories/ title=分类><span>分类</span></a></li><li><a href=https://www.keepwn.com/tags/ title=标签><span>标签</span></a></li><li><a href=https://www.keepwn.com/about title=关于><span>关于</span></a></li></ul></nav></header><main class=main><article class=post-single><header class=post-header><h1 class=post-title>Pi2版OMV的Monit连接错误的问题</h1><div class=post-meta>December 17, 2015&nbsp;·&nbsp;3 分钟&nbsp;·&nbsp;keepwn</div></header><div class=toc><details><summary accesskey=c title="(Alt + C)"><div class=details>目录</div></summary><div class=inner><ul><li><a href=#%e8%83%8c%e6%99%af aria-label=背景>背景</a></li><li><a href=#%e6%9e%97%e5%b0%bd%e6%b0%b4%e6%ba%90 aria-label=林尽水源>林尽水源</a></li><li><a href=#%e5%88%9d%e4%bb%bf%e4%bd%9b%e8%8b%a5%e6%9c%89%e5%85%89 aria-label=初仿佛若有光>初仿佛若有光</a></li><li><a href=#%e5%a4%8d%e8%a1%8c%e6%95%b0%e5%8d%81%e6%ad%a5 aria-label=复行数十步>复行数十步</a></li><li><a href=#%e8%b1%81%e7%84%b6%e5%bc%80%e6%9c%97 aria-label=豁然开朗>豁然开朗</a></li><li><a href=#%e5%8f%82%e8%80%83 aria-label=参考>参考</a></li></ul></div></details></div><div class=post-content><h2 id=背景>背景<a hidden class=anchor aria-hidden=true href=#背景>#</a></h2><p>之前买了个树莓派2，闲置了很久，最近正好有NAS需求，就打算拿它装个<code>OpenMediaVault</code>玩玩。<br>安装过程不表。</p><p>事实上是在使用过程中，遇到的某个问题比较奇葩，就拿来分享了。</p><h2 id=林尽水源>林尽水源<a hidden class=anchor aria-hidden=true href=#林尽水源>#</a></h2><p>在网页端对OMV进行配置时，经常会遇到一个弹窗<code>monit: Cannot connect to the monit daemon. Did you start it with http support?</code>。<br>详细错误代码如下：</p><pre><code>exception 'OMVException' with message 'Failed to execute command 'export LANG=C; monit restart collectd 2&gt;&amp;1': monit: Cannot connect to the monit daemon. Did you start it with http support?' in /usr/share/php/openmediavault/monit.inc:113
Stack trace:
#0 /usr/share/php/openmediavault/monit.inc(70): OMVMonit-&gt;action('restart', 'collectd', false)
#1 /usr/share/openmediavault/engined/module/collectd.inc(53): OMVMonit-&gt;restart('collectd')
#2 /usr/share/openmediavault/engined/rpc/config.inc(206): OMVModuleCollectd-&gt;startService()
#3 [internal function]: OMVRpcServiceConfig-&gt;applyChanges(Array, Array)
#4 /usr/share/php/openmediavault/rpcservice.inc(125): call_user_func_array(Array, Array)
#5 /usr/share/php/openmediavault/rpcservice.inc(158): OMVRpcServiceAbstract-&gt;callMethod('applyChanges', Array, Array)
#6 /usr/share/openmediavault/engined/rpc/config.inc(224): OMVRpcServiceAbstract-&gt;callMethodBg('applyChanges', Array, Array)
#7 [internal function]: OMVRpcServiceConfig-&gt;applyChangesBg(Array, Array)
#8 /usr/share/php/openmediavault/rpcservice.inc(125): call_user_func_array(Array, Array)
#9 /usr/share/php/openmediavault/rpc.inc(79): OMVRpcServiceAbstract-&gt;callMethod('applyChangesBg', Array, Array)
#10 /usr/sbin/omv-engined(500): OMVRpc::exec('Config', 'applyChangesBg', Array, Array, 1)
#11 {main}
</code></pre><p>ssh到<code>OMV</code>终端，输入命令：<code>monit status</code>，似乎错误信息也一样：</p><pre><code>monit: error connecting to the monit daemon
</code></pre><p>在这种情况下，<code>OMV</code>就无法应用配置，必须解决这问题。</p><h2 id=初仿佛若有光>初仿佛若有光<a hidden class=anchor aria-hidden=true href=#初仿佛若有光>#</a></h2><p>于是去google上找啊，找啊，终于找到一篇帖子，遇到了<a href=http://forums.openmediavault.org/index.php/Thread/8973-Failed-to-execute-command-export-LANG-C-monit-restart-collectd-2-1-monit/ title="Failed to execute command 'export LANG=C; monit restart collectd 2>&1': monit">相似的问题</a>（竟然不是StackOverflow，差评！)</p><div class="note info"><div class=note-content><p>Because ntpdate is installed in the image. Both ntp server and ntpdate cannot be installed at the same time. Also, the config for the ntp server does not work&mldr;.</p><p>apt-get &ndash;purge remove ntpdate</p><p>Then in the OMV web gui set your timezone because after these changes you cannot set it again.</p><p>then edit /etc/ntp.conf:</p><p>remove these lines:<br>server 127.127.1.0 # Local clock<br>fudge 127.127.1.0 stratum 12<br>server pool.ntp.org iburst</p><p>And replace with these:<br>server 0.no.pool.ntp.org iburst<br>server 1.no.pool.ntp.org iburst<br>server 2.no.pool.ntp.org iburst<br>server 3.no.pool.ntp.org iburst</p><p>Then you can:<br>service ntp restart</p><p>Do not disable/enable in the OMV web gui again. The mkconf file for the ntp service will overwrite thesechanges. There need to be some updates so it works properly with the rpi 2.</p><p>Your logs files and dates at boot will be all messed up with wrong dates until you install a RTC module. After boot it takes some minutes before the ntp server will update the time/date. With a RTC module everything is perfect at boot.</p></div></div><p>总结几点就是：</p><ul><li><code>Monit</code>的错误和系统时间有关<ul><li>（检查了一下，确实系统当前时间错误）</li></ul></li><li><code>ntpdate</code>与<code>ntp server</code>有冲突，不能同时安装<ul><li>（检查了一下，ntp服务启动失败）</li></ul></li><li><code>OMV</code>自带的ntp配置<code>/etc/ntp.conf</code>有错误</li><li>你应该安装<code>RTC</code>模块</li></ul><h2 id=复行数十步>复行数十步<a hidden class=anchor aria-hidden=true href=#复行数十步>#</a></h2><p>按照前面这位贤者的建议，我分别进行了一下几个测试：</p><ul><li>测试一: 手动修改当前时间，卸载<code>ntpdate</code>，关闭<code>ntp</code>服务<ul><li>重启以后，时间丢失</li></ul></li><li>测试二: 卸载<code>ntpdate</code>，不修改<code>ntp</code>配置文件<ul><li><code>ntp</code>服务正常启动，时间同步正确</li><li>重启以后，<code>ntp</code>服务正常启动，时间无法同步</li></ul></li><li>测试三: 卸载<code>ntpdate</code>，修改<code>ntp</code>配置文件<ul><li><code>ntp</code>服务正常启动，时间同步正确</li><li>重启以后，<code>ntp</code>服务正常启动，时间无法同步</li></ul></li><li>测试四: 运行<code>ntpdate</code>，强制同步<ul><li>时间同步正确</li><li>重启以后，<code>ntp</code>服务不能正常启动，时间无法同步</li></ul></li></ul><p>测试后发现，因为树莓派本身的硬件限制，系统重启后会丢失当前时间。<br>尽管开启了<code>ntp</code>服务，但是如果系统当前时间与真实时间跨度太大，则不会进行同步。</p><p>所以只能放弃<code>ntp server</code>，转而使用<code>ntpdate</code>来强制同步时间，并设置开机启动。<br>代码如下：</p><pre><code># 设置开机同步时间，注意: 添加的代码必须在`exit 0`之前
echo '/usr/sbin/ntpdate 0.cn.pool.ntp.org' &gt;&gt; /etc/rc.local

# 设置同步任务，每隔5分钟同步一次时间
# 编辑crontab，并保存
crontab -e
*/5 * * * * /usr/sbin/ntpdate 0.cn.pool.ntp.org
</code></pre><p>重启系统，系统时间已经正确了。<br>在网页端对<code>OMV</code>重新进行配置。WTF，怎么还是<code>monit</code>这个问题！</p><h2 id=豁然开朗>豁然开朗<a hidden class=anchor aria-hidden=true href=#豁然开朗>#</a></h2><p>登入终端，重新进行检查：</p><pre><code>root@raspberrypi:~# date
Dec 16 11:12:04 CST 2015
root@raspberrypi:~# monit status
monit: error connecting to the monit daemon
</code></pre><p>到这里时，我当时确实很疑惑，明明系统时间已经正确了，为什么<code>monit</code>还是报错呢。<br>突然灵光乍现，重新启动<code>monit</code>服务，然后十几秒过后：</p><pre><code>root@raspberrypi:~# monit status
The Monit daemon 5.4 uptime: 18m 

System 'localhost'
  status                            Running
  monitoring status                 Monitored
  load average                      [0.00] [0.01] [0.05]
  cpu                               0.0%us 0.1%sy 0.0%wa
  memory usage                      55424 kB [5.5%]
  swap usage                        0 kB [0.0%]
  data collected                    16 Dec 2015 11:12:17

...

Process 'collectd'
  status                            Running
  monitoring status                 Monitored
  pid                               2535
  parent pid                        1
  uptime                            18m 
  children                          0
  memory kilobytes                  4224
  memory kilobytes total            4224
  memory percent                    0.4%
  memory percent total              0.4%
  cpu percent                       0.0%
  cpu percent total                 0.0%
  data collected                    16 Dec 2015 11:12:17

</code></pre><p>在此个人分析，在<code>monit</code>服务启动时，系统时间还未同步，所以<code>monit</code>初始化失败。只要保证在时间同步后，再重启<code>monit</code>服务应该就可以了。</p><pre><code># 在强制同步时间后，再重启monit服务
echo '/etc/init.d/monit restart' &gt;&gt; /etc/rc.local
</code></pre><p>重启系统，一切正常。END！</p><h2 id=参考>参考<a hidden class=anchor aria-hidden=true href=#参考>#</a></h2><ul><li><a href=http://forums.openmediavault.org/index.php/Thread/8973-Failed-to-execute-command-export-LANG-C-monit-restart-collectd-2-1-monit/>http://forums.openmediavault.org/index.php/Thread/8973-Failed-to-execute-command-export-LANG-C-monit-restart-collectd-2-1-monit/</a></li><li><a href=http://forums.openmediavault.org/index.php/Thread/8770-RPi-2-RTC-module-from-unruly-Stepchild-to-Wunderkind/>http://forums.openmediavault.org/index.php/Thread/8770-RPi-2-RTC-module-from-unruly-Stepchild-to-Wunderkind/</a></li><li><a href="https://www.raspberrypi.org/forums/viewtopic.php?f=91&t=83344">https://www.raspberrypi.org/forums/viewtopic.php?f=91&t=83344</a></li></ul></div><footer class=post-footer><ul class=post-tags><li><a href=https://www.keepwn.com/tags/raspberrypi/>raspberrypi</a></li><li><a href=https://www.keepwn.com/tags/omv/>omv</a></li><li><a href=https://www.keepwn.com/tags/monit/>monit</a></li><li><a href=https://www.keepwn.com/tags/ntp/>ntp</a></li></ul><nav class=paginav><a class=prev href=https://www.keepwn.com/posts/route-traffic-selectively-by-domain-on-openwrt/><span class=title>« 上一页</span><br><span>Openwrt上使用dnsmasq和ipset实现域名分流</span></a>
<a class=next href=https://www.keepwn.com/posts/using-open-iscsi-in-docker-container/><span class=title>下一页 »</span><br><span>Docker环境下使用open-iscsi遇到的问题</span></a></nav></footer><section class=comments><style>.utterances{max-width:100%}</style><script src=https://utteranc.es/client.js repo=keepwn/blog-comments issue-term=pathname theme=github-light crossorigin=anonymous async></script></section></article></main><footer class=footer><span>© 2014 - 2021 KEEPWN.COM</span>
<span>&#183;</span>
<span>Powered by <a href=https://gohugo.io/ rel="noopener noreferrer" target=_blank>Hugo</a></span>
<span>&#183;</span>
<span>Theme PaperMod & Custom</span></footer><div class=back-to-top><i class="fa fa-arrow-up"></i>
<span id=scrollpercent><span>0</span>%</span></div><script type=text/javascript src=//cdn.bootcdn.net/ajax/libs/jquery/2.1.4/jquery.min.js></script><script type=text/javascript>function getCntViewHeight(){var b=$('#content').height(),a=$(window).height(),c=b>a?b-a:$(document).height()-a;return c}function registerBackTop(){var b=50,a=$('.back-to-top');$(window).on('scroll',function(){var d,e,f,c,g;a.toggleClass('back-to-top-on',window.pageYOffset>b),d=$(window).scrollTop(),e=getCntViewHeight(),f=d/e,c=Math.round(f*100),g=c>100?100:c,$('#scrollpercent>span').html(g)}),a.on('click',function(){$("html,body").animate({scrollTop:0,screenLeft:0},800)})}registerBackTop()</script><script src=https://unpkg.com/scrollnav@3.0.1/dist/scrollnav.min.umd.js></script><script>const content=document.querySelector('.post-content');scrollnav.init(content,{debug:!1,easingStyle:'linear',sections:$('.post-content > h1').length>0?'h1':'h2',subSections:$('.post-content > h1').length>0?'h2':'h3'}),$(window).on('scroll',function(){$(".scroll-nav__sub-item.scroll-nav__item--active").parent().parent().addClass("scroll-nav__item--half-active");let a=$(".scroll-nav__item.scroll-nav__item--half-active");a.find(".scroll-nav__sub-item").length>0&&(a.find(".scroll-nav__sub-item").is(".scroll-nav__item--active")||a.removeClass("scroll-nav__item--half-active"))})</script><script defer src=/assets/js/highlight.min.7680afc38aa6b15ddf158a4f3780b7b1f7dde7e91d26f073e6229bb7a0793c92.js integrity="sha256-doCvw4qmsV3fFYpPN4C3sffd5+kdJvBz5iKbt6B5PJI=" onload=hljs.initHighlightingOnLoad()></script><script>window.onload=function(){localStorage.getItem("menu-scroll-position")&&(document.getElementById('menu').scrollLeft=localStorage.getItem("menu-scroll-position"))},document.querySelectorAll('a[href^="#"]').forEach(a=>{a.addEventListener("click",function(b){b.preventDefault();var a=this.getAttribute("href").substr(1);window.matchMedia('(prefers-reduced-motion: reduce)').matches?document.querySelector(`[id='${decodeURIComponent(a)}']`).scrollIntoView():document.querySelector(`[id='${decodeURIComponent(a)}']`).scrollIntoView({behavior:"smooth"}),a==="top"?history.replaceState(null,null," "):history.pushState(null,null,`#${a}`)})});function menu_on_scroll(){localStorage.setItem("menu-scroll-position",document.getElementById('menu').scrollLeft)}</script><script>document.getElementById("theme-toggle")?.addEventListener("click",()=>{document.body.className.includes("dark")?(document.body.classList.remove('dark'),localStorage.setItem("pref-theme",'light')):(document.body.classList.add('dark'),localStorage.setItem("pref-theme",'dark'))})</script></body></html>