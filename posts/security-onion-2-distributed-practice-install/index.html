<!doctype html><html lang=zh dir=auto><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=robots content="index, follow"><title>Security-Onion-2 分布式实践之安装篇 | KeePwn's Notes</title><meta name=keywords content="security-onion"><meta name=description content="前言  Security Onion （以下称安全洋葱）是一款免费且开源的，用于威胁发现、企业安全监视和日志管理的 Linux 发行版本。
目前，安全洋葱已经迭代至 2.X，与 1.X 版本不同，2.X 版本基于容器开发，实现了将各个组件和服务容器化，更易于使用者部署和定制。
  本篇并不涉及系统的调优，如果你此前已经安装并部署了安全洋葱，可以跳过此章节。
 安全洋葱的安装较为简单，网络上也有诸多的 ALL IN ONE 的安装教程，但考虑到这些部署方式不太适合生产环境使用，所以本篇主要讲述如何在生产环境分布式部署安全洋葱系统。
本文中使用的安全洋葱版本为 v2.3.30（截至本文编写时）。
准备工作 官方文档建议采用标准的分布式部署方式进行部署安全洋葱，至少以下三个节点：
   节点类型 说明     manager node 主要节点，负责接收采集到的原始数据   forward node 流量分析节点，也叫 sensor-node   search-node 搜索节点，存储 ES 数据    我部署了 4 个节点，大家根据实际情况进行扩展：
   节点 IP 配置     security-manager 10.10.0.1 8 cores, 16g memory, 200g disk   security-sensor 10."><meta name=author content="keepwn"><link rel=canonical href=https://www.keepwn.com/posts/security-onion-2-distributed-practice-install/><meta name=google-site-verification content="xMak_7WE4_KOO1YEi_bgkoTs5tahDUulVkZUAG831RA"><link href=//cdn.bootcdn.net/ajax/libs/font-awesome/4.6.2/css/font-awesome.min.css rel=stylesheet type=text/css><link href=/assets/css/stylesheet.min.b18d2192b46ee057ab44baca1a2f3dcd088499657810f879e44342f68066ec97.css integrity="sha256-sY0hkrRu4FerRLrKGi89zQiEmWV4EPh55ENC9oBm7Jc=" rel="preload stylesheet" as=style><link rel=icon href=https://www.keepwn.com/favicon.ico><link rel=icon type=image/png sizes=16x16 href=https://www.keepwn.com/favicon-16x16.png><link rel=icon type=image/png sizes=32x32 href=https://www.keepwn.com/favicon-32x32.png><link rel=apple-touch-icon href=https://www.keepwn.com/apple-touch-icon.png><link rel=mask-icon href=https://www.keepwn.com/safari-pinned-tab.svg><meta name=theme-color content="#2e2e33"><meta name=msapplication-TileColor content="#2e2e33"><meta name=generator content="Hugo 0.82.0"><script type=application/javascript>var doNotTrack=!1;doNotTrack||(window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)},ga.l=+new Date,ga('create','UA-52738842-1','auto'),ga('send','pageview'))</script><script async src=https://www.google-analytics.com/analytics.js></script><meta property="og:title" content="Security-Onion-2 分布式实践之安装篇"><meta property="og:description" content="前言  Security Onion （以下称安全洋葱）是一款免费且开源的，用于威胁发现、企业安全监视和日志管理的 Linux 发行版本。
目前，安全洋葱已经迭代至 2.X，与 1.X 版本不同，2.X 版本基于容器开发，实现了将各个组件和服务容器化，更易于使用者部署和定制。
  本篇并不涉及系统的调优，如果你此前已经安装并部署了安全洋葱，可以跳过此章节。
 安全洋葱的安装较为简单，网络上也有诸多的 ALL IN ONE 的安装教程，但考虑到这些部署方式不太适合生产环境使用，所以本篇主要讲述如何在生产环境分布式部署安全洋葱系统。
本文中使用的安全洋葱版本为 v2.3.30（截至本文编写时）。
准备工作 官方文档建议采用标准的分布式部署方式进行部署安全洋葱，至少以下三个节点：
   节点类型 说明     manager node 主要节点，负责接收采集到的原始数据   forward node 流量分析节点，也叫 sensor-node   search-node 搜索节点，存储 ES 数据    我部署了 4 个节点，大家根据实际情况进行扩展：
   节点 IP 配置     security-manager 10.10.0.1 8 cores, 16g memory, 200g disk   security-sensor 10."><meta property="og:type" content="article"><meta property="og:url" content="https://www.keepwn.com/posts/security-onion-2-distributed-practice-install/"><meta property="article:section" content="posts"><meta property="article:published_time" content="2021-03-20T00:00:00+00:00"><meta name=twitter:card content="summary"><meta name=twitter:title content="Security-Onion-2 分布式实践之安装篇"><meta name=twitter:description content="前言  Security Onion （以下称安全洋葱）是一款免费且开源的，用于威胁发现、企业安全监视和日志管理的 Linux 发行版本。
目前，安全洋葱已经迭代至 2.X，与 1.X 版本不同，2.X 版本基于容器开发，实现了将各个组件和服务容器化，更易于使用者部署和定制。
  本篇并不涉及系统的调优，如果你此前已经安装并部署了安全洋葱，可以跳过此章节。
 安全洋葱的安装较为简单，网络上也有诸多的 ALL IN ONE 的安装教程，但考虑到这些部署方式不太适合生产环境使用，所以本篇主要讲述如何在生产环境分布式部署安全洋葱系统。
本文中使用的安全洋葱版本为 v2.3.30（截至本文编写时）。
准备工作 官方文档建议采用标准的分布式部署方式进行部署安全洋葱，至少以下三个节点：
   节点类型 说明     manager node 主要节点，负责接收采集到的原始数据   forward node 流量分析节点，也叫 sensor-node   search-node 搜索节点，存储 ES 数据    我部署了 4 个节点，大家根据实际情况进行扩展：
   节点 IP 配置     security-manager 10.10.0.1 8 cores, 16g memory, 200g disk   security-sensor 10."><script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":2,"name":"Posts","item":"https://www.keepwn.com/posts/"},{"@type":"ListItem","position":3,"name":"Security-Onion-2 分布式实践之安装篇","item":"https://www.keepwn.com/posts/security-onion-2-distributed-practice-install/"}]}</script><script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","headline":"Security-Onion-2 分布式实践之安装篇","name":"Security-Onion-2 分布式实践之安装篇","description":"前言  Security Onion （以下称安全洋葱）是一款免费且开源的，用于威胁发现、企业安全监视和日志管理的 Linux 发行版本。\n目前，安全洋葱已经迭代至 2.X，与 1.X 版本不同，2.X 版本基于容器开发，实现了将各个组件和服务容器化，更易于使用者部署和定制。\n  本篇并不涉及系统的调优，如果你此前已经安装并部署了安全洋葱，可以跳过此章节。\n 安全洋葱的安装较为简单，网络上也有诸多的 ALL IN ONE 的安装教程，但考虑到这些部署方式不太适合生产环境使用，所以本篇主要讲述如何在生产环境分布式部署安全洋葱系统。\n本文中使用的安全洋葱版本为 v2.3.30（截至本文编写时）。\n准备工作 官方文档建议采用标准的分布式部署方式进行部署安全洋葱，至少以下三个节点：\n   节点类型 说明     manager node 主要节点，负责接收采集到的原始数据   forward node 流量分析节点，也叫 sensor-node   search-node 搜索节点，存储 ES 数据    我部署了 4 个节点，大家根据实际情况进行扩展：\n   节点 IP 配置     security-manager 10.10.0.1 8 cores, 16g memory, 200g disk   security-sensor 10.","keywords":["security-onion"],"articleBody":"前言  Security Onion （以下称安全洋葱）是一款免费且开源的，用于威胁发现、企业安全监视和日志管理的 Linux 发行版本。\n目前，安全洋葱已经迭代至 2.X，与 1.X 版本不同，2.X 版本基于容器开发，实现了将各个组件和服务容器化，更易于使用者部署和定制。\n  本篇并不涉及系统的调优，如果你此前已经安装并部署了安全洋葱，可以跳过此章节。\n 安全洋葱的安装较为简单，网络上也有诸多的 ALL IN ONE 的安装教程，但考虑到这些部署方式不太适合生产环境使用，所以本篇主要讲述如何在生产环境分布式部署安全洋葱系统。\n本文中使用的安全洋葱版本为 v2.3.30（截至本文编写时）。\n准备工作 官方文档建议采用标准的分布式部署方式进行部署安全洋葱，至少以下三个节点：\n   节点类型 说明     manager node 主要节点，负责接收采集到的原始数据   forward node 流量分析节点，也叫 sensor-node   search-node 搜索节点，存储 ES 数据    我部署了 4 个节点，大家根据实际情况进行扩展：\n   节点 IP 配置     security-manager 10.10.0.1 8 cores, 16g memory, 200g disk   security-sensor 10.10.0.100 8 cores, 32g memory, 12t disk   security-search-1 10.10.0.11 8 cores, 16g memory, 2t disk   security-search-2 10.10.0.12 8 cores, 16g memory, 2t disk    架构大致如下：\n开始安装 security-manager 1.从 ISO 引导启动，设置完用户名和密码，回车后开始安装系统，安装完成后重启系统。\n2.登录系统，输入用户名和密码，准备开始配置。\n3.选择安装类型为distributed\n4.选择节点类型为manager\n5.选择安装环境为standard，这里需要注意 security-manager 这台主机需要能够联网。\n6.设置主机名\n7.设置管理口，并配置静态地址（这里建议不要选择DHCP分配地址，会影响服务/节点之间的通信）\n8.选择系统补丁计划（默认），设置家庭网络（默认）\n9.选择安装类型为高级，进行功能定制化\n10.设置 ES 集群名称（默认）\n11.选择元信息分析引擎（zeek or suricata）。考虑到 zeek 可定制化更强些，所以我选择的是 zeek 处理 metadata，suricata 处理 nids-alerts。事实上，两种方式均可，官方这里有讨论//TODO。\n12.选择需要发送的日志类型。\n 请注意，这指的是需要被发送到 manager 节点的日志类型，不是 zeek 要处理的协议（这需要额外进行配置）\n 建议按照实际监测需求和节点存储容量进行权衡。有选择恐惧症的可以先按默认的来，后面可以再修改的:)。\n13.选择 IDS 规则集（默认）。你也可以选择高级订阅版。\n14.选择安装的组件列表（默认）。按需选择。\n Grafana  主机的健康监控和报警   Fleet \u0026 osquery  HIDS，侧重于主机信息被动/主动采集   Wazuh  HIDS，侧重于威胁检测、完整性监控等   TheHive  安全事件响应平台   Playbook  检测 Playbook 的工具   Strelka  文件提取/分析，用于威胁搜索、威胁检测和事件响应    15.为其他组件设置邮箱和密码\n16.选择 WEB 界面的访问方式。我选择的是IP，也可以改为域名方式。\n17.选择下载系统更新包的方式。建议选择通过 manager 节点下载。\n18.设置 soremote 密码，后面用于添加其他节点。\n19.设置允许访问WEB界面的网段。建议只添加安全运维段的主机IP, 不在该网段的主机将无法访问WEB界面。\n20.确定应用配置，等待完成安装。\n21.配置防火墙规则，允许其他节点访问管理节点的 Salt 服务 （重要）\n 很多人在部署非管理节点的时候总是提示安装失败，就是因为缺少这个步骤导致的。\nsosetup.log中的报错日志类似：[ERROR ] 'mine.send': False\n firewall-cmd --permanent --zone= --add-port=4505-4506/tcp firewall-cmd --reload security-sensor 1.完成基础的系统安装后，我们开始配置流量分析节点。\n2.选择安装类型为 distributed\n3.选择节点类型为 sensor\n4.设置主机名\n5.选择管理口，并配置静态地址\n6.设置 manager 节点，并输入 soremote 密码，与 manager 节点完成连接。\n7.选择镜像口\n8.选择系统补丁计划（默认），选择下载系统更新包的方式为 manager。\n9.选择安装类型为高级，进行功能定制化。\n10.进行 CPU 绑定（Zeek、Suricata）\n11.配置镜像口MTU（默认）\n12.等待安装完成。\nsecurity-search 1.完成基础的系统安装后，我们开始配置流量分析节点。\n2.选择安装类型为 distributed\n3.选择节点类型为 searchnode\n4.设置主机名\n5.选择管理口，并配置静态地址\n6.设置 manager 节点（输入 soremote 密码）\n7.选择系统补丁计划（默认），选择下载系统更新包的方式为 manager。\n8.选择安装类型为高级，进行功能定制化。\n9.配置 ES 堆大小（默认）\n10.配置 Logstash 堆大小（默认）\n11.配置 Logstash pipeline 线程（默认）\n12.配置 logstash pipeline 批处理大小（默认）\n13.配置 logstash input 线程数（默认），如果发现存在消息积压（redis），可以适当调整以上几个参数。\n14.配置 ES 索引关闭时间（默认为 30 天）。关闭索引不会删除数据，如果需要查询历史数据可以再单独开启。如果内存足够的话，可以设置为 90 天。\n15.配置 ES 存储大小，我配置的是 1948（2T-100G），可以择优调整。\n16.等待安装完成。\n功能验证 1.打开 https://10.10.0.1 安全洋葱控制台并登陆\n2.点击 Grid 标签，查看网格状态，检查节点是否已经全部上线。\n在这里，大家可以看到节点列表中还出现了一个陌生的节点类型 securityonion-fleet，这个是其实是独立部署的 Fleet 服务，由于需要管理的 osquery 客户端较多，容易影响性能，所以就把它从管理节点拆分出来了。\n3.点击 Alerts 标签，检查是否可以正常。\n4.点击 Hunt 标签，检查是否正常。\n5.点击 Grafana 标签，检查各个主机节点是否正常。\n6.点击 Kiabana 标签，检查 ES 服务是否正常。\n好了，如果服务一切正常的话，你可以开始打工人生活了:)\n参考链接  https://docs.securityonion.net/en/2.3/about.html  ","wordCount":"256","inLanguage":"zh","datePublished":"2021-03-20T00:00:00Z","dateModified":"0001-01-01T00:00:00Z","author":{"@type":"Person","name":"keepwn"},"mainEntityOfPage":{"@type":"WebPage","@id":"https://www.keepwn.com/posts/security-onion-2-distributed-practice-install/"},"publisher":{"@type":"Organization","name":"KeePwn's Notes","logo":{"@type":"ImageObject","url":"https://www.keepwn.com/favicon.ico"}}}</script></head><body id=top><script>localStorage.getItem("pref-theme")==="dark"?document.body.classList.add('dark'):localStorage.getItem("pref-theme")==="light"?document.body.classList.remove('dark'):window.matchMedia('(prefers-color-scheme: dark)').matches&&document.body.classList.add('dark')</script><noscript><style type=text/css>#theme-toggle,.top-link{display:none}@media(prefers-color-scheme:dark){:root{--theme:#1d1e20;--entry:#2e2e33;--primary:rgba(255, 255, 255, 0.84);--secondary:rgba(255, 255, 255, 0.56);--tertiary:rgba(255, 255, 255, 0.16);--content:rgba(255, 255, 255, 0.74);--hljs-bg:#2e2e33;--code-bg:#37383e;--border:#333}.list{background:var(--theme)}.list:not(.dark)::-webkit-scrollbar-track{background:0 0}.list:not(.dark)::-webkit-scrollbar-thumb{border-color:var(--theme)}}</style></noscript><header class=header><nav class=nav><div class=logo><a href=https://www.keepwn.com accesskey=h title="KeePwn's Notes (Alt + H)">KeePwn's Notes</a>
<span class=logo-switches><button id=theme-toggle accesskey=t title="(Alt + T)"><svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg><svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg></button></span></div><ul id=menu onscroll=menu_on_scroll()><li><a href=https://www.keepwn.com/search title=搜索><span>搜索</span></a></li><li><a href=https://www.keepwn.com/archives title=归档><span>归档</span></a></li><li><a href=https://www.keepwn.com/categories/ title=分类><span>分类</span></a></li><li><a href=https://www.keepwn.com/tags/ title=标签><span>标签</span></a></li><li><a href=https://www.keepwn.com/about title=关于><span>关于</span></a></li></ul></nav></header><main class=main><article class=post-single><header class=post-header><h1 class=post-title>Security-Onion-2 分布式实践之安装篇</h1><div class=post-meta>March 20, 2021&nbsp;·&nbsp;2 分钟&nbsp;·&nbsp;keepwn</div></header><div class=toc><details><summary accesskey=c title="(Alt + C)"><div class=details>目录</div></summary><div class=inner><ul><li><a href=#%e5%89%8d%e8%a8%80 aria-label=前言>前言</a></li><li><a href=#%e5%87%86%e5%a4%87%e5%b7%a5%e4%bd%9c aria-label=准备工作>准备工作</a></li><li><a href=#%e5%bc%80%e5%a7%8b%e5%ae%89%e8%a3%85 aria-label=开始安装>开始安装</a><ul><li><a href=#security-manager aria-label=security-manager>security-manager</a></li><li><a href=#security-sensor aria-label=security-sensor>security-sensor</a></li><li><a href=#security-search aria-label=security-search>security-search</a></li></ul></li><li><a href=#%e5%8a%9f%e8%83%bd%e9%aa%8c%e8%af%81 aria-label=功能验证>功能验证</a></li><li><a href=#%e5%8f%82%e8%80%83%e9%93%be%e6%8e%a5 aria-label=参考链接>参考链接</a></li></ul></div></details></div><div class=post-content><h2 id=前言>前言<a hidden class=anchor aria-hidden=true href=#前言>#</a></h2><blockquote><p>Security Onion （以下称安全洋葱）是一款免费且开源的，用于威胁发现、企业安全监视和日志管理的 Linux 发行版本。<br>目前，安全洋葱已经迭代至 2.X，与 1.X 版本不同，2.X 版本基于容器开发，实现了将各个组件和服务容器化，更易于使用者部署和定制。</p></blockquote><blockquote><p>本篇并不涉及系统的调优，如果你此前已经安装并部署了安全洋葱，可以跳过此章节。</p></blockquote><p>安全洋葱的安装较为简单，网络上也有诸多的 ALL IN ONE 的安装教程，但考虑到这些部署方式不太适合生产环境使用，所以本篇主要讲述如何在生产环境分布式部署安全洋葱系统。</p><p><strong>本文中使用的安全洋葱版本为 v2.3.30（截至本文编写时）。</strong></p><h2 id=准备工作>准备工作<a hidden class=anchor aria-hidden=true href=#准备工作>#</a></h2><p>官方文档建议采用<code>标准的分布式部署方式</code>进行部署安全洋葱，至少以下三个节点：</p><table><thead><tr><th>节点类型</th><th>说明</th></tr></thead><tbody><tr><td>manager node</td><td>主要节点，负责接收采集到的原始数据</td></tr><tr><td>forward node</td><td>流量分析节点，也叫 sensor-node</td></tr><tr><td>search-node</td><td>搜索节点，存储 ES 数据</td></tr></tbody></table><p>我部署了 4 个节点，大家根据实际情况进行扩展：</p><table><thead><tr><th>节点</th><th>IP</th><th>配置</th></tr></thead><tbody><tr><td>security-manager</td><td>10.10.0.1</td><td>8 cores, 16g memory, 200g disk</td></tr><tr><td>security-sensor</td><td>10.10.0.100</td><td>8 cores, 32g memory, 12t disk</td></tr><tr><td>security-search-1</td><td>10.10.0.11</td><td>8 cores, 16g memory, 2t disk</td></tr><tr><td>security-search-2</td><td>10.10.0.12</td><td>8 cores, 16g memory, 2t disk</td></tr></tbody></table><p>架构大致如下：<br><img loading=lazy src=./images/so-distributed.png alt></p><h2 id=开始安装>开始安装<a hidden class=anchor aria-hidden=true href=#开始安装>#</a></h2><h3 id=security-manager>security-manager<a hidden class=anchor aria-hidden=true href=#security-manager>#</a></h3><p>1.从 ISO 引导启动，设置完用户名和密码，回车后开始安装系统，安装完成后重启系统。<br>2.登录系统，输入用户名和密码，准备开始配置。<br><img loading=lazy src=./images/so-manager-setup-1.png alt></p><p>3.选择安装类型为distributed<br><img loading=lazy src=./images/so-manager-setup-2-choose-install-type.png alt></p><p>4.选择节点类型为manager<br><img loading=lazy src=./images/so-manager-setup-3-choose-node-type.png alt></p><p>5.选择安装环境为standard，这里需要注意 security-manager 这台主机需要能够联网。<br><img loading=lazy src=./images/so-manager-setup-4-choose-install-condition.png alt></p><p>6.设置主机名<br><img loading=lazy src=./images/so-manager-setup-5-set-hostname.png alt></p><p>7.设置管理口，并配置静态地址（这里建议不要选择DHCP分配地址，会影响服务/节点之间的通信）<br><img loading=lazy src=./images/so-manager-setup-6-choose-nic.png alt><br><img loading=lazy src=./images/so-manager-setup-7-set-static-address.png alt></p><p>8.选择系统补丁计划（默认），设置家庭网络（默认）<br><img loading=lazy src=./images/so-manager-setup-8-choose-os-path-schedule.png alt><br><img loading=lazy src=./images/so-manager-setup-9-set-home-network.png alt></p><p>9.选择安装类型为高级，进行功能定制化<br><img loading=lazy src=./images/so-manager-setup-10-choose-manager-type.png alt></p><p>10.设置 ES 集群名称（默认）<br><img loading=lazy src=./images/so-manager-setup-11-set-es-cluser-name.png alt></p><p>11.选择元信息分析引擎（zeek or suricata）。考虑到 zeek 可定制化更强些，所以我选择的是 zeek 处理 metadata，suricata 处理 nids-alerts。事实上，两种方式均可，官方这里有讨论//TODO。<br><img loading=lazy src=./images/so-manager-setup-12-choose-gen-metadata.png alt></p><p>12.选择需要发送的日志类型。</p><blockquote><p>请注意，这指的是需要被发送到 manager 节点的日志类型，不是 zeek 要处理的协议（这需要额外进行配置）</p></blockquote><p>建议按照实际监测需求和节点存储容量进行权衡。有选择恐惧症的可以先按默认的来，后面可以再修改的:)。<br><img loading=lazy src=./images/so-manager-setup-13-choose-logs-to-send.png alt></p><p>13.选择 IDS 规则集（默认）。你也可以选择高级订阅版。<br><img loading=lazy src=./images/so-manager-setup-14-choose-ids-ruleset.png alt></p><p>14.选择安装的组件列表（默认）。按需选择。</p><ul><li>Grafana<ul><li>主机的健康监控和报警</li></ul></li><li>Fleet & osquery<ul><li>HIDS，侧重于主机信息被动/主动采集</li></ul></li><li>Wazuh<ul><li>HIDS，侧重于威胁检测、完整性监控等</li></ul></li><li>TheHive<ul><li>安全事件响应平台</li></ul></li><li>Playbook<ul><li>检测 Playbook 的工具</li></ul></li><li>Strelka<ul><li>文件提取/分析，用于威胁搜索、威胁检测和事件响应</li></ul></li></ul><p><img loading=lazy src=./images/so-manager-setup-15-choose-components.png alt></p><p>15.为其他组件设置邮箱和密码<br>16.选择 WEB 界面的访问方式。我选择的是IP，也可以改为域名方式。<br><img loading=lazy src=./images/so-manager-setup-16-choose-web-access.png alt></p><p>17.选择下载系统更新包的方式。建议选择<code>通过 manager 节点下载</code>。<br><img loading=lazy src=./images/so-manager-setup-17-choose-update-os-by-manager-proxy.png alt></p><p>18.设置 soremote 密码，后面用于添加其他节点。<br><img loading=lazy src=./images/so-manager-setup-18-set-soremote-passwd.png alt></p><p>19.设置允许访问WEB界面的网段。建议只添加安全运维段的主机IP, 不在该网段的主机将无法访问WEB界面。<br><img loading=lazy src=./images/so-manager-setup-19-set-so-allow.png alt></p><p>20.确定应用配置，等待完成安装。<br><img loading=lazy src=./images/so-manager-setup-20.png alt><br><img loading=lazy src=./images/so-manager-setup-21.png alt></p><p>21.配置防火墙规则，允许其他节点访问管理节点的 Salt 服务 （<strong>重要</strong>）</p><blockquote><p>很多人在部署非管理节点的时候总是提示安装失败，就是因为缺少这个步骤导致的。<br>sosetup.log中的报错日志类似：<code>[ERROR ] 'mine.send': False</code></p></blockquote><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>firewall-cmd --permanent --zone<span style=color:#f92672>=</span> --add-port<span style=color:#f92672>=</span>4505-4506/tcp
firewall-cmd --reload
</code></pre></div><h3 id=security-sensor>security-sensor<a hidden class=anchor aria-hidden=true href=#security-sensor>#</a></h3><p>1.完成基础的系统安装后，我们开始配置流量分析节点。<br>2.选择安装类型为 distributed<br>3.选择节点类型为 sensor<br><img loading=lazy src=./images/so-sensor-setup-1-choose-install-type.png alt></p><p>4.设置主机名<br><img loading=lazy src=./images/so-sensor-setup-2-set-hostname.png alt></p><p>5.选择管理口，并配置静态地址<br><img loading=lazy src=./images/so-sensor-setup-3-choose-nic.png alt></p><p>6.设置 manager 节点，并输入 soremote 密码，与 manager 节点完成连接。<br><img loading=lazy src=./images/so-sensor-setup-4-set-manager-hostname.png alt><br><img loading=lazy src=./images/so-sensor-setup-5-set-manager-ip.png alt><br><img loading=lazy src=./images/so-sensor-setup-6-connect-to-manager.png alt></p><p>7.选择镜像口<br><img loading=lazy src=./images/so-sensor-setup-7-choose-monitor-nic.png alt><br><img loading=lazy src=./images/so-sensor-setup-8.png alt></p><p>8.选择系统补丁计划（默认），选择下载系统更新包的方式为 manager。<br>9.选择安装类型为高级，进行功能定制化。</p><p>10.进行 CPU 绑定（Zeek、Suricata）<br><img loading=lazy src=./images/so-sensor-setup-9-bind-cpu-zeek.png alt><br><img loading=lazy src=./images/so-sensor-setup-10-bind-cpu-surucata.png alt></p><p>11.配置镜像口MTU（默认）<br><img loading=lazy src=./images/so-sensor-setup-11-mtu.png alt></p><p>12.等待安装完成。</p><h3 id=security-search>security-search<a hidden class=anchor aria-hidden=true href=#security-search>#</a></h3><p>1.完成基础的系统安装后，我们开始配置流量分析节点。<br>2.选择安装类型为 distributed<br>3.选择节点类型为 searchnode<br>4.设置主机名<br>5.选择管理口，并配置静态地址<br>6.设置 manager 节点（输入 soremote 密码）<br>7.选择系统补丁计划（默认），选择下载系统更新包的方式为 manager。<br>8.选择安装类型为高级，进行功能定制化。<br>9.配置 ES 堆大小（默认）<br><img loading=lazy src=./images/so-search-setup-1-set-es-heap-size.png alt></p><p>10.配置 Logstash 堆大小（默认）<br><img loading=lazy src=./images/so-search-setup-2-set-logstash-heap-size.png alt></p><p>11.配置 Logstash pipeline 线程（默认）<br><img loading=lazy src=./images/so-search-setup-3-set-logstash-pipeline-workers.png alt></p><p>12.配置 logstash pipeline 批处理大小（默认）<br><img loading=lazy src=./images/so-search-setup-4-set-logstash-pipeline-batch-size.png alt></p><p>13.配置 logstash input 线程数（默认），如果发现存在消息积压（redis），可以适当调整以上几个参数。<br><img loading=lazy src=./images/so-search-setup-5-set-logstash-input-num.png alt></p><p>14.配置 ES 索引关闭时间（默认为 30 天）。关闭索引不会删除数据，如果需要查询历史数据可以再单独开启。如果内存足够的话，可以设置为 90 天。<br><img loading=lazy src=./images/so-search-setup-6-set-days-of-indices-open.png alt></p><p>15.配置 ES 存储大小，我配置的是 1948（2T-100G），可以择优调整。<br><img loading=lazy src=./images/so-search-setup-7-set-es-size.png alt></p><p>16.等待安装完成。</p><h2 id=功能验证>功能验证<a hidden class=anchor aria-hidden=true href=#功能验证>#</a></h2><p>1.打开 https://10.10.0.1 安全洋葱控制台并登陆<br>2.点击 Grid 标签，查看网格状态，检查节点是否已经全部上线。<br><img loading=lazy src=./images/soc-web-grid.png alt></p><p>在这里，大家可以看到节点列表中还出现了一个陌生的节点类型 securityonion-fleet，这个是其实是独立部署的 Fleet 服务，由于需要管理的 osquery 客户端较多，容易影响性能，所以就把它从管理节点拆分出来了。</p><p>3.点击 Alerts 标签，检查是否可以正常。<br><img loading=lazy src=./images/soc-web-alert.png alt></p><p>4.点击 Hunt 标签，检查是否正常。<br><img loading=lazy src=./images/soc-web-hunt.png alt></p><p>5.点击 Grafana 标签，检查各个主机节点是否正常。<br><img loading=lazy src=./images/soc-grafana.png alt></p><p>6.点击 Kiabana 标签，检查 ES 服务是否正常。<br><img loading=lazy src=./images/soc-kibana.png alt></p><p>好了，如果服务一切正常的话，你可以开始打工人生活了:)</p><h2 id=参考链接>参考链接<a hidden class=anchor aria-hidden=true href=#参考链接>#</a></h2><ul><li><a href=https://docs.securityonion.net/en/2.3/about.html>https://docs.securityonion.net/en/2.3/about.html</a></li></ul></div><footer class=post-footer><ul class=post-tags><li><a href=https://www.keepwn.com/tags/security-onion/>security-onion</a></li></ul><nav class=paginav><a class=next href=https://www.keepwn.com/posts/see-you-again/><span class=title>下一页 »</span><br><span>焕新颜，重相见</span></a></nav></footer><section class=comments><style>.utterances{max-width:100%}</style><script src=https://utteranc.es/client.js repo=keepwn/blog-comments issue-term=pathname theme=github-light crossorigin=anonymous async></script></section></article></main><footer class=footer><span>© 2014 - 2021 KEEPWN.COM</span>
<span>&#183;</span>
<span>Powered by <a href=https://gohugo.io/ rel="noopener noreferrer" target=_blank>Hugo</a></span>
<span>&#183;</span>
<span>Theme PaperMod & Custom</span></footer><div class=back-to-top><i class="fa fa-arrow-up"></i>
<span id=scrollpercent><span>0</span>%</span></div><script type=text/javascript src=//cdn.bootcdn.net/ajax/libs/jquery/2.1.4/jquery.min.js></script><script type=text/javascript>function getCntViewHeight(){var b=$('#content').height(),a=$(window).height(),c=b>a?b-a:$(document).height()-a;return c}function registerBackTop(){var b=50,a=$('.back-to-top');$(window).on('scroll',function(){var d,e,f,c,g;a.toggleClass('back-to-top-on',window.pageYOffset>b),d=$(window).scrollTop(),e=getCntViewHeight(),f=d/e,c=Math.round(f*100),g=c>100?100:c,$('#scrollpercent>span').html(g)}),a.on('click',function(){$("html,body").animate({scrollTop:0,screenLeft:0},800)})}registerBackTop()</script><script src=https://unpkg.com/scrollnav@3.0.1/dist/scrollnav.min.umd.js></script><script>const content=document.querySelector('.post-content');scrollnav.init(content,{debug:!1,easingStyle:'linear',sections:$('.post-content > h1').length>0?'h1':'h2',subSections:$('.post-content > h1').length>0?'h2':'h3'}),$(window).on('scroll',function(){$(".scroll-nav__sub-item.scroll-nav__item--active").parent().parent().addClass("scroll-nav__item--half-active");let a=$(".scroll-nav__item.scroll-nav__item--half-active");a.find(".scroll-nav__sub-item").length>0&&(a.find(".scroll-nav__sub-item").is(".scroll-nav__item--active")||a.removeClass("scroll-nav__item--half-active"))})</script><script defer src=/assets/js/highlight.min.7680afc38aa6b15ddf158a4f3780b7b1f7dde7e91d26f073e6229bb7a0793c92.js integrity="sha256-doCvw4qmsV3fFYpPN4C3sffd5+kdJvBz5iKbt6B5PJI=" onload=hljs.initHighlightingOnLoad()></script><script>window.onload=function(){localStorage.getItem("menu-scroll-position")&&(document.getElementById('menu').scrollLeft=localStorage.getItem("menu-scroll-position"))},document.querySelectorAll('a[href^="#"]').forEach(a=>{a.addEventListener("click",function(b){b.preventDefault();var a=this.getAttribute("href").substr(1);window.matchMedia('(prefers-reduced-motion: reduce)').matches?document.querySelector(`[id='${decodeURIComponent(a)}']`).scrollIntoView():document.querySelector(`[id='${decodeURIComponent(a)}']`).scrollIntoView({behavior:"smooth"}),a==="top"?history.replaceState(null,null," "):history.pushState(null,null,`#${a}`)})});function menu_on_scroll(){localStorage.setItem("menu-scroll-position",document.getElementById('menu').scrollLeft)}</script><script>document.getElementById("theme-toggle")?.addEventListener("click",()=>{document.body.className.includes("dark")?(document.body.classList.remove('dark'),localStorage.setItem("pref-theme",'light')):(document.body.classList.add('dark'),localStorage.setItem("pref-theme",'dark'))})</script></body></html>